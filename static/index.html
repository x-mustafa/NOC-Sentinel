<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<title>Tabadul NOC Sentinel</title>
<link rel="icon" type="image/png" href="logo.png">
<script src="vis-network.min.js"></script>
<script src="lucide.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#06090f; --surface:#0b1120; --surface2:#0f1929; --surface3:#131f36;
  --border:#182540; --border2:#1e2e4a;
  --text:#b8cce4; --muted:#3d5470; --bright:#fff;
  --cyan:#00d4ff; --green:#00e676; --yellow:#ffb300; --orange:#ff6d00;
  --red:#ff1744; --purple:#bb86fc;
  --sev5:#FF1744; --sev4:#FF6D00; --sev3:#FFB300; --sev2:#78909C; --sev1:#00B0FF; --sev0:#9E9E9E;
  --sidebar:224px;
  --radius:8px;
  --easing:cubic-bezier(0.4,0,0.2,1);
  --glass:rgba(11,17,32,0.82);
  --glow-cyan:0 0 18px rgba(0,212,255,0.22);
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Space Grotesk','Inter',sans-serif;height:100vh;display:flex;overflow:hidden;font-size:13px;line-height:1.5}
h1,h2,h3,h4{font-family:'Space Grotesk',sans-serif;letter-spacing:-0.3px}
.mono{font-family:'JetBrains Mono',monospace}
a{color:inherit;text-decoration:none}
button{font-family:'Space Grotesk','Inter',sans-serif;cursor:pointer}
input,select,textarea{font-family:'JetBrains Mono',monospace}

/* ── SCROLLBARS ── */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:#2a3f5e}
*{scrollbar-width:thin;scrollbar-color:var(--border2) transparent}

/* ── SIDEBAR ── */
#sidebar{
  width:var(--sidebar);
  background:linear-gradient(180deg, #0c1422 0%, #080e1a 100%);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;flex-shrink:0;z-index:10;
  transition:width 0.25s var(--easing);
}
.sidebar-logo{
  padding:16px 15px 13px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:11px;
  background:linear-gradient(135deg,rgba(0,212,255,0.04) 0%,transparent 60%);
}
.logo-icon{width:36px;height:36px;display:flex;align-items:center;justify-content:center;flex-shrink:0;
  background:rgba(0,212,255,0.08);border-radius:10px;border:1px solid rgba(0,212,255,0.15);}
.logo-icon img{width:26px;height:26px;object-fit:contain;filter:drop-shadow(0 0 6px rgba(0,212,255,0.4))}
.logo-text{font-size:13px;font-weight:700;color:#fff;letter-spacing:1.5px}
.logo-sub{font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace;letter-spacing:1.5px;margin-top:1px}

nav{flex:1;padding:8px 0;overflow:hidden}
.nav-item{
  display:flex;align-items:center;gap:11px;padding:10px 15px;
  cursor:pointer;transition:all 0.18s var(--easing);border-left:2px solid transparent;
  position:relative;white-space:nowrap;margin:1px 0;
}
.nav-item:hover{background:rgba(255,255,255,0.04);color:#dde8f8;border-left-color:rgba(0,212,255,0.25)}
.nav-item.active{
  background:linear-gradient(90deg,rgba(0,212,255,0.1) 0%,rgba(0,212,255,0.02) 100%);
  border-left-color:var(--cyan);color:var(--cyan);
}
.nav-item.active::after{
  content:'';position:absolute;left:0;top:6px;bottom:6px;width:2px;
  background:var(--cyan);border-radius:0 2px 2px 0;
  box-shadow:0 0 10px rgba(0,212,255,0.6),0 0 22px rgba(0,212,255,0.3);
}
.nav-icon{display:flex;align-items:center;justify-content:center;width:18px;flex-shrink:0}
.nav-icon svg{stroke:currentColor;width:15px;height:15px}
.nav-label{font-size:12px;font-weight:500;letter-spacing:0.2px}
.nav-badge{
  background:var(--red);color:#fff;font-size:10px;font-weight:700;
  padding:1px 6px;border-radius:10px;min-width:18px;text-align:center;
  font-family:'JetBrains Mono',monospace;margin-left:auto;
}
.nav-badge.hidden{display:none}

.sidebar-bottom{padding:10px 0;border-top:1px solid var(--border)}
.nav-item.logout{color:var(--muted)}
.nav-item.logout:hover{color:var(--red);background:rgba(255,23,68,0.05)}
a.nav-item{text-decoration:none;color:var(--text)}
.ext-section-hdr{font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.9px;padding:12px 16px 4px;display:flex;align-items:center;gap:6px}
.ext-section-hdr::before{content:'';flex:1;height:1px;background:var(--border)}
.nav-item.ext-grafana:hover{background:rgba(244,104,0,0.08);border-left-color:rgba(244,104,0,0.5);color:#f46800}
.nav-item.ext-zabbix:hover{background:rgba(204,0,0,0.08);border-left-color:rgba(204,0,0,0.5);color:#ff4444}
.ext-out-icon{width:10px;height:10px;margin-left:auto;flex-shrink:0;opacity:0.4}

/* ── MAIN ── */
#main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}

/* ── TOPBAR ── */
#topbar{
  background:rgba(10,15,26,0.96);
  border-bottom:1px solid var(--border);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  padding:0 18px;height:50px;display:flex;align-items:center;gap:14px;flex-shrink:0;
  position:relative;z-index:9;
}
.topbar-title{font-size:14px;font-weight:700;color:#e8f0ff;flex:1;letter-spacing:0.3px}
.stat-chip{
  display:flex;align-items:center;gap:5px;padding:4px 10px;
  border-radius:6px;border:1px solid var(--border2);
  font-size:10px;font-family:'JetBrains Mono',monospace;
  background:rgba(255,255,255,0.025);
  transition:border-color 0.18s;
}
.stat-chip:hover{border-color:rgba(0,212,255,0.25)}
.stat-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.stat-num{color:#e8f0ff;font-weight:700;font-size:11px}
.stat-lbl{color:var(--muted);font-size:10px}
.refresh-info{font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace;white-space:nowrap}
.live-pill{
  display:flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;
  background:rgba(0,230,118,0.08);border:1px solid rgba(0,230,118,0.25);
  font-size:9px;font-weight:700;color:var(--green);font-family:'JetBrains Mono',monospace;letter-spacing:0.5px;
}
.live-dot{width:5px;height:5px;border-radius:50%;background:var(--green);animation:pulse 1.8s infinite;box-shadow:0 0 6px var(--green)}

/* ── PAGES ── */
.page{flex:1;display:none;flex-direction:column;overflow:hidden}
.page.active{display:flex}

/* ── MAP PAGE ── */
#page-map{position:relative}
#map-toolbar{
  background:rgba(9,14,24,0.95);border-bottom:1px solid var(--border);
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  padding:5px 14px;display:flex;align-items:center;gap:7px;flex-shrink:0;flex-wrap:wrap;
}
.tb-btn{
  background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:6px;
  padding:4px 10px;color:var(--muted);font-size:10px;font-family:'JetBrains Mono',monospace;
  transition:all 0.15s var(--easing);cursor:pointer;white-space:nowrap;
}
.tb-btn:hover{border-color:rgba(0,212,255,0.45);color:var(--cyan);background:rgba(0,212,255,0.06)}
.tb-btn.active{background:rgba(0,212,255,0.12);border-color:var(--cyan);color:var(--cyan);box-shadow:0 0 8px rgba(0,212,255,0.18)}
.tb-btn.add{border-color:rgba(0,230,118,0.35);color:var(--green);background:rgba(0,230,118,0.05)}
.tb-btn.add:hover{background:rgba(0,230,118,0.12);border-color:rgba(0,230,118,0.6)}
.tb-sep{width:1px;height:16px;background:var(--border);margin:0 2px;flex-shrink:0}
.tb-search{
  display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.03);
  border:1px solid var(--border);border-radius:6px;padding:3px 8px;
  transition:border-color 0.15s;
}
.tb-search:focus-within{border-color:rgba(0,212,255,0.4)}
.tb-search input{background:none;border:none;outline:none;color:#dde8f8;font-size:10px;width:120px;font-family:'JetBrains Mono',monospace}
.tb-search input::placeholder{color:var(--muted)}

#map-wrap{
  flex:1;position:relative;overflow:hidden;
  background:
    linear-gradient(rgba(24,37,64,0.25) 1px,transparent 1px),
    linear-gradient(90deg,rgba(24,37,64,0.25) 1px,transparent 1px);
  background-size:44px 44px;
}
#vis-network{width:100%;height:100%;background:transparent!important}

/* ── MAP LAYER RAIL ── */
#layer-rail{
  height:28px;background:rgba(9,14,22,0.9);border-bottom:1px solid var(--border);
  display:flex;align-items:stretch;flex-shrink:0;
}
.lr-cell{
  flex:1;font-size:8px;font-family:'JetBrains Mono',monospace;text-transform:uppercase;
  letter-spacing:0.6px;color:var(--muted);display:flex;align-items:center;justify-content:center;
  border-top:2px solid transparent;border-right:1px solid var(--border);white-space:nowrap;padding:0 4px;
  transition:color 0.15s;
}
.lr-cell:last-child{border-right:none}
.lr-ext{border-top-color:#f1c40f;color:#f1c40faa}
.lr-wan{border-top-color:#3498db88}
.lr-inet,.lr-core{border-top-color:#3498db;color:#90caf9aa}
.lr-fw,.lr-fp{border-top-color:#e74c3c;color:#ef9a9aaa}
.lr-tor{border-top-color:#3498db;color:#90caf9aa}
.lr-app{border-top-color:#e67e22;color:#ffb74daa}
.lr-srv{border-top-color:#2ecc71;color:#a5d6a7aa}
.lr-hsm{border-top-color:#9b59b6;color:#ce93d8aa}

/* ── DETAIL PANEL ── */
#detail-panel{
  position:absolute;top:0;right:0;bottom:0;width:300px;
  background:rgba(9,14,26,0.97);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border-left:1px solid var(--border);
  display:flex;flex-direction:column;
  transform:translateX(100%);transition:transform 0.26s var(--easing);z-index:5;
}
#detail-panel.open{transform:translateX(0)}
.dp-header{
  padding:14px 15px 11px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0;
  background:linear-gradient(135deg,rgba(0,212,255,0.06) 0%,transparent 80%);
}
.dp-title{font-size:10px;font-weight:700;color:#e8f0ff;text-transform:uppercase;letter-spacing:1px}
.dp-close{background:rgba(255,255,255,0.06);border:1px solid var(--border);color:var(--muted);font-size:14px;line-height:1;padding:3px 7px;border-radius:5px;transition:all 0.15s}
.dp-close:hover{color:#fff;border-color:var(--border2);background:rgba(255,255,255,0.1)}
.dp-body{flex:1;overflow-y:auto;padding:13px 15px}
.dp-footer{padding:10px 15px;border-top:1px solid var(--border);display:flex;gap:8px}

/* ── ZOOM CONTROLS ── */
#zoom-ctrl{
  position:absolute;bottom:18px;right:18px;
  display:flex;flex-direction:column;gap:4px;z-index:4;
}
.z-btn{
  background:rgba(10,16,28,0.92);backdrop-filter:blur(8px);
  border:1px solid var(--border2);color:var(--text);
  width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:14px;
  transition:all 0.15s;display:flex;align-items:center;justify-content:center;
  font-weight:600;
}
.z-btn:hover{border-color:var(--cyan);color:var(--cyan);background:rgba(0,212,255,0.08);box-shadow:var(--glow-cyan)}

/* ── ALARM INDICATOR OVERLAY ── */
#alarm-overlay{position:absolute;inset:0;pointer-events:none;z-index:3;overflow:hidden}
.alarm-dot{
  position:absolute;width:14px;height:14px;border-radius:50%;
  margin:-7px 0 0 -7px;pointer-events:none;
  animation:alarmPulse 1.2s ease-in-out infinite;
}
@keyframes alarmPulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.8);opacity:0.4}}

/* ── INFO COMPONENTS ── */
.info-section{margin-bottom:14px}
.info-sec-title{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:6px}
.info-row{display:flex;justify-content:space-between;align-items:flex-start;padding:5px 0;border-bottom:1px solid rgba(24,37,64,0.7);gap:8px}
.info-row:last-child{border:none}
.info-key{font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;flex-shrink:0}
.info-val{font-size:10px;color:#e0eaff;font-family:'JetBrains Mono',monospace;text-align:right;word-break:break-all}
.iface-tag{display:inline-block;background:rgba(0,212,255,0.07);border:1px solid rgba(0,212,255,0.2);border-radius:4px;padding:1px 6px;font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--cyan);margin:2px}
.sev-pill{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace}
.pill-ok   {background:rgba(0,230,118,0.1);color:var(--green);border:1px solid rgba(0,230,118,0.25)}
.pill-warn {background:rgba(255,179,0,0.1);color:var(--yellow);border:1px solid rgba(255,179,0,0.25)}
.pill-crit {background:rgba(255,23,68,0.1);color:var(--red);border:1px solid rgba(255,23,68,0.25)}
.pill-info {background:rgba(0,212,255,0.08);color:var(--cyan);border:1px solid rgba(0,212,255,0.25)}
.pill-down {background:rgba(255,23,68,0.18);color:var(--red);border:1px solid rgba(255,23,68,0.4)}

/* ── EDIT FIELDS ── */
.ef{margin-bottom:10px}
.ef label{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:4px;display:block}
.ef input,.ef select,.ef textarea{
  width:100%;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:6px;
  padding:7px 10px;color:#e0eaff;font-size:11px;font-family:'JetBrains Mono',monospace;
  outline:none;transition:border-color 0.15s,background 0.15s;
}
.ef input:focus,.ef select:focus,.ef textarea:focus{border-color:rgba(0,212,255,0.5);background:rgba(0,212,255,0.04)}
.ef textarea{resize:vertical;min-height:56px}
.ef select option{background:var(--surface2)}
.ef-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* ── PAGE HEADER ── */
.page-header{
  background:rgba(10,15,26,0.9);border-bottom:1px solid var(--border);
  backdrop-filter:blur(10px);
  padding:12px 18px;display:flex;align-items:center;gap:12px;flex-shrink:0;flex-wrap:wrap;
}
.page-title{font-size:15px;font-weight:700;color:#e8f0ff;flex:1;letter-spacing:0.2px}

/* ── ALARMS PAGE ── */
#page-alarms{flex-direction:column}
.filter-btn{
  background:rgba(255,255,255,0.03);border:1px solid var(--border2);border-radius:6px;
  padding:4px 12px;color:var(--muted);font-size:10px;font-family:'JetBrains Mono',monospace;
  cursor:pointer;transition:all 0.15s;
}
.filter-btn:hover{border-color:rgba(0,212,255,0.45);color:var(--cyan);background:rgba(0,212,255,0.06)}
.filter-btn.active{background:rgba(0,212,255,0.1);border-color:var(--cyan);color:var(--cyan)}
.filter-btn.f-dis{border-color:rgba(255,23,68,0.3);color:var(--sev5)}
.filter-btn.f-high{border-color:rgba(255,109,0,0.3);color:var(--sev4)}
.filter-btn.f-avg{border-color:rgba(255,179,0,0.3);color:var(--sev3)}

.alarms-table-wrap{flex:1;overflow-y:auto}
table.alarms-tbl{width:100%;border-collapse:collapse}
.alarms-tbl th{
  position:sticky;top:0;background:#07091a;padding:9px 14px;
  text-align:left;font-size:9px;font-weight:700;text-transform:uppercase;
  letter-spacing:1px;color:var(--muted);font-family:'JetBrains Mono',monospace;
  border-bottom:1px solid var(--border);z-index:1;
}
.alarms-tbl td{padding:9px 14px;border-bottom:1px solid rgba(24,37,64,0.5);font-size:12px;vertical-align:middle}
.alarms-tbl tr:hover td{background:rgba(0,212,255,0.025)}
.sev-bar{width:4px;height:100%;border-radius:2px;min-height:34px;display:inline-block}
.sev-icon{font-size:14px;display:inline-block;width:20px;text-align:center}
.alarm-host{color:var(--cyan);font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600}
.alarm-name{color:var(--text);font-size:12px;line-height:1.4}
.duration{color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:10px}
.ack-btn{
  background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:5px;
  padding:3px 8px;color:var(--muted);font-size:10px;font-family:'JetBrains Mono',monospace;
  cursor:pointer;transition:all 0.15s;white-space:nowrap;
}
.ack-btn:hover{border-color:rgba(0,230,118,0.5);color:var(--green);background:rgba(0,230,118,0.06)}
.ack-btn.acked{color:var(--green);border-color:rgba(0,230,118,0.3);background:rgba(0,230,118,0.06)}
.empty-state{padding:60px;text-align:center;color:var(--muted);font-size:13px}

/* ── HOSTS PAGE ── */
#page-hosts{flex-direction:column}
.hosts-grid{flex:1;padding:16px 18px;overflow-y:auto;display:flex;flex-direction:column;gap:20px}
.host-group-header{display:flex;align-items:center;gap:10px;padding:5px 0 8px;border-bottom:1px solid var(--border);margin-bottom:10px}
.host-group-title{font-size:10px;font-weight:700;color:var(--cyan);font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:1px}
.host-group-meta{display:flex;align-items:center;gap:6px;margin-left:auto;font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace}
.host-group-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.host-card{
  background:linear-gradient(135deg,rgba(12,18,34,0.95) 0%,rgba(10,15,28,0.95) 100%);
  border:1px solid var(--border);border-radius:10px;
  padding:13px;cursor:pointer;transition:all 0.2s var(--easing);position:relative;overflow:hidden;
}
.host-card:hover{border-color:rgba(0,212,255,0.28);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.4),0 0 0 1px rgba(0,212,255,0.06)}
.host-card.has-problems{border-color:rgba(255,109,0,0.28)}
.host-card.has-disaster{border-color:rgba(255,23,68,0.5);box-shadow:0 0 16px rgba(255,23,68,0.15)}
.host-card.unavailable{border-color:rgba(255,23,68,0.3);opacity:0.8}
.hc-top-stripe{position:absolute;top:0;left:0;right:0;height:2px}
.hc-name{font-size:12px;font-weight:700;color:#e8f0ff;margin-bottom:3px;font-family:'JetBrains Mono',monospace;word-break:break-all}
.hc-ip{font-size:10px;color:rgba(0,212,255,0.7);font-family:'JetBrains Mono',monospace;margin-bottom:10px}
.hc-bottom{display:flex;align-items:center;justify-content:space-between}
.problem-badge{
  background:var(--red);color:#fff;font-size:9px;font-weight:700;
  padding:2px 8px;border-radius:12px;font-family:'JetBrains Mono',monospace;
}
.problem-badge.warn{background:var(--orange)}
.problem-badge.avg{background:var(--yellow);color:#000}

/* ── SETTINGS PAGE ── */
#page-settings{flex-direction:column;overflow-y:auto}
.settings-wrap{max-width:680px;padding:22px;display:flex;flex-direction:column;gap:20px}
.settings-card{
  background:rgba(11,17,32,0.9);border:1px solid var(--border);border-radius:12px;padding:20px;
  transition:border-color 0.2s;
}
.settings-card:hover{border-color:var(--border2)}
.settings-card h3{font-size:11px;font-weight:700;color:#e8f0ff;margin-bottom:16px;text-transform:uppercase;letter-spacing:1px;display:flex;align-items:center;gap:8px}
.layouts-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}

/* ── TOGGLE SWITCH ── */
.toggle-switch{position:relative;display:inline-block;width:36px;height:20px;flex-shrink:0}
.toggle-switch input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;cursor:pointer;inset:0;background:var(--surface3);border-radius:20px;transition:.3s;border:1px solid var(--border2)}
.toggle-slider:before{content:'';position:absolute;width:14px;height:14px;left:2px;bottom:2px;background:var(--muted);border-radius:50%;transition:.3s}
.toggle-switch input:checked+.toggle-slider{background:rgba(0,212,255,0.15);border-color:var(--cyan)}
.toggle-switch input:checked+.toggle-slider:before{transform:translateX(16px);background:var(--cyan)}

/* ── USER TABLE ── */
.user-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
.user-row:last-child{border-bottom:none}
.role-badge{font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;font-family:'JetBrains Mono',monospace;text-transform:uppercase}
.role-badge.admin{background:rgba(187,134,252,0.12);color:#bb86fc;border:1px solid rgba(187,134,252,0.25)}
.role-badge.operator{background:rgba(0,212,255,0.08);color:var(--cyan);border:1px solid rgba(0,212,255,0.25)}
.role-badge.viewer{background:rgba(61,84,112,0.2);color:var(--muted);border:1px solid var(--border)}
.map-alarm-row{display:flex;align-items:center;gap:10px;padding:8px 14px;border-bottom:1px solid rgba(24,37,64,0.5);cursor:pointer;transition:background 0.12s}
.map-alarm-row:hover{background:rgba(0,212,255,0.04)}
.layout-row{display:flex;align-items:center;gap:10px;padding:8px 12px;background:rgba(255,255,255,0.025);border-radius:7px;border:1px solid var(--border)}
.layout-name{flex:1;font-size:12px;font-family:'JetBrains Mono',monospace;color:#e0eaff}
.layout-date{font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace}

/* ── MODAL OVERLAY ── */
.modal-overlay{
  position:fixed;inset:0;z-index:200;
  background:rgba(6,9,15,0.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  display:none;align-items:center;justify-content:center;
}
.modal-overlay.open{display:flex}
.modal-card{
  background:rgba(11,17,32,0.98);border:1px solid var(--border2);border-radius:14px;
  padding:26px;width:440px;max-height:90vh;overflow-y:auto;
  box-shadow:0 24px 80px rgba(0,0,0,0.7),0 0 0 1px rgba(0,212,255,0.05);
}
.modal-card h3{font-size:15px;font-weight:700;color:#e8f0ff;margin-bottom:20px}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:20px}

/* ── BUTTONS ── */
.btn{padding:7px 15px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all 0.18s var(--easing);font-family:'Space Grotesk','Inter',sans-serif}
.btn-primary{background:linear-gradient(135deg,#0099ee 0%,#00d4ff 100%);color:#000;font-weight:700}
.btn-primary:hover{background:linear-gradient(135deg,#22aaff 0%,#33ddff 100%);box-shadow:0 0 18px rgba(0,212,255,0.35)}
.btn-success{background:linear-gradient(135deg,#00bb55 0%,#00e676 100%);color:#000;font-weight:700}
.btn-success:hover{filter:brightness(1.1);box-shadow:0 0 14px rgba(0,230,118,0.3)}
.btn-ghost{background:rgba(255,255,255,0.04);border:1px solid var(--border);color:var(--text)}
.btn-ghost:hover{border-color:rgba(0,212,255,0.4);color:var(--cyan);background:rgba(0,212,255,0.07)}
.btn-danger{background:rgba(255,23,68,0.1);border:1px solid rgba(255,23,68,0.25);color:#ff5252}
.btn-danger:hover{background:rgba(255,23,68,0.2);border-color:rgba(255,23,68,0.45)}

/* ── LOGIN OVERLAY ── */
#login-overlay{
  position:fixed;inset:0;z-index:9999;
  background:radial-gradient(ellipse at 50% 0%,rgba(0,100,180,0.12) 0%,rgba(6,9,15,0.98) 60%);
  backdrop-filter:blur(12px);
  display:flex;align-items:center;justify-content:center;
}
.login-card{
  background:rgba(11,17,32,0.98);border:1px solid var(--border2);border-radius:18px;
  padding:44px 40px;width:370px;text-align:center;
  box-shadow:0 32px 80px rgba(0,0,0,0.8),0 0 60px rgba(0,212,255,0.05);
}
.login-logo{width:80px;height:80px;margin:0 auto 22px;display:flex;align-items:center;justify-content:center;
  background:rgba(0,212,255,0.06);border-radius:20px;border:1px solid rgba(0,212,255,0.15);}
.login-logo img{width:54px;height:54px;object-fit:contain;filter:drop-shadow(0 0 20px rgba(0,212,255,0.4))}
.login-title{font-size:24px;font-weight:700;color:#fff;letter-spacing:3px;margin-bottom:4px}
.login-sub{font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:30px;text-transform:uppercase;letter-spacing:2.5px}
.login-form{display:flex;flex-direction:column;gap:12px}
.login-form input{
  background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:9px;
  padding:11px 14px;color:#e8f0ff;font-size:13px;outline:none;transition:all 0.15s;
  font-family:'Space Grotesk','Inter',sans-serif;
}
.login-form input:focus{border-color:rgba(0,212,255,0.5);background:rgba(0,212,255,0.04)}
.login-form input::placeholder{color:var(--muted)}
.login-err{color:var(--red);font-size:11px;font-family:'JetBrains Mono',monospace;min-height:14px}
.login-btn{
  background:linear-gradient(135deg,#0077ee 0%,#00d4ff 100%);border:none;border-radius:9px;
  padding:13px;color:#fff;font-size:13px;font-weight:700;cursor:pointer;
  letter-spacing:0.5px;transition:all 0.2s var(--easing);
  box-shadow:0 4px 20px rgba(0,120,255,0.25);
}
.login-btn:hover{filter:brightness(1.1);box-shadow:0 6px 28px rgba(0,150,255,0.4)}
.login-btn:active{transform:scale(0.98)}

/* ── TOOLTIP ── */
#vis-tip{
  position:fixed;background:rgba(9,14,28,0.97);border:1px solid var(--border2);
  border-radius:8px;padding:9px 13px;font-size:11px;pointer-events:none;
  backdrop-filter:blur(12px);z-index:50;display:none;max-width:240px;
  box-shadow:0 8px 28px rgba(0,0,0,0.5);
}
#vis-tip .t-name{font-weight:700;color:#e8f0ff;margin-bottom:3px;font-family:'Space Grotesk',sans-serif}
#vis-tip .t-ip{font-family:'JetBrains Mono',monospace;color:var(--cyan);font-size:10px}
#vis-tip .t-role{color:var(--muted);font-size:10px;margin-top:2px}
#vis-tip .t-alarm{color:var(--red);font-size:10px;margin-top:4px;font-weight:600}

/* ── LUCIDE ICONS ── */
.nav-icon svg{stroke:currentColor}

/* ── INTEL PAGE ── */
.intel-ctx-btn{background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:20px;padding:4px 12px;color:var(--muted);font-size:10px;font-family:'JetBrains Mono',monospace;cursor:pointer;display:inline-flex;align-items:center;gap:5px;white-space:nowrap;transition:all 0.15s;flex-shrink:0}
.intel-ctx-btn:hover{border-color:rgba(0,212,255,0.4);color:var(--cyan);background:rgba(0,212,255,0.06)}
.intel-ctx-btn.active{background:rgba(0,212,255,0.1);border-color:var(--cyan);color:var(--cyan)}
.ai-msg{display:flex;flex-direction:column;gap:3px;max-width:92%}
.ai-msg.user{align-self:flex-end}
.ai-msg.assistant{align-self:flex-start}
.ai-bubble{padding:10px 14px;border-radius:12px;font-size:12px;line-height:1.65;white-space:pre-wrap;word-break:break-word}
.ai-bubble.user{background:linear-gradient(135deg,#2563eb 0%,#4f46e5 100%);color:#fff;border-radius:12px 12px 3px 12px;box-shadow:0 4px 16px rgba(37,99,235,0.25)}
.ai-bubble.assistant{background:rgba(15,25,45,0.95);border:1px solid var(--border2);color:var(--text);border-radius:12px 12px 12px 3px}
.ai-bubble.thinking{color:var(--muted);font-style:italic;font-size:11px;background:transparent;border:none}
.ai-sender{font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace;padding:0 4px}
.ai-bubble.streaming::after{content:'▊';animation:cursor-blink 0.7s steps(1) infinite;color:var(--cyan);font-size:11px}
@keyframes cursor-blink{0%,100%{opacity:1}50%{opacity:0}}
.ai-badge{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,#4f46e5,#7c3aed);border-radius:5px;padding:2px 7px;font-size:9px;color:#fff;font-family:'JetBrains Mono',monospace;font-weight:600;margin-bottom:4px;letter-spacing:0.3px}

/* ── MAP LIST (sidebar) ── */
.map-section{padding:8px 0 4px;border-top:1px solid var(--border);margin-top:4px;flex-shrink:0}
.map-section-hdr{display:flex;align-items:center;justify-content:space-between;padding:0 13px 5px;font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--muted);text-transform:uppercase;letter-spacing:1.2px}
.map-import-btn{background:rgba(0,230,118,0.1);border:1px solid rgba(0,230,118,0.25);border-radius:4px;color:var(--green);font-size:9px;font-family:'JetBrains Mono',monospace;padding:2px 7px;cursor:pointer;transition:all 0.15s}
.map-import-btn:hover{background:rgba(0,230,118,0.2);border-color:rgba(0,230,118,0.5)}
.map-list-item{display:flex;align-items:center;gap:8px;padding:7px 13px;cursor:pointer;font-size:11px;color:var(--muted);transition:all 0.15s;border-left:2px solid transparent}
.map-list-item:hover{background:rgba(255,255,255,0.04);color:#b8cce4}
.map-list-item.active-map{border-left-color:var(--green);color:var(--green);background:rgba(0,230,118,0.05)}
.map-list-item .map-del{margin-left:auto;color:var(--muted);font-size:10px;padding:1px 4px;border-radius:3px;opacity:0;transition:opacity 0.15s}
.map-list-item:hover .map-del{opacity:1}
.map-list-item .map-del:hover{color:var(--red)}

/* ── IMPORT MODAL ── */
.import-steps{display:flex;gap:0;margin-bottom:20px}
.import-step{flex:1;text-align:center;font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--muted);padding:6px 4px;border-bottom:2px solid var(--border)}
.import-step.active{color:var(--cyan);border-bottom-color:var(--cyan)}
.import-step.done{color:var(--green);border-bottom-color:var(--green)}
.drop-zone{border:2px dashed var(--border2);border-radius:12px;padding:32px 20px;text-align:center;cursor:pointer;transition:all 0.2s;position:relative}
.drop-zone:hover,.drop-zone.drag-over{border-color:var(--cyan);background:rgba(0,212,255,0.04)}
.drop-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}
.drop-zone-icon{font-size:32px;margin-bottom:10px}
.drop-zone-lbl{font-size:12px;color:var(--muted)}
.drop-zone-lbl b{color:var(--cyan)}
.preview-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:12px;max-height:300px;overflow-y:auto;display:block}
.preview-table th{background:rgba(255,255,255,0.03);padding:6px 10px;text-align:left;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;position:sticky;top:0}
.preview-table td{padding:6px 10px;border-bottom:1px solid var(--border)}
.preview-table tr.matched td{color:#e0eaff}
.preview-table tr.unmatched td{color:var(--muted);text-decoration:line-through}
.match-pill{font-size:9px;padding:2px 6px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-weight:700}
.match-ok{background:rgba(0,230,118,0.12);color:var(--green)}
.match-no{background:rgba(255,23,68,0.1);color:var(--red)}
.import-summary{display:flex;gap:12px;margin:12px 0;font-size:11px;font-family:'JetBrains Mono',monospace}
.sum-chip{padding:4px 10px;border-radius:5px;border:1px solid var(--border)}

/* ── MISC ── */
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}
.badge-blink{animation:badgePulse 1s infinite}
@keyframes badgePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/* ── HOST REALITY MANAGEMENT ─────────────────────────────── */
#page-hreality{padding:24px;overflow-y:auto}
.hr-wrap{max-width:1200px}
.hr-header{display:flex;align-items:flex-start;gap:12px;margin-bottom:20px;flex-wrap:wrap}
.hr-table{width:100%;border-collapse:collapse;font-size:12px}
.hr-table thead th{background:rgba(255,255,255,0.035);color:var(--muted);font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;padding:10px 14px;border-bottom:1px solid var(--border);text-align:left}
.hr-table tbody tr{border-bottom:1px solid rgba(255,255,255,0.04);transition:background 0.15s}
.hr-table tbody tr:hover{background:rgba(0,212,255,0.03)}
.hr-node-id{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);margin-top:2px}
.hr-edit{background:transparent;border:1px solid transparent;border-radius:5px;padding:4px 8px;color:#e0eaff;font-family:'Space Grotesk',sans-serif;font-size:12px;width:100%;transition:all 0.15s;outline:none}
.hr-edit:hover{border-color:var(--border);background:rgba(255,255,255,0.03)}
.hr-edit:focus{border-color:rgba(0,212,255,0.4);background:rgba(0,212,255,0.05)}
.hr-map-badge{display:inline-flex;align-items:center;gap:4px;background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.2);border-radius:12px;padding:2px 8px;font-size:10px;color:var(--cyan);font-weight:500;white-space:nowrap}
.hr-zbx-name{font-size:9px;color:var(--green);font-family:'JetBrains Mono',monospace;margin-top:2px}
.hr-zbx-none{font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:2px}
.hr-save-btn{background:linear-gradient(135deg,#0096c7,#00b4d8);border:none;border-radius:5px;padding:5px 12px;color:#fff;font-size:10px;font-weight:600;cursor:pointer;transition:filter 0.15s;letter-spacing:0.3px}
.hr-save-btn:hover{filter:brightness(1.15)}
.hr-saved{color:var(--green);font-size:12px;font-weight:700}
.hr-search{background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:7px;padding:7px 12px;color:#e0eaff;font-family:'Space Grotesk',sans-serif;font-size:12px;outline:none;width:240px;transition:border-color 0.15s}
.hr-search:focus{border-color:rgba(0,212,255,0.4)}
.hr-filter-row td{padding:5px 14px 8px;border-bottom:1px solid var(--border2)}
.hr-filter-input{background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:5px;padding:4px 8px;color:#e0eaff;font-family:'Space Grotesk',sans-serif;font-size:11px;width:100%;outline:none;transition:border-color 0.15s;box-sizing:border-box}
.hr-filter-input:focus{border-color:rgba(0,212,255,0.35)}
.hr-filter-select{background:rgba(9,14,26,0.95);border:1px solid var(--border);border-radius:5px;padding:4px 8px;color:#e0eaff;font-family:'Space Grotesk',sans-serif;font-size:11px;width:100%;outline:none;cursor:pointer}
.hr-filter-select option{background:#0d1525}
.hr-missing-chip{display:inline-flex;align-items:center;gap:3px;margin-top:4px;padding:2px 8px;border-radius:10px;font-size:9px;font-weight:600;cursor:pointer;border:1px solid rgba(239,68,68,0.3);color:rgba(239,68,68,0.65);background:rgba(239,68,68,0.06);transition:all 0.15s;user-select:none;white-space:nowrap}
.hr-missing-chip:hover{background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.5);color:#ef4444}
.hr-missing-chip.active{background:rgba(239,68,68,0.2);border-color:#ef4444;color:#ef4444;box-shadow:0 0 8px rgba(239,68,68,0.2)}
.hr-edit.hr-missing-val{border-color:rgba(239,68,68,0.5)!important;background:rgba(239,68,68,0.07)!important}
.hr-warn-lbl{font-size:9px;color:#f87171;margin-top:2px;font-family:'JetBrains Mono',monospace}
.hr-table tbody tr.hr-issue{background:rgba(239,68,68,0.03)}
.hr-table tbody tr.hr-issue:hover{background:rgba(239,68,68,0.07)}

/* ── SPLASH SCREEN ─────────────────────────────────────────── */
#splash-screen{position:fixed;inset:0;z-index:99999;background:#020810;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;transition:opacity 0.65s cubic-bezier(0.4,0,0.2,1),transform 0.65s cubic-bezier(0.4,0,0.2,1)}
#splash-screen.done{opacity:0;transform:scale(1.03);pointer-events:none}
@keyframes splash-auto-hide{to{opacity:0;pointer-events:none;visibility:hidden}}
.spl-grid{position:absolute;inset:0;background:linear-gradient(rgba(0,212,255,0.035) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.035) 1px,transparent 1px);background-size:64px 64px;animation:spl-grid-in 1.2s ease forwards}
@keyframes spl-grid-in{0%{opacity:0}100%{opacity:1}}
.spl-radial{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:700px;height:700px;background:radial-gradient(circle,rgba(0,212,255,0.09) 0%,rgba(124,58,237,0.06) 35%,transparent 68%);animation:spl-pulse 3.5s ease-in-out infinite}
@keyframes spl-pulse{0%,100%{opacity:0.7;transform:translate(-50%,-50%) scale(1)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}}
.spl-scan{position:absolute;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent 0%,rgba(0,212,255,0.2) 20%,#00d4ff 50%,rgba(0,212,255,0.2) 80%,transparent 100%);box-shadow:0 0 18px 2px rgba(0,212,255,0.4);animation:spl-scan 2.8s cubic-bezier(0.4,0,0.2,1) infinite}
@keyframes spl-scan{0%{top:-2px;opacity:0}8%{opacity:1}92%{opacity:1}100%{top:100%;opacity:0}}
.spl-corner{position:absolute;width:22px;height:22px;border-color:rgba(0,212,255,0.35);border-style:solid;animation:spl-corner-in 0.6s ease forwards;opacity:0}
@keyframes spl-corner-in{0%{opacity:0;transform:scale(1.4)}100%{opacity:1;transform:scale(1)}}
.spl-content{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;animation:spl-rise 0.9s cubic-bezier(0.4,0,0.2,1) 0.15s forwards;opacity:0}
@keyframes spl-rise{0%{opacity:0;transform:translateY(24px)}100%{opacity:1;transform:translateY(0)}}
.spl-logo{width:380px;max-width:60vw;height:auto;object-fit:contain;filter:drop-shadow(0 0 44px rgba(0,212,255,0.5));animation:spl-glow 2.4s ease-in-out infinite;margin-bottom:0}
@keyframes spl-glow{0%,100%{filter:drop-shadow(0 0 20px rgba(0,212,255,0.4))}50%{filter:drop-shadow(0 0 44px rgba(0,212,255,0.85)) drop-shadow(0 0 80px rgba(124,58,237,0.3))}}
.spl-tabadul-wrap{position:relative;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;animation:tabadul-halo 3s ease-in-out infinite}
@keyframes tabadul-pulse{0%,100%{filter:brightness(1.1)}50%{filter:brightness(1.5)}}
.spl-title{font-family:'Space Grotesk',sans-serif;font-size:44px;font-weight:800;letter-spacing:7px;background:linear-gradient(135deg,#fff 0%,#a8d8ff 30%,#00d4ff 60%,#7c3aed 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;text-align:center}
.spl-tagline{font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:400;letter-spacing:2.5px;color:rgba(160,190,240,0.55);text-transform:uppercase;text-align:center;margin-bottom:52px}
.spl-bar-wrap{width:300px;height:2px;background:rgba(255,255,255,0.07);border-radius:2px;overflow:hidden;margin-bottom:18px}
.spl-bar{height:100%;width:0%;background:linear-gradient(90deg,#00d4ff,#7c3aed,#00d4ff);background-size:200% 100%;border-radius:2px;box-shadow:0 0 12px rgba(0,212,255,0.6);animation:spl-bar-fill 2.2s cubic-bezier(0.4,0,0.6,1) 0.3s forwards,spl-bar-shimmer 1.5s linear 0.3s infinite}
@keyframes spl-bar-fill{0%{width:0%}55%{width:80%}80%{width:90%}100%{width:100%}}
@keyframes spl-bar-shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.spl-status{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:1.5px;color:rgba(0,212,255,0.55)}
.spl-footer{position:absolute;bottom:32px;display:flex;align-items:center;gap:14px;animation:spl-grid-in 1s ease 0.5s forwards;opacity:0}
.spl-ftag{font-family:'JetBrains Mono',monospace;font-size:9px;color:rgba(255,255,255,0.2);letter-spacing:0.8px;text-transform:uppercase}
.spl-fdot{width:3px;height:3px;border-radius:50%;background:rgba(0,212,255,0.3);flex-shrink:0}

/* ── AI PROVIDERS SETTINGS ── */
.ai-provider-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.ai-provider-card{background:rgba(255,255,255,0.025);border:1px solid var(--border);border-radius:9px;padding:12px;display:flex;flex-direction:column;gap:8px;transition:border-color 0.2s}
.ai-provider-card:hover{border-color:var(--border2)}
.ai-provider-card.has-key{border-color:rgba(0,230,118,0.25);background:rgba(0,230,118,0.03)}
.aip-hdr{display:flex;align-items:center;gap:8px}
.aip-icon{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.aip-name{font-size:12px;font-weight:700;color:#e8f0ff}
.aip-badge{font-size:9px;font-weight:600;padding:2px 6px;border-radius:5px;margin-left:auto;font-family:'JetBrains Mono',monospace}
.aip-badge.set{background:rgba(0,230,118,0.12);color:#00e676;border:1px solid rgba(0,230,118,0.25)}
.aip-badge.unset{background:rgba(61,84,112,0.2);color:var(--muted);border:1px solid var(--border)}
.aip-input{background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:6px;padding:6px 10px;color:#e0eaff;font-size:11px;font-family:'JetBrains Mono',monospace;outline:none;width:100%;transition:border-color 0.15s}
.aip-input:focus{border-color:rgba(0,212,255,0.4)}
.aip-hint{font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace}
.aip-link{font-size:9px;color:var(--cyan);text-decoration:none}
.aip-link:hover{text-decoration:underline}
.ofc-model-sel{background:rgba(9,14,26,0.9);border:1px solid var(--border2);border-radius:6px;padding:5px 10px;color:#e0eaff;font-size:11px;font-family:'Space Grotesk',sans-serif;outline:none;cursor:pointer}

/* ══════════════════════════════════════════════════════════
   AI EMPLOYEES OFFICE
══════════════════════════════════════════════════════════ */
#page-office{flex-direction:column;overflow:hidden;background:var(--bg)}

/* Office header */
.office-hdr{
  display:flex;align-items:center;gap:14px;padding:10px 18px;
  background:linear-gradient(135deg,rgba(0,10,28,0.98) 0%,rgba(10,16,32,0.98) 100%);
  border-bottom:1px solid var(--border2);flex-shrink:0;flex-wrap:nowrap;
  position:relative;overflow:hidden;
}
.office-hdr::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse 60% 120% at 10% 50%,rgba(0,212,255,0.04) 0%,transparent 70%);
  pointer-events:none;
}
.office-title-blk{flex:1;min-width:0}
.office-title{font-size:18px;font-weight:700;color:#fff;letter-spacing:0.5px;line-height:1.1}
.office-subtitle{font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;letter-spacing:1px;margin-top:2px}

.office-stats{display:flex;gap:6px;flex-wrap:wrap}
.ofc-stat{
  display:flex;flex-direction:column;align-items:center;padding:7px 14px;
  background:rgba(255,255,255,0.025);border:1px solid var(--border2);border-radius:8px;
  min-width:72px;transition:border-color 0.2s;
}
.ofc-stat:hover{border-color:rgba(0,212,255,0.2)}
.ofc-stat-val{font-size:18px;font-weight:700;color:#e8f0ff;font-family:'JetBrains Mono',monospace;line-height:1}
.ofc-stat-lbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.6px;margin-top:3px;white-space:nowrap}

.office-actions{display:flex;gap:8px;flex-wrap:wrap}
.ofc-btn{
  padding:8px 16px;border-radius:8px;font-size:11px;font-weight:600;
  border:1px solid;cursor:pointer;transition:all 0.18s;letter-spacing:0.3px;
  font-family:'Space Grotesk',sans-serif;white-space:nowrap;
}
.ofc-btn-brief{
  background:linear-gradient(135deg,rgba(255,179,0,0.15),rgba(255,109,0,0.1));
  border-color:rgba(255,179,0,0.4);color:#ffb300;
}
.ofc-btn-brief:hover{background:linear-gradient(135deg,rgba(255,179,0,0.25),rgba(255,109,0,0.18));border-color:#ffb300;box-shadow:0 0 16px rgba(255,179,0,0.2)}
.ofc-btn-assign{
  background:rgba(0,212,255,0.08);border-color:rgba(0,212,255,0.3);color:var(--cyan);
}
.ofc-btn-assign:hover{background:rgba(0,212,255,0.15);border-color:var(--cyan);box-shadow:0 0 14px rgba(0,212,255,0.18)}
.ofc-btn-autocollab{
  background:rgba(120,100,200,0.08);border-color:rgba(120,100,200,0.3);color:#a88eee;
}
.ofc-btn-autocollab:hover{background:rgba(120,100,200,0.15);border-color:#a88eee;box-shadow:0 0 14px rgba(120,100,200,0.2)}
.ofc-btn-autocollab.active{background:rgba(120,100,200,0.22);border-color:#a88eee;color:#c8b4ff;box-shadow:0 0 16px rgba(120,100,200,0.3)}

/* ── Vault ── */
.vault-layout{display:flex;flex-direction:column;flex:1;overflow:hidden;padding:0}
.vault-toolbar{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;padding:14px 20px;border-bottom:1px solid var(--border);flex-shrink:0}
.vault-cats{display:flex;gap:6px;padding:10px 20px 0;flex-wrap:wrap;flex-shrink:0}
.vault-cat-btn{padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;border:1px solid var(--border);background:rgba(255,255,255,0.03);color:var(--muted);cursor:pointer;transition:all 0.15s}
.vault-cat-btn.active{background:rgba(168,142,238,0.15);border-color:rgba(168,142,238,0.4);color:#c8b4ff}
.vault-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;padding:14px 20px;overflow-y:auto;flex:1;align-content:start}
.vault-card{background:rgba(11,17,34,0.85);border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;flex-direction:column;gap:6px;transition:border-color 0.2s}
.vault-card:hover{border-color:rgba(168,142,238,0.35)}
.vault-card-top{display:flex;align-items:center;gap:8px}
.vault-card-name{font-size:12px;font-weight:700;color:var(--text);flex:1}
.vault-cat-badge{font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;background:rgba(168,142,238,0.12);color:#c8b4ff;border:1px solid rgba(168,142,238,0.25);white-space:nowrap}
.vault-val-row{display:flex;align-items:center;gap:6px}
.vault-val{font-size:11px;font-family:'JetBrains Mono',monospace;color:#7de0a0;flex:1;word-break:break-all}
.vault-notes{font-size:10px;color:var(--muted);line-height:1.4}
.vault-footer{display:flex;align-items:center;gap:6px;margin-top:4px}
.vault-ai-badge{font-size:9px;padding:2px 7px;border-radius:10px}
.vault-ai-badge.on{background:rgba(74,222,128,0.1);color:#4ade80;border:1px solid rgba(74,222,128,0.2)}
.vault-ai-badge.off{background:rgba(100,100,130,0.1);color:var(--muted);border:1px solid var(--border)}
.vault-btn{padding:3px 9px;border-radius:5px;font-size:10px;font-weight:600;border:1px solid;cursor:pointer;transition:all 0.15s}
.vault-btn.edit{background:rgba(0,212,255,0.06);border-color:rgba(0,212,255,0.25);color:var(--cyan)}
.vault-btn.del{background:rgba(239,68,68,0.06);border-color:rgba(239,68,68,0.25);color:#f87171}
.vault-btn:hover{opacity:0.85;transform:translateY(-1px)}
.vault-show-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:12px;padding:0 4px}

/* ── WhatsApp card ── */
.wa-card{background:rgba(11,17,34,0.85);border:1px solid var(--border);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:12px;transition:border-color 0.2s}
.wa-card:hover{border-color:rgba(37,211,102,0.25)}
.wa-card-top{display:flex;align-items:center;gap:10px}
.wa-emp-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;transition:background 0.3s}
.wa-emp-dot.connected{background:#25d366;box-shadow:0 0 8px rgba(37,211,102,0.5)}
.wa-emp-dot.qr{background:#ffb300;box-shadow:0 0 8px rgba(255,179,0,0.5)}
.wa-emp-dot.connecting{background:#7aafd4;animation:pulse 1.5s infinite}
.wa-emp-dot.disconnected{background:#555}
.wa-emp-name{font-size:13px;font-weight:700;flex:1}
.wa-status-badge{font-size:9px;font-weight:700;padding:2px 8px;border-radius:8px;text-transform:uppercase;letter-spacing:0.5px}
.wa-status-badge.connected{background:rgba(37,211,102,0.12);color:#25d366;border:1px solid rgba(37,211,102,0.25)}
.wa-status-badge.qr{background:rgba(255,179,0,0.12);color:#ffb300;border:1px solid rgba(255,179,0,0.25)}
.wa-status-badge.connecting{background:rgba(122,175,212,0.12);color:#7aafd4;border:1px solid rgba(122,175,212,0.25)}
.wa-status-badge.disconnected{background:rgba(100,100,130,0.12);color:var(--muted);border:1px solid var(--border)}
.wa-phone{font-size:11px;font-family:'JetBrains Mono',monospace;color:#4ade80;margin-top:2px}
.wa-qr-wrap{display:flex;flex-direction:column;align-items:center;gap:8px;padding:12px;background:rgba(0,0,0,0.25);border-radius:8px;border:1px solid rgba(255,179,0,0.2)}
.wa-qr-wrap img{width:160px;height:160px;border-radius:4px;background:#fff}
.wa-qr-hint{font-size:10px;color:#ffb300;text-align:center;line-height:1.4}
.wa-msg-row{display:flex;flex-direction:column;gap:4px;max-height:80px;overflow-y:auto}
.wa-msg-item{font-size:10px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.wa-msg-item b{color:var(--text)}
.wa-btn-row{display:flex;gap:6px;margin-top:4px}
.wa-btn{padding:4px 10px;border-radius:5px;font-size:10px;font-weight:600;border:1px solid;cursor:pointer;transition:all 0.15s}
.wa-btn.logout{background:rgba(239,68,68,0.06);border-color:rgba(239,68,68,0.25);color:#f87171}
.wa-btn.logout:hover{background:rgba(239,68,68,0.15)}
.wa-btn.reconnect{background:rgba(0,212,255,0.06);border-color:rgba(0,212,255,0.25);color:var(--cyan)}
.wa-btn.reconnect:hover{background:rgba(0,212,255,0.14)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

/* ── Workflow builder cards ── */
.wf-step-label{font-size:10px;font-weight:700;letter-spacing:0.8px;color:var(--muted);text-transform:uppercase;margin:14px 0 8px}
.wf-trigger-cards,.wf-emp-cards,.wf-action-cards{display:grid;gap:8px}
.wf-trigger-cards{grid-template-columns:repeat(3,1fr)}
.wf-action-cards{grid-template-columns:repeat(4,1fr)}
.wf-emp-cards{grid-template-columns:repeat(4,1fr)}
.wf-tc,.wf-ec,.wf-ac{
  padding:10px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,0.02);
  cursor:pointer;text-align:center;transition:all 0.15s;user-select:none;
}
.wf-tc:hover,.wf-ec:hover,.wf-ac:hover{border-color:rgba(0,212,255,0.3);background:rgba(0,212,255,0.04)}
.wf-tc.active,.wf-ec.active,.wf-ac.active{border-color:var(--cyan);background:rgba(0,212,255,0.08);box-shadow:0 0 12px rgba(0,212,255,0.1)}
.wf-tc-icon,.wf-ac-icon{font-size:18px;margin-bottom:3px}
.wf-tc-title,.wf-ac-title{font-size:11px;font-weight:700;color:var(--text)}
.wf-tc-desc,.wf-ac-desc{font-size:9px;color:var(--muted);margin-top:2px}
.wf-prompt-templates{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:2px}
.wf-tpl-btn{padding:3px 9px;border-radius:14px;border:1px solid rgba(0,212,255,0.2);background:rgba(0,212,255,0.05);color:var(--cyan);font-size:10px;cursor:pointer;transition:all 0.15s}
.wf-tpl-btn:hover{background:rgba(0,212,255,0.12);border-color:var(--cyan)}

/* Toggle switch */
.wf-toggle-wrap{position:relative;display:inline-flex;align-items:center;cursor:pointer}
.wf-toggle-wrap input{opacity:0;width:0;height:0;position:absolute}
.wf-toggle{display:block;width:34px;height:18px;background:rgba(255,255,255,0.1);border-radius:9px;border:1px solid var(--border);transition:all 0.2s;position:relative}
.wf-toggle::after{content:'';position:absolute;left:2px;top:2px;width:12px;height:12px;border-radius:50%;background:#888;transition:all 0.2s}
.wf-toggle-wrap input:checked~.wf-toggle{background:rgba(0,212,255,0.25);border-color:var(--cyan)}
.wf-toggle-wrap input:checked~.wf-toggle::after{transform:translateX(16px);background:var(--cyan)}

/* Office body */
.office-body{
  flex:1;display:flex;gap:0;overflow:hidden;
  padding-bottom:46px; /* clear the fixed Map Alarms panel */
}

/* Employee grid */
.office-grid{
  flex:1;display:grid;
  grid-template-columns:repeat(2,1fr);
  grid-template-rows:repeat(2,1fr);
  gap:1px;background:var(--border);overflow:hidden;
}

/* Employee card */
.emp-card{
  position:relative;background:var(--surface);
  display:flex;flex-direction:column;overflow:hidden;
  transition:background 0.3s;
  --emp-color:#00d4ff;
}
.emp-card::after{
  content:'';position:absolute;inset:0;pointer-events:none;
  border:1px solid transparent;border-radius:0;
  transition:border-color 0.3s;
}
.emp-card-active{background:rgba(11,17,32,0.97)}
.emp-card-active::after{border-color:var(--emp-color)!important;box-shadow:inset 0 0 30px rgba(0,0,0,0.3)}

/* Card animated glow strip at top */
.emp-card-glow{
  height:2px;background:linear-gradient(90deg,transparent 0%,var(--emp-color) 50%,transparent 100%);
  opacity:0.4;transition:opacity 0.3s;flex-shrink:0;
}
.emp-card-active .emp-card-glow{opacity:1;animation:emp-glow-sweep 2s ease-in-out infinite}
@keyframes emp-glow-sweep{
  0%,100%{background-position:0% 0}
  50%{background-position:100% 0}
}

/* Card header */
.emp-header{
  display:flex;align-items:center;gap:10px;padding:10px 14px 8px;
  flex-shrink:0;
}
.emp-avatar-wrap{position:relative;flex-shrink:0}
.emp-avatar{
  width:44px;height:44px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.08);
  overflow:hidden;
}
.emp-avatar svg{width:36px;height:36px}
.emp-card-active .emp-avatar{animation:emp-avatar-breathe 2.4s ease-in-out infinite}
@keyframes emp-avatar-breathe{
  0%,100%{box-shadow:0 0 0 0 rgba(0,0,0,0)}
  50%{box-shadow:0 0 0 6px rgba(var(--emp-color-rgb,.5),0.15)}
}
.emp-status-dot{
  position:absolute;bottom:2px;right:2px;
  width:10px;height:10px;border-radius:50%;border:2px solid var(--surface);
  transition:background 0.3s;
}
.emp-status-dot.idle{background:#3d5470}
.emp-status-dot.working{background:#ffb300;animation:emp-dot-pulse 1.2s ease-in-out infinite}
.emp-status-dot.done{background:#4ade80}
@keyframes emp-dot-pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(0.85)}}

.emp-info{flex:1;min-width:0}
.emp-name{font-size:14px;font-weight:700;letter-spacing:0.8px;line-height:1.1}
.emp-role{font-size:10px;color:var(--muted);letter-spacing:0.3px;margin-top:1px}

.emp-tag{
  font-size:9px;font-weight:700;letter-spacing:1.2px;padding:3px 8px;
  border-radius:12px;border:1px solid;font-family:'JetBrains Mono',monospace;
  flex-shrink:0;
}
.emp-tag.idle{color:#3d5470;border-color:#1e2e4a;background:rgba(255,255,255,0.02)}
.emp-tag.working{color:#ffb300;border-color:rgba(255,179,0,0.4);background:rgba(255,179,0,0.08);animation:emp-tag-blink 1.5s ease infinite}
.emp-tag.done{color:#4ade80;border-color:rgba(74,222,128,0.35);background:rgba(74,222,128,0.06)}
@keyframes emp-tag-blink{0%,100%{opacity:1}50%{opacity:0.6}}

/* Task bar */
.emp-task-bar{
  padding:3px 14px 6px;border-bottom:1px solid rgba(255,255,255,0.04);
  flex-shrink:0;min-height:24px;
}
.emp-idle-text{
  font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;
  letter-spacing:0.3px;transition:opacity 0.3s;
}

/* Terminal */
.emp-terminal{
  flex:1;overflow-y:auto;padding:10px 12px;
  background:rgba(4,7,15,0.7);
  font-family:'JetBrains Mono',monospace;font-size:10.5px;line-height:1.6;
  color:#7aadcf;min-height:0;
}
.term-line{display:block;word-break:break-word}
.term-prompt{color:#3d5470}
.term-cursor{animation:term-blink 1s step-end infinite;color:var(--emp-color)}
@keyframes term-blink{0%,100%{opacity:1}50%{opacity:0}}
.term-dim{color:#2a3f5e}
.term-cmd{color:#e0eaff}
.term-output{
  white-space:pre-wrap;word-break:break-word;
  color:#8fbdd3;margin-top:4px;padding-top:4px;
  border-top:1px solid rgba(255,255,255,0.04);
}

/* Actions */
.emp-actions{
  display:flex;gap:5px;padding:8px 10px;
  border-top:1px solid rgba(255,255,255,0.08);
  background:rgba(0,0,0,0.25);
  flex-shrink:0;flex-wrap:wrap;
}
.emp-btn{
  padding:4px 11px;border-radius:5px;font-size:10px;font-weight:600;
  border:1px solid;cursor:pointer;transition:all 0.15s;
  background:rgba(255,255,255,0.04);
  border-color:rgba(255,255,255,0.14);
  color:#8eb8d8;font-family:'Space Grotesk',sans-serif;
  --btn-color:#00d4ff;letter-spacing:0.2px;
}
.emp-btn:hover{
  background:rgba(255,255,255,0.08);
  border-color:var(--btn-color);
  color:var(--btn-color);
  box-shadow:0 0 10px color-mix(in srgb,var(--btn-color) 25%,transparent);
  transform:translateY(-1px);
}
.emp-btn-stop{
  margin-left:auto;background:rgba(255,23,68,0.08);
  border-color:rgba(255,23,68,0.3);color:#ff1744;
}
.emp-btn-stop:hover{background:rgba(255,23,68,0.18);border-color:#ff1744}

/* Employee inline chat */
.emp-chat-row{
  display:flex;gap:5px;padding:7px 10px;
  background:rgba(0,0,0,0.3);border-top:1px solid rgba(255,255,255,0.06);
  flex-shrink:0;
}
.emp-chat-in{
  flex:1;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);
  border-radius:6px;padding:6px 10px;color:#e0eaff;font-size:11px;
  font-family:'Space Grotesk',sans-serif;outline:none;transition:border-color 0.15s;
}
.emp-chat-in:focus{border-color:var(--emp-color);background:rgba(255,255,255,0.07);box-shadow:0 0 8px color-mix(in srgb,var(--emp-color) 15%,transparent)}
.emp-chat-in::placeholder{color:rgba(160,185,215,0.35);font-style:italic}
.emp-chat-send{
  padding:5px 13px;border-radius:6px;font-size:14px;font-weight:700;border:1px solid;
  cursor:pointer;transition:all 0.15s;background:rgba(255,255,255,0.04);
  border-color:var(--emp-color);color:var(--emp-color);line-height:1;
}
.emp-chat-send:hover{background:rgba(255,255,255,0.1);transform:translateY(-1px)}
.emp-chat-clr{
  padding:5px 8px;border-radius:6px;font-size:12px;border:1px solid rgba(255,255,255,0.08);
  background:none;color:rgba(160,185,215,0.4);cursor:pointer;transition:all 0.15s;line-height:1;
}
.emp-chat-clr:hover{color:#f87171;border-color:rgba(248,113,113,0.3)}

/* Activity feed */
.office-feed{
  width:260px;flex-shrink:0;display:flex;flex-direction:column;
  background:rgba(8,12,22,0.95);border-left:1px solid var(--border);
  overflow:hidden;
}
.feed-hdr{
  padding:12px 14px 10px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:7px;flex-shrink:0;
  font-size:11px;font-weight:600;color:#c8d8f0;letter-spacing:0.3px;
}
.feed-list{flex:1;overflow-y:auto;padding:4px 0}
.feed-item{
  display:flex;align-items:flex-start;gap:8px;padding:7px 12px;
  border-bottom:1px solid rgba(255,255,255,0.03);
  transition:background 0.15s;
}
.feed-item:hover{background:rgba(255,255,255,0.025)}
.feed-icon{font-size:12px;flex-shrink:0;margin-top:1px;line-height:1}
.feed-content{flex:1;min-width:0}
.feed-text{font-size:10.5px;color:#8aa0c0;line-height:1.4;display:block;word-break:break-word}
.feed-time{font-size:9px;color:#2a3f5e;font-family:'JetBrains Mono',monospace;margin-top:2px;display:block}

/* ── Office Tabs ── */
.office-tab-bar{
  display:flex;align-items:stretch;gap:0;padding:0 10px;
  border-top:2px solid rgba(0,212,255,0.25);
  border-bottom:1px solid rgba(0,212,255,0.12);
  background:rgba(4,12,28,0.99);flex-shrink:0;min-height:44px;
}
.office-tab-bar .ofc-model-sel{margin:6px 3px;flex-shrink:0;align-self:center}
.tab-sep{width:1px;background:rgba(0,212,255,0.15);margin:8px 10px;flex-shrink:0;align-self:stretch}
.office-tab{
  padding:0 16px;font-size:12px;font-weight:700;background:none;border:none;
  color:#7aafd4;cursor:pointer;border-bottom:3px solid transparent;
  display:flex;align-items:center;gap:6px;transition:all 0.18s;
  white-space:nowrap;flex-shrink:0;letter-spacing:0.3px;text-transform:uppercase;
}
.office-tab:hover{color:#c8daf0;background:rgba(0,212,255,0.05)}
.office-tab.active{color:#00d4ff;border-bottom-color:#00d4ff;background:rgba(0,212,255,0.08);text-shadow:0 0 8px rgba(0,212,255,0.4)}
.office-tab-panel{flex:1;overflow:hidden;display:flex;flex-direction:column;min-height:0}

/* ── Team Chat ── */
.tc-layout{display:flex;flex:1;min-height:0;overflow:hidden}
.tc-sidebar{
  width:300px;flex-shrink:0;display:flex;flex-direction:column;gap:12px;
  padding:16px;overflow-y:auto;border-right:1px solid var(--border);
  background:rgba(6,10,20,0.7);
}
.tc-setup-card{
  background:rgba(11,17,34,0.9);border:1px solid var(--border);border-radius:10px;padding:16px;
}
.tc-setup-title{font-size:12px;font-weight:700;color:var(--cyan);margin-bottom:12px;letter-spacing:0.3px}
.tc-topic-input{
  width:100%;background:rgba(255,255,255,0.04);border:1px solid var(--border2);border-radius:7px;
  padding:8px 10px;color:var(--text);font-size:12px;font-family:'Space Grotesk',sans-serif;
  resize:vertical;outline:none;margin-bottom:12px;box-sizing:border-box;
}
.tc-topic-input:focus{border-color:rgba(0,212,255,0.4)}
.tc-setup-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:7px}
.tc-participants{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.tc-check-lbl{
  display:flex;align-items:center;gap:5px;font-size:11px;font-weight:600;cursor:pointer;
  padding:5px 10px;border-radius:6px;background:rgba(255,255,255,0.03);
  border:1px solid var(--border);color:var(--emp-clr,var(--muted));
  transition:background 0.15s;user-select:none;
}
.tc-check-lbl:hover{background:rgba(255,255,255,0.06)}
.tc-check-lbl input{accent-color:var(--emp-clr,var(--cyan));width:12px;height:12px}
.tc-setup-row{display:flex;gap:16px;align-items:flex-start;margin-bottom:12px}
.tc-start-btn{
  width:100%;padding:9px;background:linear-gradient(135deg,rgba(0,212,255,0.15),rgba(168,85,247,0.12));
  border:1px solid rgba(0,212,255,0.35);border-radius:8px;color:var(--cyan);
  font-size:12px;font-weight:700;cursor:pointer;letter-spacing:0.3px;transition:all 0.2s;
}
.tc-start-btn:hover:not(:disabled){background:linear-gradient(135deg,rgba(0,212,255,0.25),rgba(168,85,247,0.2));border-color:rgba(0,212,255,0.6)}
.tc-start-btn:disabled{opacity:0.5;cursor:not-allowed}
.tc-history-card{
  background:rgba(11,17,34,0.9);border:1px solid var(--border);border-radius:10px;padding:14px;flex:1;
}
.tc-history-title{font-size:11px;font-weight:700;color:var(--muted);margin-bottom:10px;letter-spacing:0.3px}
.tc-history-list{display:flex;flex-direction:column;gap:6px}
.tc-hist-item{
  padding:8px 10px;border-radius:7px;background:rgba(255,255,255,0.03);border:1px solid var(--border);
  cursor:pointer;transition:background 0.15s;
}
.tc-hist-item:hover{background:rgba(255,255,255,0.06)}
.tc-hist-topic{font-size:11px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tc-hist-meta{font-size:9px;color:var(--muted);margin-top:3px;font-family:'JetBrains Mono',monospace}
.tc-chat-area{
  flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px;
}
.tc-empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
.tc-turn{
  display:flex;flex-direction:column;gap:6px;animation:fadeInUp 0.3s ease;
}
.tc-turn-header{
  display:flex;align-items:center;gap:10px;padding:6px 14px;border-radius:8px 8px 0 0;
  background:rgba(255,255,255,0.04);border:1px solid var(--tc-clr,var(--border));border-bottom:none;
}
.tc-turn-name{font-size:11px;font-weight:700;color:var(--tc-clr,var(--text));letter-spacing:0.5px}
.tc-turn-round{font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-left:auto}
.tc-turn-body{
  background:rgba(8,14,28,0.95);border:1px solid var(--tc-clr,var(--border));border-radius:0 0 8px 8px;
  padding:14px 16px;font-size:12px;color:var(--text);line-height:1.7;white-space:pre-wrap;word-break:break-word;
}
.tc-typing{display:inline-flex;gap:3px;align-items:center;padding:2px 0}
.tc-typing span{width:4px;height:4px;border-radius:50%;background:var(--tc-clr,var(--cyan));animation:tc-bounce 1s infinite}
.tc-typing span:nth-child(2){animation-delay:0.15s}
.tc-typing span:nth-child(3){animation-delay:0.3s}
@keyframes tc-bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-5px)}}
@keyframes fadeInUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* ── Workflow Builder ── */
.wf-layout{display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden}
.wf-toolbar{
  display:flex;align-items:center;justify-content:space-between;padding:14px 18px;
  border-bottom:1px solid var(--border);flex-shrink:0;background:rgba(6,10,20,0.7);
}
.workflows-grid{
  flex:1;overflow-y:auto;padding:16px;display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;align-content:start;
}
.wf-card{
  background:rgba(11,17,34,0.9);border:1px solid var(--border);border-radius:10px;padding:16px;
  display:flex;flex-direction:column;gap:10px;transition:border-color 0.2s;
}
.wf-card:hover{border-color:rgba(0,212,255,0.25)}
.wf-card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:8px}
.wf-name{font-size:13px;font-weight:700;color:var(--text);line-height:1.3}
.wf-active-badge{
  padding:2px 8px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:0.5px;flex-shrink:0;
}
.wf-active-badge.active{background:rgba(74,222,128,0.12);color:#4ade80;border:1px solid rgba(74,222,128,0.3)}
.wf-active-badge.inactive{background:rgba(100,100,100,0.12);color:#666;border:1px solid rgba(100,100,100,0.2)}
.wf-meta{display:flex;gap:6px;flex-wrap:wrap}
.wf-badge{
  padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;
}
.wf-badge.alarm{background:rgba(239,68,68,0.12);color:#ef4444;border:1px solid rgba(239,68,68,0.25)}
.wf-badge.schedule{background:rgba(168,85,247,0.12);color:#a855f7;border:1px solid rgba(168,85,247,0.25)}
.wf-badge.manual{background:rgba(100,100,130,0.12);color:#8090b0;border:1px solid rgba(100,100,130,0.25)}
.wf-badge.threshold{background:rgba(251,191,36,0.12);color:#fbbf24;border:1px solid rgba(251,191,36,0.25)}
.wf-emp-badge{background:rgba(0,212,255,0.08);color:var(--cyan);border:1px solid rgba(0,212,255,0.2);padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700}
.wf-desc{font-size:11px;color:var(--muted);line-height:1.5}
.wf-prompt-preview{
  font-size:10px;font-family:'JetBrains Mono',monospace;color:#4d6680;
  background:rgba(0,0,0,0.3);border-radius:4px;padding:6px 8px;overflow:hidden;
  text-overflow:ellipsis;white-space:nowrap;
}
.wf-actions{display:flex;gap:6px;flex-wrap:wrap}
.wf-btn{
  padding:5px 10px;border-radius:5px;font-size:10px;font-weight:600;cursor:pointer;
  background:rgba(255,255,255,0.04);border:1px solid var(--border);color:var(--muted);transition:all 0.15s;
}
.wf-btn:hover{background:rgba(255,255,255,0.08);color:var(--text)}
.wf-btn.run{border-color:rgba(0,212,255,0.3);color:var(--cyan)}
.wf-btn.run:hover{background:rgba(0,212,255,0.1)}
.wf-btn.del{border-color:rgba(239,68,68,0.3);color:#ef4444}
.wf-btn.del:hover{background:rgba(239,68,68,0.08)}

/* Form elements shared */
.form-row{margin-bottom:13px}
.form-lbl{display:block;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:5px}
.form-inp{
  width:100%;background:rgba(255,255,255,0.04);border:1px solid var(--border2);border-radius:7px;
  padding:8px 10px;color:var(--text);font-size:12px;font-family:'Space Grotesk',sans-serif;
  outline:none;box-sizing:border-box;
}
.form-inp:focus{border-color:rgba(0,212,255,0.4)}
textarea.form-inp{resize:vertical}
select.form-inp option{background:#0d1628}

/* Assign task modal */
#assign-modal{
  position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.75);
  backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;
}
.assign-box{
  background:#0d1628;border:1px solid var(--border2);border-radius:14px;
  padding:24px;width:440px;max-width:90vw;
  box-shadow:0 20px 60px rgba(0,0,0,0.7),0 0 0 1px rgba(0,212,255,0.08);
}
.assign-title{font-size:14px;font-weight:700;color:#fff;margin-bottom:16px;letter-spacing:0.3px}
.assign-sel{
  width:100%;background:rgba(255,255,255,0.04);border:1px solid var(--border2);
  border-radius:7px;padding:8px 10px;color:#e0eaff;font-size:12px;
  font-family:'Space Grotesk',sans-serif;outline:none;margin-bottom:10px;
}
.assign-textarea{
  width:100%;background:rgba(255,255,255,0.04);border:1px solid var(--border2);
  border-radius:7px;padding:10px 12px;color:#e0eaff;font-size:12px;
  font-family:'JetBrains Mono',monospace;outline:none;resize:vertical;min-height:100px;
  transition:border-color 0.15s;margin-bottom:14px;
}
.assign-textarea:focus{border-color:rgba(0,212,255,0.4)}
.assign-btns{display:flex;gap:8px;justify-content:flex-end}
.assign-btn-cancel{background:rgba(255,255,255,0.04);border:1px solid var(--border);color:var(--muted);border-radius:7px;padding:7px 16px;font-size:11px;cursor:pointer;font-family:'Space Grotesk',sans-serif}
.assign-btn-cancel:hover{background:rgba(255,255,255,0.08);color:#dde8f8}
.assign-btn-run{background:linear-gradient(135deg,rgba(0,212,255,0.2),rgba(124,58,237,0.2));border:1px solid rgba(0,212,255,0.4);color:var(--cyan);border-radius:7px;padding:7px 18px;font-size:11px;font-weight:600;cursor:pointer;font-family:'Space Grotesk',sans-serif;transition:all 0.15s}
.assign-btn-run:hover{background:linear-gradient(135deg,rgba(0,212,255,0.3),rgba(124,58,237,0.3));box-shadow:0 0 14px rgba(0,212,255,0.2)}

/* ── EMPLOYEE FILE ATTACHMENTS ── */
.emp-files-bar{display:none;flex-wrap:wrap;gap:4px;padding:5px 10px 6px;border-bottom:1px solid rgba(255,255,255,0.04);flex-shrink:0;background:rgba(0,0,0,0.15)}
.emp-files-bar.has-files{display:flex}
.emp-file-chip{display:flex;align-items:center;gap:4px;padding:2px 6px 2px 7px;border-radius:5px;background:rgba(0,212,255,0.07);border:1px solid rgba(0,212,255,0.18);font-size:9.5px;font-family:'JetBrains Mono',monospace;color:#7aadcf;max-width:140px}
.emp-file-chip-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0}
.emp-file-chip-size{color:#3d5470;flex-shrink:0;font-size:9px;margin-left:2px}
.emp-file-chip-rm{cursor:pointer;color:#3d5470;font-size:11px;line-height:1;flex-shrink:0;margin-left:3px;transition:color 0.15s}
.emp-file-chip-rm:hover{color:#ff4444}
.attach-drop-zone{border:1.5px dashed var(--border2);border-radius:8px;padding:12px;text-align:center;cursor:pointer;transition:all 0.2s;margin-bottom:8px;background:rgba(255,255,255,0.015)}
.attach-drop-zone:hover,.attach-drop-zone.drag-over{border-color:rgba(0,212,255,0.45);background:rgba(0,212,255,0.04)}
.attach-drop-zone-txt{font-size:11px;color:var(--muted)}
.attach-drop-zone-txt span{color:var(--cyan)}
.assign-files-list{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;min-height:0}
</style>
</head>
<body>

<!-- ══ SPLASH SCREEN ══ -->
<div id="splash-screen" style="animation:splash-auto-hide 0.6s ease 5s forwards">
  <div class="spl-grid"></div>
  <div class="spl-radial"></div>
  <div class="spl-scan"></div>
  <span class="spl-corner" style="top:22px;left:22px;border-width:2px 0 0 2px;animation-delay:0.1s"></span>
  <span class="spl-corner" style="top:22px;right:22px;border-width:2px 2px 0 0;animation-delay:0.2s"></span>
  <span class="spl-corner" style="bottom:22px;left:22px;border-width:0 0 2px 2px;animation-delay:0.15s"></span>
  <span class="spl-corner" style="bottom:22px;right:22px;border-width:0 2px 2px 0;animation-delay:0.25s"></span>
  <div class="spl-content">
    <div style="display:flex;align-items:center;gap:32px;margin-bottom:24px;flex-wrap:wrap;justify-content:center">
      <img src="logo.png" alt="Tabadul" style="height:130px;width:auto;object-fit:contain;mix-blend-mode:screen;clip-path:inset(0 18px);animation:tabadul-pulse 3s ease-in-out infinite">
      <div style="width:1px;height:80px;background:linear-gradient(to bottom,transparent,rgba(0,212,255,0.5),transparent);flex-shrink:0"></div>
      <img src="b68b650a-ecfb-4f01-a119-9b8389b3d709.png" class="spl-logo" alt="NOC Sentinel" onerror="this.src='logo.png'" style="margin-bottom:0">
    </div>
    <div class="spl-tagline">Built for uptime. Engineered for certainty.</div>
    <div class="spl-bar-wrap"><div class="spl-bar"></div></div>
    <div class="spl-status" id="spl-status">INITIALIZING SYSTEMS...</div>
  </div>
  <div class="spl-footer">
    <div class="spl-ftag">Zabbix Integrated</div>
    <div class="spl-fdot"></div>
    <div class="spl-ftag">AI Powered</div>
    <div class="spl-fdot"></div>
    <div class="spl-ftag">Real-Time Monitoring</div>
    <div class="spl-fdot"></div>
    <div class="spl-ftag">Tabadul NOC</div>
  </div>
</div>

<!-- ══ LOGIN ══ -->
<div id="login-overlay">
  <div class="login-card">
    <div class="login-logo"><img src="logo.png" alt="Tabadul"></div>
    <div class="login-title">TABADUL</div>
    <div class="login-sub">NOC Command Center</div>
    <div class="login-form">
      <input id="l-user" type="text" placeholder="Username" autocomplete="username" />
      <input id="l-pass" type="password" placeholder="Password" autocomplete="current-password"
             onkeydown="if(event.key==='Enter') doLogin()" />
      <div id="l-err" class="login-err"></div>
      <button class="login-btn" onclick="doLogin()">Sign In →</button>
    </div>
  </div>
</div>

<!-- ══ SIDEBAR ══ -->
<div id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon"><img src="logo.png" alt="Tabadul"></div>
    <div>
      <div class="logo-text">TABADUL</div>
      <div class="logo-sub">NOC SENTINEL</div>
    </div>
  </div>
  <nav>
    <div class="nav-item active" data-page="map" onclick="navigate('map')">
      <span class="nav-icon"><i data-lucide="network" style="width:16px;height:16px"></i></span>
      <span class="nav-label">Network Map</span>
    </div>
    <div class="nav-item" data-page="alarms" onclick="navigate('alarms')">
      <span class="nav-icon"><i data-lucide="bell" style="width:16px;height:16px"></i></span>
      <span class="nav-label">Active Alarms</span>
      <span class="nav-badge hidden" id="alarm-badge">0</span>
    </div>
    <div class="nav-item" data-page="hosts" onclick="navigate('hosts')">
      <span class="nav-icon"><i data-lucide="server" style="width:16px;height:16px"></i></span>
      <span class="nav-label">Hosts</span>
    </div>
    <div class="nav-item" data-page="intel" onclick="navigate('intel')">
      <span class="nav-icon"><i data-lucide="brain-circuit" style="width:16px;height:16px"></i></span>
      <span class="nav-label">AI Intelligence</span>
    </div>
    <div class="nav-item" data-page="settings" onclick="navigate('settings')">
      <span class="nav-icon"><i data-lucide="settings-2" style="width:16px;height:16px"></i></span>
      <span class="nav-label">Settings</span>
    </div>
    <div class="nav-item" data-page="hreality" onclick="navigate('hreality')">
      <span class="nav-icon"><i data-lucide="table-2" style="width:16px;height:16px"></i></span>
      <span class="nav-label">Host Reality</span>
    </div>
    <div class="nav-item" data-page="office" onclick="navigate('office')" style="position:relative">
      <span class="nav-icon"><i data-lucide="users" style="width:16px;height:16px"></i></span>
      <span class="nav-label">AI Employees</span>
      <span style="font-size:8px;font-weight:700;padding:1px 5px;border-radius:6px;background:linear-gradient(135deg,rgba(0,212,255,0.2),rgba(167,139,250,0.2));border:1px solid rgba(0,212,255,0.25);color:var(--cyan);font-family:'JetBrains Mono',monospace;letter-spacing:0.5px;margin-left:auto">AI</span>
    </div>

    <!-- EXTERNAL DASHBOARDS -->
    <div class="ext-section-hdr">Dashboards</div>
    <a class="nav-item ext-grafana" href="https://grafana.tabadul.iq/dashboards" target="_blank" rel="noopener noreferrer">
      <span class="nav-icon">
        <img src="https://upload.wikimedia.org/wikipedia/commons/a/a1/Grafana_logo.svg" width="16" height="16" style="object-fit:contain;flex-shrink:0" alt="Grafana">
      </span>
      <span class="nav-label">Grafana Dashboards</span>
      <i data-lucide="external-link" class="ext-out-icon"></i>
    </a>
    <a class="nav-item ext-zabbix" href="https://zabbix.tabadul.iq/zabbix.php?action=dashboard.view&dashboardid=1&from=now-15m&to=now" target="_blank" rel="noopener noreferrer">
      <span class="nav-icon">
        <img src="https://images.icon-icons.com/2699/PNG/512/zabbix_logo_icon_167937.png" width="16" height="16" style="object-fit:contain;flex-shrink:0" alt="Zabbix">
      </span>
      <span class="nav-label">Zabbix Dashboard</span>
      <i data-lucide="external-link" class="ext-out-icon"></i>
    </a>

    <!-- MAP LIST -->
    <div class="map-section">
      <div class="map-section-hdr">
        <span>Maps</span>
        <button class="map-import-btn" onclick="openImportModal()">+ Import</button>
      </div>
      <div id="map-list">
        <div class="map-list-item active-map" data-mapid="0" onclick="switchMap(0,'Network Map')">
          <span>🗺️</span><span>Network Map</span>
        </div>
        <div class="map-list-item" data-mapid="-1" onclick="switchMap(-1,'POS MAP')">
          <span>🗺️</span><span>POS MAP</span>
        </div>
      </div>
    </div>
  </nav>
  <div class="sidebar-bottom">
    <div class="nav-item logout" onclick="doLogout()">
      <span class="nav-icon"><i data-lucide="log-out" style="width:15px;height:15px"></i></span>
      <span class="nav-label">Logout</span>
    </div>
    <div style="padding:10px 14px 8px;border-top:1px solid var(--border);margin-top:2px">
      <div style="font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace;line-height:1.7">
        Made with <span style="color:#e74c3c">&#9829;</span> by<br>
        <span style="color:var(--text);font-weight:600">Mustafa Raad</span><br>
        NOC &amp; Automation Team
      </div>
    </div>
  </div>
</div>

<!-- ══ MAIN ══ -->
<div id="main-area">

  <!-- TOP BAR -->
  <div id="topbar">
    <div class="topbar-title" id="page-title">Network Map</div>
    <div class="stat-chip"><div class="stat-dot" style="background:#3498db"></div><span class="stat-num" id="sc-total">—</span><span class="stat-lbl">hosts</span></div>
    <div class="stat-chip"><div class="stat-dot" style="background:var(--green)"></div><span class="stat-num" id="sc-ok">—</span><span class="stat-lbl">ok</span></div>
    <div class="stat-chip"><div class="stat-dot" style="background:var(--red)"></div><span class="stat-num" id="sc-prob">—</span><span class="stat-lbl">problems</span></div>
    <div class="stat-chip"><div class="stat-dot" style="background:var(--yellow)"></div><span class="stat-num" id="sc-alarms">—</span><span class="stat-lbl">alarms</span></div>
    <div class="refresh-info" id="refresh-info">Connecting...</div>
    <div class="live-pill"><div class="live-dot"></div>LIVE</div>
  </div>

  <!-- ══ MAP PAGE ══ -->
  <div class="page active" id="page-map">
    <!-- Layer rail -->
    <div id="layer-rail">
      <div class="lr-cell lr-ext">External</div>
      <div class="lr-cell lr-wan">WAN/ISP</div>
      <div class="lr-cell lr-inet">Internet SW</div>
      <div class="lr-cell lr-core">Core SW</div>
      <div class="lr-cell lr-fw">Payment FW</div>
      <div class="lr-cell lr-fp">IPS/Firepower</div>
      <div class="lr-cell lr-tor">NX-OS TOR</div>
      <div class="lr-cell lr-app">App FW / LB</div>
      <div class="lr-cell lr-srv">Servers</div>
      <div class="lr-cell lr-hsm">HSM/Infra</div>
    </div>
    <!-- Map toolbar -->
    <div id="map-toolbar">
      <span style="font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:1px">Layers:</span>
      <span id="layer-btns">
        <button class="tb-btn active" onclick="filterLayer('all',this)">ALL</button>
        <button class="tb-btn" onclick="filterLayer('external',this)">External</button>
        <button class="tb-btn" onclick="filterLayer('switching',this)">Switching</button>
        <button class="tb-btn" onclick="filterLayer('firewall',this)">Firewalls</button>
        <button class="tb-btn" onclick="filterLayer('loadbalancer',this)">LB/FW</button>
        <button class="tb-btn" onclick="filterLayer('servers',this)">Servers</button>
        <button class="tb-btn" onclick="filterLayer('hsm',this)">HSM</button>
      </span>
      <div class="tb-sep"></div>
      <div class="tb-search">
        <span style="color:var(--muted);font-size:11px">🔍</span>
        <input id="map-search" placeholder="Search..." oninput="searchNode(this.value)">
      </div>
      <div class="tb-sep"></div>
      <button class="tb-btn" onclick="visNetwork.fit()">⊞ Fit</button>
      <button class="tb-btn" id="tb-traffic" onclick="toggleTraffic()" title="Toggle Traffic Animation" style="display:flex;align-items:center;gap:4px">
        <i data-lucide="activity" style="width:12px;height:12px"></i> Traffic
      </button>
      <button class="tb-btn" onclick="saveLayoutPrompt()">💾 Save Layout</button>
      <button class="tb-btn" onclick="resetLayout()">↺ Reset</button>
      <button class="tb-btn" onclick="openDiscoverModal()" title="Auto-Discover from Zabbix" style="display:flex;align-items:center;gap:4px">
        <i data-lucide="radar" style="width:12px;height:12px"></i> Discover
      </button>
      <button class="tb-btn add" onclick="openAddModal()">＋ Add Node</button>
    </div>
    <!-- Canvas -->
    <div id="map-wrap">
      <div id="vis-network"></div>
      <canvas id="traffic-canvas" style="position:absolute;top:0;left:0;pointer-events:none;z-index:5;display:block"></canvas>
      <div id="alarm-overlay"></div>
      <div id="zoom-ctrl">
        <button class="z-btn" onclick="visNetwork.moveTo({scale:visNetwork.getScale()*1.3})">＋</button>
        <button class="z-btn" onclick="visNetwork.fit()">◎</button>
        <button class="z-btn" onclick="visNetwork.moveTo({scale:visNetwork.getScale()*0.77})">－</button>
      </div>
    </div>
    <!-- Detail panel -->
    <div id="detail-panel">
      <div class="dp-header">
        <span class="dp-title" id="dp-title">Device Details</span>
        <button class="dp-close" onclick="closePanel()">×</button>
      </div>
      <div class="dp-body" id="dp-body"></div>
      <div class="dp-footer" id="dp-footer" style="display:none"></div>
    </div>
  </div>

  <!-- ══ ALARMS PAGE ══ -->
  <div class="page" id="page-alarms">
    <div class="page-header">
      <div class="page-title">🔔 Active Alarms</div>
      <button class="filter-btn active" onclick="filterAlarms(-1,this)">All</button>
      <button class="filter-btn f-dis"  onclick="filterAlarms(5,this)">💀 Disaster</button>
      <button class="filter-btn f-high" onclick="filterAlarms(4,this)">🔴 High</button>
      <button class="filter-btn f-avg"  onclick="filterAlarms(3,this)">🟠 Average</button>
      <button class="filter-btn"       onclick="filterAlarms(2,this)">🟡 Warning</button>
      <button class="filter-btn"       onclick="filterAlarms(1,this)">🔵 Info</button>
      <div class="tb-sep"></div>
      <button class="filter-btn" onclick="filterAlarms('unack',this)">🔕 Unacknowledged</button>
      <button class="tb-btn" onclick="refreshAlarms()" style="margin-left:auto">↺ Refresh</button>
    </div>
    <div class="alarms-table-wrap">
      <table class="alarms-tbl">
        <thead>
          <tr>
            <th style="width:6px;padding:9px 4px"></th>
            <th>Severity</th>
            <th>Host</th>
            <th>Problem</th>
            <th>Duration</th>
            <th>Since</th>
            <th>Ack</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="alarms-tbody">
          <tr><td colspan="8" class="empty-state">Loading alarms...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ══ HOSTS PAGE ══ -->
  <div class="page" id="page-hosts">
    <div class="page-header">
      <div class="page-title">🖥️ Monitored Hosts</div>
      <div class="tb-search" style="width:200px">
        <span style="color:var(--muted);font-size:11px">🔍</span>
        <input id="host-search" placeholder="Search host..." oninput="filterHosts(this.value)" style="width:160px">
      </div>
      <button class="filter-btn active" id="hf-all"   onclick="hostFilter('all',this)">All</button>
      <button class="filter-btn"        id="hf-prob"  onclick="hostFilter('problems',this)">⚠ Problems</button>
      <button class="filter-btn"        id="hf-ok"    onclick="hostFilter('ok',this)">✓ OK</button>
      <button class="filter-btn"        id="hf-down"  onclick="hostFilter('down',this)">✗ Down</button>
    </div>
    <div class="hosts-grid" id="hosts-grid">
      <div class="empty-state" style="grid-column:1/-1">Loading hosts...</div>
    </div>
  </div>

  <!-- ══ AI INTELLIGENCE PAGE ══ -->
  <div class="page" id="page-intel">
    <div class="page-header">
      <div class="page-title"><i data-lucide="brain-circuit" style="width:16px;height:16px;vertical-align:-2px"></i> Network Intelligence</div>
      <div style="font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace" id="intel-context-label">General Network Assistant</div>
    </div>
    <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;padding:0 20px 20px">
      <!-- Context cards row -->
      <div id="intel-context-bar" style="display:flex;gap:10px;padding:12px 0;flex-shrink:0;overflow-x:auto;scrollbar-width:none">
        <button class="intel-ctx-btn active" onclick="setIntelContext('network',this)"><i data-lucide="globe" style="width:12px;height:12px"></i> Full Network</button>
        <button class="intel-ctx-btn" onclick="setIntelContext('alarms',this)"><i data-lucide="alert-triangle" style="width:12px;height:12px"></i> Active Alarms</button>
        <button class="intel-ctx-btn" onclick="setIntelContext('topology',this)"><i data-lucide="git-branch" style="width:12px;height:12px"></i> Topology</button>
        <button class="intel-ctx-btn" onclick="setIntelContext('performance',this)"><i data-lucide="activity" style="width:12px;height:12px"></i> Performance</button>
      </div>
      <!-- Messages -->
      <div id="intel-messages" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:12px;padding:4px 0 12px;scroll-behavior:smooth"></div>
      <!-- Input -->
      <div style="display:flex;gap:10px;flex-shrink:0;border-top:1px solid var(--border);padding-top:14px">
        <textarea id="intel-input" placeholder="Ask about your network, request analysis, or get Zabbix recommendations..."
          style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:#fff;font-family:'Space Grotesk',sans-serif;font-size:12px;resize:none;height:56px;outline:none;transition:border-color 0.15s"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendIntelMessage()}"
          onfocus="this.style.borderColor='var(--cyan)'" onblur="this.style.borderColor='var(--border)'"></textarea>
        <button class="btn btn-primary" style="height:56px;width:56px;padding:0;flex-shrink:0;display:flex;align-items:center;justify-content:center" onclick="sendIntelMessage()">
          <i data-lucide="send" style="width:16px;height:16px"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- ══ SETTINGS PAGE ══ -->
  <div class="page" id="page-settings">
    <div class="settings-wrap">
      <h2 style="color:#fff;font-size:18px">⚙️ Settings</h2>

      <!-- Zabbix config -->
      <div class="settings-card">
        <h3>Zabbix Connection</h3>
        <div class="ef">
          <label>Server URL</label>
          <input type="url" id="cfg-url" placeholder="http://zabbix.tabadul.iq" />
        </div>
        <div class="ef">
          <label>API Token</label>
          <input type="text" id="cfg-token" placeholder="Token..." />
        </div>
        <div class="ef">
          <label>Refresh Interval (seconds)</label>
          <input type="number" id="cfg-refresh" value="30" min="10" max="300" />
        </div>
        <div style="display:flex;gap:10px;margin-top:4px">
          <button class="btn btn-ghost" onclick="testZabbix()">🔌 Test Connection</button>
          <button class="btn btn-primary" onclick="saveZabbixConfig()">Save</button>
        </div>
        <div id="cfg-result" style="margin-top:10px;font-size:11px;font-family:'JetBrains Mono',monospace"></div>
      </div>

      <!-- AI Providers -->
      <div class="settings-card">
        <h3><i data-lucide="bot" style="width:14px;height:14px;color:var(--cyan)"></i> AI Providers</h3>
        <p style="font-size:11px;color:var(--muted);margin-bottom:14px">Configure API keys for AI Employees and map import. Keys are stored securely in the database.</p>
        <div class="ai-provider-grid">
          <!-- Claude -->
          <div class="ai-provider-card" id="aip-claude">
            <div class="aip-hdr">
              <div class="aip-icon" style="background:rgba(204,153,51,0.12)">🟡</div>
              <div class="aip-name">Claude (Anthropic)</div>
              <span class="aip-badge unset" id="aip-claude-badge">NOT SET</span>
            </div>
            <input type="password" class="aip-input" id="aip-claude-key" placeholder="sk-ant-api03-..." autocomplete="off">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span class="aip-hint">claude-sonnet-4-6, claude-opus-4-6</span>
              <a class="aip-link" href="https://console.anthropic.com/account/keys" target="_blank" rel="noopener">Get key ↗</a>
            </div>
          </div>
          <!-- OpenAI -->
          <div class="ai-provider-card" id="aip-openai">
            <div class="aip-hdr">
              <div class="aip-icon" style="background:rgba(16,163,127,0.12)">🟢</div>
              <div class="aip-name">OpenAI (GPT / Codex)</div>
              <span class="aip-badge unset" id="aip-openai-badge">NOT SET</span>
            </div>
            <input type="password" class="aip-input" id="aip-openai-key" placeholder="sk-proj-..." autocomplete="off">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span class="aip-hint">gpt-4o, gpt-4o-mini, o1</span>
              <a class="aip-link" href="https://platform.openai.com/api-keys" target="_blank" rel="noopener">Get key ↗</a>
            </div>
          </div>
          <!-- Gemini -->
          <div class="ai-provider-card" id="aip-gemini">
            <div class="aip-hdr">
              <div class="aip-icon" style="background:rgba(66,133,244,0.12)">🔵</div>
              <div class="aip-name">Google Gemini</div>
              <span class="aip-badge unset" id="aip-gemini-badge">NOT SET</span>
            </div>
            <input type="password" class="aip-input" id="aip-gemini-key" placeholder="AIzaSy..." autocomplete="off">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span class="aip-hint">gemini-2.0-flash, gemini-1.5-pro</span>
              <a class="aip-link" href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener">Get key ↗</a>
            </div>
          </div>
          <!-- Grok -->
          <div class="ai-provider-card" id="aip-grok">
            <div class="aip-hdr">
              <div class="aip-icon" style="background:rgba(255,255,255,0.06)">⚫</div>
              <div class="aip-name">Grok (xAI)</div>
              <span class="aip-badge unset" id="aip-grok-badge">NOT SET</span>
            </div>
            <input type="password" class="aip-input" id="aip-grok-key" placeholder="xai-..." autocomplete="off">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span class="aip-hint">grok-2-latest, grok-3</span>
              <a class="aip-link" href="https://console.x.ai/" target="_blank" rel="noopener">Get key ↗</a>
            </div>
          </div>
        </div>
        <!-- Default model -->
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap">
          <label style="font-size:12px;color:var(--text);white-space:nowrap">Default AI for Employees:</label>
          <select id="aip-default-provider" onchange="updateAipModelOptions()" style="background:rgba(9,14,26,0.9);border:1px solid var(--border2);border-radius:6px;padding:5px 10px;color:#e0eaff;font-size:11px;font-family:'Space Grotesk',sans-serif;outline:none">
            <option value="claude">Claude (Anthropic)</option>
            <option value="openai">OpenAI GPT</option>
            <option value="gemini">Google Gemini</option>
            <option value="grok">xAI Grok</option>
          </select>
          <select id="aip-default-model" style="background:rgba(9,14,26,0.9);border:1px solid var(--border2);border-radius:6px;padding:5px 10px;color:#e0eaff;font-size:11px;font-family:'Space Grotesk',sans-serif;outline:none;flex:1;min-width:160px">
            <option value="claude-sonnet-4-6">claude-sonnet-4-6</option>
            <option value="claude-opus-4-6">claude-opus-4-6</option>
            <option value="claude-haiku-4-5-20251001">claude-haiku-4-5</option>
          </select>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="saveAiKeys()">Save AI Keys</button>
          <div id="aip-result" style="font-size:11px;font-family:'JetBrains Mono',monospace"></div>
        </div>
      </div>

      <!-- Legacy Claude key input (kept for map import compatibility) -->
      <div id="claude-key-status" style="display:none"></div>

      <!-- Saved layouts -->
      <div class="settings-card">
        <h3>Saved Layouts</h3>
        <div id="layouts-list" class="layouts-list">Loading...</div>
        <div style="margin-top:12px">
          <button class="btn btn-ghost" onclick="saveLayoutPrompt()">💾 Save Current Layout</button>
        </div>
      </div>

      <!-- User Management (admin only) -->
      <div class="settings-card" id="user-mgmt-card" style="display:none">
        <h3 style="display:flex;align-items:center;gap:8px"><i data-lucide="users" style="width:15px;height:15px;color:var(--cyan)"></i> User Management</h3>
        <div id="users-table" style="margin:12px 0;min-height:40px;font-size:12px">Loading...</div>
        <button class="btn btn-primary" onclick="openAddUserModal()" style="margin-top:4px"><i data-lucide="user-plus" style="width:12px;height:12px;vertical-align:-1px"></i> Add User</button>
      </div>

      <!-- Active Directory LDAP (admin only) -->
      <div class="settings-card" id="ldap-card" style="display:none">
        <h3 style="display:flex;align-items:center;gap:8px"><i data-lucide="building-2" style="width:15px;height:15px;color:var(--cyan)"></i> Active Directory (LDAP)</h3>
        <p style="font-size:11px;color:var(--muted);margin-bottom:12px">Authenticate users via Microsoft AD. Local admin always works as fallback.</p>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <label style="font-size:12px;color:var(--text)">Enable LDAP</label>
          <label class="toggle-switch"><input type="checkbox" id="ldap-enabled"><span class="toggle-slider"></span></label>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="ef" style="margin:0"><label>AD Server Host</label><input type="text" id="ldap-host" placeholder="dc01.tabadul.iq"></div>
          <div class="ef" style="margin:0"><label>Port</label><input type="number" id="ldap-port" value="389" min="1" max="65535"></div>
        </div>
        <div class="ef"><label>Base DN</label><input type="text" id="ldap-base-dn" placeholder="DC=tabadul,DC=iq"></div>
        <div class="ef"><label>Bind DN (service account)</label><input type="text" id="ldap-bind-dn" placeholder="CN=noc-svc,OU=Service,DC=tabadul,DC=iq"></div>
        <div class="ef"><label>Bind Password</label><input type="password" id="ldap-bind-pass" placeholder="Service account password"></div>
        <div class="ef"><label>User Filter</label><input type="text" id="ldap-user-filter" placeholder="(&(objectClass=user)(sAMAccountName=%s))"></div>
        <div class="ef"><label>Admin Group DN (optional)</label><input type="text" id="ldap-admin-group" placeholder="CN=NOC-Admins,OU=Groups,DC=tabadul,DC=iq"></div>
        <div class="ef"><label>Operator Group DN (optional)</label><input type="text" id="ldap-operator-group" placeholder="CN=NOC-Operators,OU=Groups,DC=tabadul,DC=iq"></div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <label style="font-size:12px;color:var(--text)">Use TLS (STARTTLS)</label>
          <label class="toggle-switch"><input type="checkbox" id="ldap-use-tls"><span class="toggle-slider"></span></label>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-ghost" onclick="testLdap()"><i data-lucide="plug" style="width:12px;height:12px;vertical-align:-1px"></i> Test Connection</button>
          <button class="btn btn-primary" onclick="saveLdap()">Save LDAP Config</button>
        </div>
        <div id="ldap-result" style="margin-top:10px;font-size:11px;font-family:'JetBrains Mono',monospace"></div>
      </div>

      <!-- Change password -->
      <div class="settings-card">
        <h3>Change Password</h3>
        <div class="ef"><label>Current Password</label><input type="password" id="pw-cur" /></div>
        <div class="ef"><label>New Password</label><input type="password" id="pw-new" /></div>
        <div class="ef"><label>Confirm New Password</label><input type="password" id="pw-con" /></div>
        <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
        <div id="pw-result" style="margin-top:10px;font-size:11px;font-family:'JetBrains Mono',monospace"></div>
      </div>
    </div>
  </div>

  <!-- ══ HOST REALITY MANAGEMENT PAGE ══ -->
  <div class="page" id="page-hreality">
    <div class="hr-wrap">
      <div class="hr-header">
        <div style="flex:1">
          <h2 style="color:#fff;font-size:18px;margin:0 0 4px">Host Reality Management</h2>
          <p style="font-size:11px;color:var(--muted);margin:0">Edit host names, IPs, and Zabbix Host IDs — changes take effect across the entire app instantly.</p>
        </div>
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <input class="hr-search" id="hr-search" placeholder="Search hosts, IPs, maps..." oninput="HR.searchQ=this.value;renderHRealityPage()">
          <button class="btn btn-primary" onclick="renderHRealityPage()" style="white-space:nowrap"><i data-lucide="refresh-cw" style="width:12px;height:12px;vertical-align:-1px"></i> Refresh</button>
        </div>
      </div>
      <div style="background:rgba(9,14,26,0.7);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:12px;overflow:hidden">
        <table class="hr-table">
          <thead id="hr-thead">
            <tr>
              <th style="width:30%">Host Name / Node ID</th>
              <th style="width:14%">Map</th>
              <th style="width:18%">IP Address</th>
              <th style="width:29%">Zabbix Host ID → Linked Host</th>
              <th style="width:9%;text-align:center">Action</th>
            </tr>
          </thead>
          <tbody id="hr-tbody">
            <tr><td colspan="5" style="padding:32px;text-align:center;color:var(--muted);font-size:12px">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ══ AI EMPLOYEES OFFICE PAGE ══ -->
  <div class="page" id="page-office">
    <!-- Header Row 1: Title + Stats + Buttons -->
    <div class="office-hdr">
      <div class="office-title-blk">
        <div class="office-title">AI Operations Center</div>
        <div class="office-subtitle">Virtual NOC &amp; DevOps Operations Center · 4 AI Agents Online</div>
      </div>
      <div class="office-stats">
        <div class="ofc-stat"><div class="ofc-stat-val" id="ofc-active">0</div><div class="ofc-stat-lbl">Active</div></div>
        <div class="ofc-stat"><div class="ofc-stat-val" id="ofc-tasks">0</div><div class="ofc-stat-lbl">Tasks Today</div></div>
        <div class="ofc-stat"><div class="ofc-stat-val" id="ofc-alarms-rev">0</div><div class="ofc-stat-lbl">Alarms Reviewed</div></div>
        <div class="ofc-stat"><div class="ofc-stat-val" id="ofc-health-pct" style="color:#4ade80">--</div><div class="ofc-stat-lbl">Net Health</div></div>
      </div>
      <div class="office-actions">
        <button class="ofc-btn ofc-btn-brief" onclick="officeMorningBriefing()">⚡ Briefing</button>
        <button class="ofc-btn ofc-btn-assign" onclick="officeShowAssign(null)">+ Assign</button>
        <button class="ofc-btn ofc-btn-autocollab" id="auto-collab-btn" onclick="toggleAutoCollab()" title="Auto-start team discussions when findings need cross-team input">🤝 Auto-Collab</button>
      </div>
    </div>
    <!-- Header Row 2: AI Provider Selector + Navigation Tabs -->
    <div class="office-tab-bar">
      <select class="ofc-model-sel" id="ofc-provider-sel" onchange="officeUpdateModelSel()" title="AI Provider">
        <option value="claude">Claude</option>
        <option value="openai">OpenAI</option>
        <option value="gemini">Gemini</option>
        <option value="grok">Grok</option>
      </select>
      <select class="ofc-model-sel" id="ofc-model-sel" title="Model">
        <option value="claude-sonnet-4-6">claude-sonnet-4-6</option>
        <option value="claude-opus-4-6">claude-opus-4-6</option>
        <option value="claude-haiku-4-5-20251001">claude-haiku-4-5</option>
      </select>
      <div class="tab-sep"></div>
      <button class="office-tab active" id="otab-employees" onclick="switchOfficeTab('employees')">
        <i data-lucide="users" style="width:13px;height:13px"></i> AI Employees
      </button>
      <button class="office-tab" id="otab-teamchat" onclick="switchOfficeTab('teamchat')">
        <i data-lucide="message-square" style="width:13px;height:13px"></i> Team Chat
      </button>
      <button class="office-tab" id="otab-workflows" onclick="switchOfficeTab('workflows')">
        <i data-lucide="git-branch" style="width:13px;height:13px"></i> Workflows
      </button>
      <button class="office-tab" id="otab-vault" onclick="switchOfficeTab('vault')">
        <i data-lucide="lock" style="width:13px;height:13px"></i> Vault
      </button>
      <button class="office-tab" id="otab-whatsapp" onclick="switchOfficeTab('whatsapp')">
        <i data-lucide="message-circle" style="width:13px;height:13px"></i> WhatsApp
      </button>
    </div>

    <!-- ── Tab: Employees ── -->
    <div class="office-tab-panel" id="otp-employees">
      <div class="office-body">
        <div class="office-grid" id="office-grid"></div>
        <div class="office-feed">
          <div class="feed-hdr">
            <i data-lucide="activity" style="width:13px;height:13px;color:var(--cyan)"></i>
            Activity Feed
          </div>
          <div id="office-feed-list" class="feed-list"></div>
        </div>
      </div>
    </div>

    <!-- ── Tab: Team Chat ── -->
    <div class="office-tab-panel" id="otp-teamchat" style="display:none">
      <div class="tc-layout">
        <!-- Left: Setup + History -->
        <div class="tc-sidebar">
          <div class="tc-setup-card">
            <div class="tc-setup-title">New Collaboration Session</div>
            <textarea id="tc-topic" class="tc-topic-input" placeholder="Discussion topic... e.g. 'Analyze current network alarms and propose coordinated response'"  rows="3"></textarea>
            <div class="tc-setup-label">Participants</div>
            <div class="tc-participants">
              <label class="tc-check-lbl" style="--emp-clr:#00d4ff"><input type="checkbox" class="tc-chk" value="aria" checked> ARIA</label>
              <label class="tc-check-lbl" style="--emp-clr:#a855f7"><input type="checkbox" class="tc-chk" value="nexus" checked> NEXUS</label>
              <label class="tc-check-lbl" style="--emp-clr:#ff8c00"><input type="checkbox" class="tc-chk" value="cipher"> CIPHER</label>
              <label class="tc-check-lbl" style="--emp-clr:#4ade80"><input type="checkbox" class="tc-chk" value="vega"> VEGA</label>
            </div>
            <div class="tc-setup-row">
              <div>
                <div class="tc-setup-label">Rounds</div>
                <select id="tc-rounds" class="ofc-model-sel" style="width:80px">
                  <option value="1">1</option>
                  <option value="2" selected>2</option>
                  <option value="3">3</option>
                </select>
              </div>
              <div>
                <div class="tc-setup-label">Include live network context</div>
                <label class="tc-check-lbl"><input type="checkbox" id="tc-use-net-ctx" checked> Yes</label>
              </div>
            </div>
            <button class="tc-start-btn" id="tc-start-btn" onclick="startTeamChat()">▶ Start Session</button>
          </div>
          <!-- Session history -->
          <div class="tc-history-card">
            <div class="tc-history-title">Past Sessions</div>
            <div id="tc-history-list" class="tc-history-list">
              <div style="color:var(--muted);font-size:11px;padding:8px 0">Loading...</div>
            </div>
          </div>
        </div>
        <!-- Right: Live chat stream -->
        <div class="tc-chat-area" id="tc-chat-area">
          <div class="tc-empty-state" id="tc-empty-state">
            <i data-lucide="message-square" style="width:40px;height:40px;color:var(--border);margin-bottom:12px"></i>
            <div style="color:var(--muted);font-size:13px">Start a collaboration session to see the team discussion here.</div>
            <div style="color:var(--muted);font-size:11px;margin-top:6px">You can monitor AI employees communicating in real-time.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ── Tab: Workflows ── -->
    <div class="office-tab-panel" id="otp-workflows" style="display:none">
      <div class="wf-layout">
        <div class="wf-toolbar">
          <div style="font-size:13px;font-weight:600;color:var(--text)">Automation Workflows</div>
          <div style="display:flex;gap:8px">
            <button class="ofc-btn ofc-btn-assign" onclick="openCreateWorkflowModal()">+ New Workflow</button>
          </div>
        </div>
        <div id="workflows-grid" class="workflows-grid">
          <div style="color:var(--muted);font-size:12px;padding:32px;text-align:center">Loading workflows...</div>
        </div>
      </div>
    </div>

    <!-- ── Tab: Vault ── -->
    <div class="office-tab-panel" id="otp-vault" style="display:none">
      <div class="vault-layout">
        <div class="vault-toolbar">
          <div>
            <div style="font-size:13px;font-weight:700;color:var(--text)">🔐 Team Vault</div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px">Secure credentials &amp; access registry — entries marked "Share with AI" are injected into employee context</div>
          </div>
          <button class="ofc-btn ofc-btn-assign" onclick="openVaultModal()">+ Add Entry</button>
        </div>
        <div class="vault-cats" id="vault-cats"></div>
        <div id="vault-grid" class="vault-grid">
          <div style="color:var(--muted);font-size:12px;padding:32px;text-align:center;grid-column:1/-1">Loading vault...</div>
        </div>
      </div>
    </div>

    <!-- ── Tab: WhatsApp ── -->
    <div class="office-tab-panel" id="otp-whatsapp" style="display:none">
      <div style="display:flex;flex-direction:column;flex:1;overflow:hidden">
        <!-- Header -->
        <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border);flex-shrink:0;background:rgba(6,10,20,0.7)">
          <div>
            <div style="font-size:13px;font-weight:700;color:var(--text)">💬 WhatsApp Gateway</div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px">Each AI employee has their own WhatsApp number. Scan QR once — sessions persist forever.</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="ofc-btn" onclick="loadWAStatus()" style="font-size:10px;padding:5px 12px;background:rgba(255,255,255,0.04);border-color:var(--border);color:var(--muted)">↻ Refresh</button>
            <div id="wa-svc-badge" style="font-size:10px;padding:3px 9px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);color:var(--muted)">Checking...</div>
          </div>
        </div>
        <!-- Setup note -->
        <div id="wa-setup-note" style="margin:14px 20px 0;padding:14px 16px;border-radius:8px;background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.15);font-size:11px;color:#7aafd4;line-height:1.8">
          <b style="color:#00d4ff;font-size:12px">WhatsApp Service Not Running</b><br>
          Start it from the server terminal:<br>
          <code style="background:rgba(0,0,0,0.3);padding:2px 8px;border-radius:3px;color:#7de0a0">cd whatsapp &amp;&amp; node index.js</code><br><br>
          <b style="color:#ffb300">First-time account setup per employee:</b><br>
          <span style="color:var(--muted)">
            1. Get a virtual number from <b style="color:#fff">TextNow</b> (textnow.com — free)<br>
            2. On any Android phone/emulator: install WhatsApp → register with the TextNow number → verify via SMS<br>
            3. In WhatsApp: <b style="color:#fff">Settings → Linked Devices → Link a Device</b> → scan the QR shown here<br>
            4. Done — session is saved forever, no re-scan needed
          </span>
        </div>
        <!-- Employee cards -->
        <div id="wa-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:16px 20px;overflow-y:auto;flex:1;align-content:start">
          <div style="color:var(--muted);font-size:12px;padding:32px;text-align:center;grid-column:1/-1">Connecting to WhatsApp service...</div>
        </div>
      </div>
    </div>

  </div>
</div><!-- /main-area -->

<!-- ══ WORKFLOW CREATE/EDIT MODAL ══ -->
<div id="wf-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:900;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:28px;width:580px;max-width:95vw;max-height:92vh;overflow-y:auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div style="font-size:15px;font-weight:700;color:var(--cyan)" id="wf-modal-title">New Workflow</div>
      <button onclick="closeWfModal()" style="background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer">✕</button>
    </div>

    <!-- Step 1: Name -->
    <div class="wf-step-label">1 · Give it a name</div>
    <div class="form-row">
      <input id="wf-f-name" class="form-inp" placeholder="e.g. Critical alarm auto-analysis, Daily security review…">
    </div>

    <!-- Step 2: When -->
    <div class="wf-step-label">2 · When should it run?</div>
    <div class="wf-trigger-cards" id="wf-trigger-cards">
      <div class="wf-tc active" onclick="wfSelectTrigger('manual')" id="wtc-manual">
        <div class="wf-tc-icon">🖱️</div>
        <div class="wf-tc-title">Manual</div>
        <div class="wf-tc-desc">I'll trigger it myself</div>
      </div>
      <div class="wf-tc" onclick="wfSelectTrigger('alarm')" id="wtc-alarm">
        <div class="wf-tc-icon">🔔</div>
        <div class="wf-tc-title">On Alarm</div>
        <div class="wf-tc-desc">When Zabbix raises an alert</div>
      </div>
      <div class="wf-tc" onclick="wfSelectTrigger('schedule')" id="wtc-schedule">
        <div class="wf-tc-icon">🕐</div>
        <div class="wf-tc-title">Scheduled</div>
        <div class="wf-tc-desc">At a recurring time</div>
      </div>
    </div>
    <input type="hidden" id="wf-f-trigger" value="manual">

    <!-- Alarm options -->
    <div id="wf-trigger-alarm" style="display:none;margin-top:10px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <div class="form-lbl" style="margin-bottom:4px">Minimum severity</div>
          <select id="wf-f-severity-label" class="form-inp">
            <option value="0">Any alarm</option>
            <option value="3" selected>Average or higher</option>
            <option value="4">High or higher</option>
            <option value="5">Disaster only</option>
          </select>
          <input type="hidden" id="wf-f-severity" value="3">
        </div>
        <div>
          <div class="form-lbl" style="margin-bottom:4px">Filter by host <span style="color:var(--muted)">(optional)</span></div>
          <input id="wf-f-hostfilter" class="form-inp" placeholder="FortiGate, CBI-Switch…">
        </div>
      </div>
    </div>

    <!-- Schedule options -->
    <div id="wf-trigger-schedule" style="display:none;margin-top:10px">
      <div class="form-lbl" style="margin-bottom:4px">Run frequency</div>
      <select id="wf-f-sched-preset" class="form-inp" onchange="wfApplySchedPreset()">
        <option value="0 8 * * *">Daily at 8:00 AM</option>
        <option value="0 18 * * *">Daily at 6:00 PM</option>
        <option value="0 * * * *">Every hour</option>
        <option value="0 9 * * 1">Every Monday at 9:00 AM</option>
        <option value="0 0 * * *">Every midnight</option>
        <option value="custom">Custom (enter cron)</option>
      </select>
      <input id="wf-f-cron" class="form-inp" value="0 8 * * *" style="margin-top:8px;display:none" placeholder="cron: 0 8 * * *">
    </div>

    <!-- Step 3: Who handles it -->
    <div class="wf-step-label" style="margin-top:16px">3 · Who handles it?</div>
    <div class="wf-emp-cards" id="wf-emp-cards">
      <div class="wf-ec active" onclick="wfSelectEmp('aria')" id="wec-aria">
        <div style="color:#00d4ff;font-weight:700;font-size:12px">ARIA</div>
        <div style="color:var(--muted);font-size:10px;margin-top:2px">NOC Analyst</div>
      </div>
      <div class="wf-ec" onclick="wfSelectEmp('nexus')" id="wec-nexus">
        <div style="color:#a855f7;font-weight:700;font-size:12px">NEXUS</div>
        <div style="color:var(--muted);font-size:10px;margin-top:2px">Infra Engineer</div>
      </div>
      <div class="wf-ec" onclick="wfSelectEmp('cipher')" id="wec-cipher">
        <div style="color:#ff8c00;font-weight:700;font-size:12px">CIPHER</div>
        <div style="color:var(--muted);font-size:10px;margin-top:2px">Security Analyst</div>
      </div>
      <div class="wf-ec" onclick="wfSelectEmp('vega')" id="wec-vega">
        <div style="color:#4ade80;font-weight:700;font-size:12px">VEGA</div>
        <div style="color:var(--muted);font-size:10px;margin-top:2px">SRE</div>
      </div>
    </div>
    <input type="hidden" id="wf-f-employee" value="aria">

    <!-- Step 4: Task prompt -->
    <div class="wf-step-label" style="margin-top:16px">4 · What should they do?</div>
    <div class="wf-prompt-templates">
      <span class="wf-tpl-btn" onclick="wfFillPrompt('alarm-analysis')">🔔 Alarm analysis</span>
      <span class="wf-tpl-btn" onclick="wfFillPrompt('daily-check')">📋 Daily check</span>
      <span class="wf-tpl-btn" onclick="wfFillPrompt('security-review')">🛡️ Security review</span>
      <span class="wf-tpl-btn" onclick="wfFillPrompt('capacity')">📊 Capacity report</span>
    </div>
    <textarea id="wf-f-prompt" class="form-inp" rows="4" style="margin-top:6px"
      placeholder="Describe the task in plain language. For alarm-triggered workflows you can use {alarm_name}, {host}, {severity} as placeholders.&#10;&#10;Example: Analyze the alarm &quot;{alarm_name}&quot; on {host} and recommend an immediate action plan."></textarea>

    <!-- Step 5: Result action -->
    <div class="wf-step-label" style="margin-top:16px">5 · What to do with the result?</div>
    <div class="wf-action-cards">
      <div class="wf-ac active" onclick="wfSelectAction('log')" id="wac-log">
        <div class="wf-ac-icon">📝</div>
        <div class="wf-ac-title">Save to History</div>
        <div class="wf-ac-desc">Log the AI response</div>
      </div>
      <div class="wf-ac" onclick="wfSelectAction('webhook')" id="wac-webhook">
        <div class="wf-ac-icon">🔗</div>
        <div class="wf-ac-title">n8n Webhook</div>
        <div class="wf-ac-desc">POST to n8n / any URL</div>
      </div>
      <div class="wf-ac" onclick="wfSelectAction('zabbix_ack')" id="wac-zabbix_ack">
        <div class="wf-ac-icon">✅</div>
        <div class="wf-ac-title">Ack in Zabbix</div>
        <div class="wf-ac-desc">Auto-acknowledge alarm</div>
      </div>
      <div class="wf-ac" onclick="wfSelectAction('whatsapp_group')" id="wac-whatsapp_group">
        <div class="wf-ac-icon">📱</div>
        <div class="wf-ac-title">WhatsApp Group</div>
        <div class="wf-ac-desc">Send result to WA group</div>
      </div>
    </div>
    <input type="hidden" id="wf-f-action" value="log">
    <div id="wf-action-webhook" style="display:none;margin-top:10px">
      <div style="font-size:10px;color:var(--muted);margin-bottom:6px;line-height:1.5">
        <b style="color:#00d4ff">n8n setup:</b> In n8n → add <b>Webhook</b> node → set Method: <b>POST</b> → copy the Webhook URL below.<br>
        The payload will be: <code style="background:rgba(0,212,255,0.08);padding:1px 5px;border-radius:3px;color:#7de0a0;font-size:10px">{"workflow":"name","employee":"aria","trigger":{...},"ai_response":"..."}</code>
      </div>
      <input id="wf-f-webhook-url" class="form-inp" placeholder="https://your-n8n.domain/webhook/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" style="font-family:'JetBrains Mono',monospace;font-size:11px">
      <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
        <button onclick="wfTestWebhook()" style="padding:4px 12px;border-radius:5px;font-size:10px;font-weight:600;border:1px solid rgba(0,212,255,0.3);background:rgba(0,212,255,0.07);color:var(--cyan);cursor:pointer">
          ⚡ Test Ping
        </button>
        <span id="wf-webhook-test-result" style="font-size:10px;color:var(--muted)"></span>
      </div>
    </div>
    <!-- WhatsApp Group action config -->
    <div id="wf-action-whatsapp_group" style="display:none;margin-top:10px">
      <div style="font-size:10px;color:var(--muted);margin-bottom:8px;line-height:1.5">
        <b style="color:#4ade80">WhatsApp Group:</b> The selected AI employee will send the workflow result to the chosen group.
        Make sure the WhatsApp service is running and the employee is connected.
      </div>
      <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end">
        <div>
          <div style="font-size:9px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px">Employee to send from</div>
          <select id="wf-f-wa-emp" class="form-inp" style="width:100%">
            <option value="aria">ARIA — NOC Analyst</option>
            <option value="nexus">NEXUS — Infrastructure Engineer</option>
            <option value="cipher">CIPHER — Security Analyst</option>
            <option value="vega">VEGA — Site Reliability Engineer</option>
          </select>
        </div>
        <button onclick="wfLoadGroups()" style="padding:6px 14px;border-radius:6px;font-size:10px;font-weight:700;border:1px solid rgba(74,222,128,0.4);background:rgba(74,222,128,0.07);color:#4ade80;cursor:pointer;white-space:nowrap">
          📋 Load Groups
        </button>
      </div>
      <div style="margin-top:8px">
        <div style="font-size:9px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px">Target Group</div>
        <select id="wf-f-wa-group" class="form-inp" style="width:100%">
          <option value="">— click Load Groups first —</option>
        </select>
        <input type="hidden" id="wf-f-wa-group-name" value="">
      </div>
      <div id="wf-wa-groups-status" style="font-size:10px;color:var(--muted);margin-top:5px"></div>
    </div>

    <!-- Enable toggle -->
    <div style="display:flex;align-items:center;gap:8px;margin-top:16px">
      <label class="wf-toggle-wrap">
        <input type="checkbox" id="wf-f-active" checked>
        <span class="wf-toggle"></span>
      </label>
      <span style="color:var(--text);font-size:12px">Enable this workflow immediately</span>
    </div>

    <div style="display:flex;gap:10px;margin-top:22px;justify-content:flex-end">
      <button class="ofc-btn" onclick="closeWfModal()" style="background:var(--surface2);color:var(--text)">Cancel</button>
      <button class="ofc-btn ofc-btn-assign" onclick="saveWorkflow()">Save Workflow</button>
    </div>
  </div>
</div>

<!-- ══ VAULT ADD/EDIT MODAL ══ -->
<div id="vault-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:900;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:28px;width:500px;max-width:95vw;max-height:90vh;overflow-y:auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div style="font-size:15px;font-weight:700;color:#a88eee" id="vault-modal-title">Add Vault Entry</div>
      <button onclick="closeVaultModal()" style="background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer">✕</button>
    </div>
    <div class="form-row">
      <label class="form-lbl">Entry Name</label>
      <input id="vault-f-name" class="form-inp" placeholder="e.g. Zabbix Admin Token, FortiGate SSH Password">
    </div>
    <div class="form-row">
      <label class="form-lbl">Category</label>
      <select id="vault-f-category" class="form-inp">
        <option value="Zabbix">Zabbix</option>
        <option value="Firewall">Firewall</option>
        <option value="Switch">Switch / Router</option>
        <option value="Jump Server">Jump Server</option>
        <option value="VPN">VPN</option>
        <option value="Database">Database</option>
        <option value="Cloud">Cloud / API</option>
        <option value="Email">Email / Notifications</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="form-row">
      <label class="form-lbl">Value / Secret</label>
      <div style="position:relative">
        <input id="vault-f-value" class="form-inp" type="password" placeholder="Token, password, URL, IP address, etc." style="padding-right:38px">
        <button onclick="vaultToggleReveal()" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px" id="vault-reveal-btn">👁</button>
      </div>
    </div>
    <div class="form-row">
      <label class="form-lbl">Notes <span style="color:var(--muted);font-weight:400">(optional)</span></label>
      <textarea id="vault-f-notes" class="form-inp" rows="2" placeholder="How to use it, what system it grants access to, expiry date…"></textarea>
    </div>
    <div style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(168,142,238,0.06);border:1px solid rgba(168,142,238,0.2);border-radius:8px;margin-top:4px">
      <label class="wf-toggle-wrap">
        <input type="checkbox" id="vault-f-share" checked>
        <span class="wf-toggle" style="--tog-on:#a88eee"></span>
      </label>
      <div>
        <div style="color:var(--text);font-size:12px;font-weight:600">Share with AI Employees</div>
        <div style="color:var(--muted);font-size:10px;margin-top:1px">When ON, this credential is injected into AI employee context so they can reference it when performing tasks</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
      <button class="ofc-btn" onclick="closeVaultModal()" style="background:var(--surface2);color:var(--text)">Cancel</button>
      <button class="ofc-btn ofc-btn-autocollab" onclick="saveVaultEntry()" style="background:rgba(168,142,238,0.15);border-color:#a88eee;color:#c8b4ff">Save Entry</button>
    </div>
  </div>
</div>

<!-- ══ WORKFLOW RUN HISTORY MODAL ══ -->
<div id="wf-runs-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:900;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:28px;width:700px;max-width:95vw;max-height:85vh;overflow:hidden;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div style="font-size:14px;font-weight:700;color:var(--cyan)" id="wf-runs-title">Run History</div>
      <button onclick="document.getElementById('wf-runs-modal').style.display='none'" style="background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer">✕</button>
    </div>
    <div id="wf-runs-list" style="overflow-y:auto;flex:1"></div>
  </div>
</div>

<!-- ══ EMPLOYEE MEMORY MODAL ══ -->
<div id="emp-memory-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:900;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:28px;width:620px;max-width:95vw;max-height:85vh;overflow:hidden;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div style="font-size:14px;font-weight:700;color:var(--cyan)" id="emp-memory-title">Employee Memory</div>
      <button onclick="document.getElementById('emp-memory-modal').style.display='none'" style="background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer">✕</button>
    </div>
    <div id="emp-memory-list" style="overflow-y:auto;flex:1"></div>
  </div>
</div>

<!-- ══ ASSIGN TASK MODAL ══ -->
<div id="assign-modal">
  <div class="assign-box">
    <div class="assign-title">Assign Custom Task</div>
    <select class="assign-sel" id="assign-emp-sel">
      <option value="aria">ARIA — NOC Analyst</option>
      <option value="nexus">NEXUS — Infrastructure Engineer</option>
      <option value="cipher">CIPHER — Security Analyst</option>
      <option value="vega">VEGA — Site Reliability Engineer</option>
    </select>
    <textarea class="assign-textarea" id="assign-input" placeholder="Describe the task in detail... e.g. 'Review FortiGate HA status and check for asymmetric routing issues on the primary uplink'"></textarea>
    <!-- File attachment drop zone -->
    <div class="attach-drop-zone" id="assign-drop-zone"
      onclick="document.getElementById('assign-file-input').click()"
      ondragover="event.preventDefault();this.classList.add('drag-over')"
      ondragleave="this.classList.remove('drag-over')"
      ondrop="event.preventDefault();this.classList.remove('drag-over');assignHandleFiles(event.dataTransfer.files)">
      <input type="file" id="assign-file-input" multiple
        accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.md,.csv,.png,.jpg,.jpeg,.gif,.webp"
        style="display:none" onchange="assignHandleFiles(this.files)">
      <div class="attach-drop-zone-txt">
        <span>📎 Attach files</span> — drag & drop or click<br>
        <span style="font-size:9px;color:var(--muted)">Images · PDF · DOCX · PPTX · TXT · CSV (max 5MB each)</span>
      </div>
    </div>
    <div class="assign-files-list" id="assign-files-list"></div>
    <div class="assign-btns">
      <button class="assign-btn-cancel" onclick="assignClearFiles();document.getElementById('assign-modal').style.display='none'">Cancel</button>
      <button class="assign-btn-run" onclick="officeSubmitAssign()">⚡ Run Task</button>
    </div>
  </div>
</div>

<!-- ══ MAP ALARMS PANEL ══ -->
<div id="map-alarm-panel" style="position:fixed;bottom:0;left:var(--sidebar);width:340px;background:rgba(9,14,26,0.97);backdrop-filter:blur(14px);border:1px solid var(--border2);border-bottom:none;border-radius:14px 14px 0 0;box-shadow:0 -8px 40px rgba(0,0,0,0.55);z-index:150;user-select:none">
  <div onclick="toggleMapAlarmPanel()" style="display:flex;align-items:center;gap:8px;padding:9px 14px;cursor:pointer;border-bottom:1px solid transparent;transition:border-color 0.2s;background:linear-gradient(135deg,rgba(255,179,0,0.05) 0%,transparent 60%);border-radius:14px 14px 0 0" id="map-alarm-header">
    <div style="width:22px;height:22px;border-radius:7px;background:rgba(255,179,0,0.12);border:1px solid rgba(255,179,0,0.25);display:flex;align-items:center;justify-content:center;flex-shrink:0">
      <i data-lucide="bell-ring" style="width:11px;height:11px;color:var(--yellow)"></i>
    </div>
    <span style="font-size:11px;font-weight:600;flex:1;color:#e8f0ff;letter-spacing:0.3px">Map Alarms</span>
    <span id="map-alarm-count" class="nav-badge hidden" style="margin-left:0">0</span>
    <i data-lucide="chevron-up" id="map-alarm-chevron" style="width:12px;height:12px;color:var(--muted);transition:transform 0.22s;flex-shrink:0"></i>
  </div>
  <div id="map-alarm-body" style="display:none;max-height:280px;overflow-y:auto">
    <div id="map-alarm-list" style="padding:4px 0"></div>
  </div>
</div>

<!-- ══ HOST AI CHAT PANEL ══ -->
<div id="host-chat-panel" style="position:fixed;bottom:0;right:18px;width:380px;background:rgba(9,14,26,0.97);backdrop-filter:blur(14px);border:1px solid var(--border2);border-bottom:none;border-radius:14px 14px 0 0;box-shadow:0 -8px 40px rgba(0,0,0,0.6);z-index:200;display:none;flex-direction:column;max-height:520px">
  <div style="display:flex;align-items:center;gap:9px;padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;flex-shrink:0;background:linear-gradient(135deg,rgba(99,102,241,0.08) 0%,transparent 60%);border-radius:14px 14px 0 0" onclick="toggleHostChat()">
    <div style="width:28px;height:28px;border-radius:9px;background:linear-gradient(135deg,#4f46e5,#7c3aed);display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 3px 12px rgba(79,70,229,0.35)">
      <i data-lucide="bot" style="width:13px;height:13px;color:#fff"></i>
    </div>
    <div style="flex:1">
      <div style="font-size:11px;font-weight:700;color:#e8f0ff;letter-spacing:0.3px">AI Network Assistant</div>
      <div id="hc-context-label" style="font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:1px">No host selected</div>
    </div>
    <i data-lucide="chevron-down" id="hc-chevron" style="width:13px;height:13px;color:var(--muted);transition:transform 0.22s"></i>
  </div>
  <div id="hc-body" style="display:flex;flex-direction:column;flex:1;overflow:hidden">
    <div id="hc-messages" style="flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:10px;min-height:200px;max-height:340px;scroll-behavior:smooth"></div>
    <div style="padding:10px 12px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;background:rgba(0,0,0,0.15)">
      <input id="hc-input" placeholder="Ask about this host..." style="flex:1;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:7px;padding:7px 10px;color:#e0eaff;font-family:'Space Grotesk',sans-serif;font-size:11px;outline:none;transition:border-color 0.15s" onfocus="this.style.borderColor='rgba(0,212,255,0.4)'" onblur="this.style.borderColor='var(--border)'" onkeydown="if(event.key==='Enter')sendHostChat()">
      <button onclick="sendHostChat()" style="background:linear-gradient(135deg,#4f46e5,#7c3aed);border:none;border-radius:7px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:filter 0.15s;box-shadow:0 2px 10px rgba(79,70,229,0.35)" onmouseover="this.style.filter='brightness(1.12)'" onmouseout="this.style.filter=''">
        <i data-lucide="send" style="width:12px;height:12px;color:#fff"></i>
      </button>
    </div>
  </div>
</div>

<!-- ══ ADD USER MODAL ══ -->
<div class="modal-overlay" id="add-user-modal">
  <div class="modal-card" style="width:400px;max-width:96vw">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h3 style="margin:0;display:flex;align-items:center;gap:8px"><i data-lucide="user-plus" style="width:16px;height:16px;color:var(--cyan)"></i> Add User</h3>
      <button onclick="document.getElementById('add-user-modal').classList.remove('open')" style="background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer">✕</button>
    </div>
    <div class="ef"><label>Username *</label><input type="text" id="nu-username" placeholder="john.doe" autocomplete="off"></div>
    <div class="ef"><label>Display Name</label><input type="text" id="nu-display" placeholder="John Doe"></div>
    <div class="ef"><label>Email</label><input type="email" id="nu-email" placeholder="john@tabadul.iq"></div>
    <div class="ef">
      <label>Role *</label>
      <select id="nu-role" style="background:var(--surface2);border:1px solid var(--border);color:#fff;border-radius:6px;padding:8px 10px">
        <option value="viewer">Viewer — Read only</option>
        <option value="operator">Operator — Edit nodes, ack alarms</option>
        <option value="admin">Admin — Full access</option>
      </select>
    </div>
    <div class="ef"><label>Password *</label><input type="password" id="nu-pass" placeholder="Min 4 characters" autocomplete="new-password"></div>
    <div id="nu-result" style="font-size:11px;font-family:'JetBrains Mono',monospace;min-height:16px;margin-bottom:8px"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="document.getElementById('add-user-modal').classList.remove('open')">Cancel</button>
      <button class="btn btn-primary" onclick="doAddUser()"><i data-lucide="check" style="width:12px;height:12px;vertical-align:-1px"></i> Create User</button>
    </div>
  </div>
</div>

<!-- ══ IMPORT MAP MODAL ══ -->
<div class="modal-overlay" id="import-modal">
  <div class="modal-card" style="width:580px;max-width:96vw">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h3 style="margin:0">📥 Import Network Map</h3>
      <button onclick="closeImportModal()" style="background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer">✕</button>
    </div>

    <!-- Step indicator -->
    <div class="import-steps" id="imp-steps">
      <div class="import-step active" id="imp-s1">1 · Upload</div>
      <div class="import-step" id="imp-s2">2 · Review</div>
      <div class="import-step" id="imp-s3">3 · Create</div>
    </div>

    <!-- Step 1: Upload -->
    <div id="imp-step1">
      <div class="ef">
        <label>Map Name</label>
        <input id="imp-name" placeholder="e.g. Payment Network Map" />
      </div>
      <div class="drop-zone" id="imp-drop" onclick="document.getElementById('imp-file').click()">
        <div class="drop-zone-icon">📄</div>
        <div class="drop-zone-lbl"><b>Click to upload</b> or drag & drop</div>
        <div class="drop-zone-lbl" style="font-size:10px;margin-top:4px">PNG · JPG · PDF</div>
        <input type="file" id="imp-file" accept=".png,.jpg,.jpeg,.pdf,image/*,application/pdf" style="display:none" onchange="onFileSelected(this)">
      </div>
      <div id="imp-file-info" style="font-size:11px;color:var(--cyan);font-family:'JetBrains Mono',monospace;margin-top:8px;min-height:16px"></div>
      <div id="imp-err" style="color:var(--red);font-size:11px;font-family:'JetBrains Mono',monospace;margin-top:6px;min-height:14px"></div>
      <div style="display:flex;gap:10px;margin-top:16px">
        <button class="btn btn-ghost" onclick="closeImportModal()">Cancel</button>
        <button class="btn btn-primary" id="imp-analyze-btn" onclick="doAnalyzeMap()" disabled>Analyze with Claude →</button>
      </div>
    </div>

    <!-- Step 2: Review results -->
    <div id="imp-step2" style="display:none">
      <div class="import-summary" id="imp-summary"></div>
      <p style="font-size:11px;color:var(--muted);margin-bottom:6px">
        ✓ Matched nodes will be added to the map. Unmatched nodes (no IP or not found in Zabbix) are shown struck-through and will be skipped.
      </p>
      <div style="overflow-y:auto;max-height:320px;border:1px solid var(--border);border-radius:6px">
        <table class="preview-table">
          <thead><tr>
            <th>Device Name</th><th>IP</th><th>Type</th><th>Zabbix Host</th><th>Status</th>
          </tr></thead>
          <tbody id="imp-preview-body"></tbody>
        </table>
      </div>
      <div style="display:flex;gap:10px;margin-top:16px">
        <button class="btn btn-ghost" onclick="impGoStep(1)">← Back</button>
        <button class="btn btn-primary" id="imp-create-btn" onclick="doCreateMap()">Create Map →</button>
      </div>
    </div>

    <!-- Step 3: Done -->
    <div id="imp-step3" style="display:none;text-align:center;padding:20px 0">
      <div style="font-size:40px;margin-bottom:12px">✅</div>
      <div id="imp-done-msg" style="color:#fff;font-size:15px;margin-bottom:6px"></div>
      <div style="color:var(--muted);font-size:12px;margin-bottom:20px">Map is now available in the sidebar</div>
      <button class="btn btn-primary" onclick="closeImportModal()">Done</button>
    </div>
  </div>
</div>

<!-- ══ ADD NODE MODAL ══ -->
<div class="modal-overlay" id="add-modal">
  <div class="modal-card">
    <h3>＋ Add New Node</h3>
    <div class="ef"><label>Display Label *</label><input id="add-label" placeholder="e.g. App Server 01" /></div>
    <div class="ef-row">
      <div class="ef"><label>IP Address</label><input id="add-ip" placeholder="10.1.5.20" /></div>
      <div class="ef"><label>Status</label>
        <select id="add-status">
          <option value="ok">● ONLINE</option>
          <option value="warn">⚠ WARNING</option>
          <option value="crit">✗ CRITICAL</option>
          <option value="info">ℹ INFO</option>
        </select>
      </div>
    </div>
    <div class="ef"><label>Role / Description</label><input id="add-role" placeholder="Payment Application Server" /></div>
    <div class="ef-row">
      <div class="ef"><label>Type</label>
        <select id="add-type">
          <option value="external">🌐 External</option>
          <option value="wan">📡 WAN</option>
          <option value="switch">🔀 Switch</option>
          <option value="firewall">🛡 Firewall</option>
          <option value="palo">🔥 Palo Alto</option>
          <option value="f5">⚖️ F5</option>
          <option value="server" selected>🖥 Server</option>
          <option value="dbserver">🗄 DB Server</option>
          <option value="hsm">🔐 HSM</option>
          <option value="infra">🏗 Infra</option>
        </select>
      </div>
      <div class="ef"><label>Layer Column</label>
        <select id="add-layer">
          <option value="ext">External</option>
          <option value="wan">WAN/ISP</option>
          <option value="inet">Internet SW</option>
          <option value="core">Core SW</option>
          <option value="fw">Payment FW</option>
          <option value="fp">IPS/Firepower</option>
          <option value="tor">NX-OS TOR</option>
          <option value="app">App FW/LB</option>
          <option value="srv" selected>Servers</option>
          <option value="hsm">HSM/Infra</option>
        </select>
      </div>
    </div>
    <div class="ef"><label>Zabbix Host ID (optional — links live status)</label><input id="add-zbxid" placeholder="e.g. 10084" /></div>
    <div class="ef"><label>Interfaces (one per line)</label><textarea id="add-ifaces" rows="3" placeholder="Eth0/1 → Core-SW"></textarea></div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="closeModal('add-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitAddNode()">Add Node</button>
    </div>
  </div>
</div>

<!-- ══ SAVE LAYOUT MODAL ══ -->
<div class="modal-overlay" id="layout-modal">
  <div class="modal-card" style="width:360px">
    <h3>💾 Save Layout</h3>
    <div class="ef"><label>Layout Name</label><input id="layout-name" placeholder="e.g. Default View" /></div>
    <div class="ef" style="display:flex;align-items:center;gap:8px">
      <input type="checkbox" id="layout-default" style="width:auto;padding:0">
      <label style="display:inline;font-size:12px;color:var(--text);font-family:'Inter',sans-serif;letter-spacing:0">Set as default layout</label>
    </div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="closeModal('layout-modal')">Cancel</button>
      <button class="btn btn-success" onclick="submitSaveLayout()">Save Layout</button>
    </div>
  </div>
</div>

<!-- ══ DISCOVER MODAL ══ -->
<div class="modal-overlay" id="discover-modal" style="display:none">
  <div class="modal-card" style="width:640px;max-width:96vw;max-height:88vh;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-shrink:0">
      <h3 style="margin:0;font-size:15px;font-weight:700;color:#fff">
        <i data-lucide="radar" style="width:15px;height:15px;vertical-align:-2px;color:var(--cyan)"></i>
        Zabbix Topology Auto-Discovery
      </h3>
      <button class="dp-close" onclick="closeDiscoverModal()">×</button>
    </div>

    <!-- Step 1: Scan & Select -->
    <div id="disc-step1" style="flex:1;overflow:hidden;display:flex;flex-direction:column">
      <div class="ef" style="flex-shrink:0">
        <label>Map Name</label>
        <input class="edit-inp" id="disc-name" value="Auto-Discovered Map" />
      </div>
      <div id="disc-scan-state" style="text-align:center;padding:30px 0;color:var(--muted);font-size:12px">
        Click Scan to discover hosts from Zabbix
      </div>
      <div id="disc-subnet-list" style="flex:1;overflow-y:auto;display:none"></div>
      <div style="flex-shrink:0;margin-top:12px;display:flex;gap:8px;align-items:center">
        <button class="btn btn-ghost" id="disc-scan-btn" onclick="doDiscoverScan()">
          <i data-lucide="search" style="width:12px;height:12px;vertical-align:-1px"></i> Scan Zabbix
        </button>
        <span id="disc-scan-summary" style="font-size:11px;color:var(--muted)"></span>
        <button class="btn btn-primary" id="disc-create-btn" style="margin-left:auto;display:none" onclick="doDiscoverCreate()">
          Create Map →
        </button>
      </div>
    </div>

    <!-- Step 2: Done -->
    <div id="disc-step2" style="display:none;text-align:center;padding:40px 0">
      <div id="disc-done-msg" style="font-size:14px;color:var(--green);margin-bottom:12px"></div>
      <button class="btn btn-primary" onclick="closeDiscoverModal()">Done</button>
    </div>
  </div>
</div>

<!-- TOOLTIP -->
<div id="vis-tip">
  <div class="t-name" id="tip-name"></div>
  <div class="t-ip"   id="tip-ip"></div>
  <div class="t-role" id="tip-role"></div>
  <div class="t-alarm" id="tip-alarm" style="display:none"></div>
</div>

<script>
// ═══════════════════════════════════════════════════════════
//  CONSTANTS
// ═══════════════════════════════════════════════════════════
const SEV = {
  5:{label:'DISASTER', color:'#FF1744', icon:'💀', bg:'rgba(255,23,68,0.08)'},
  4:{label:'HIGH',     color:'#FF6D00', icon:'🔴', bg:'rgba(255,109,0,0.08)'},
  3:{label:'AVERAGE',  color:'#FFB300', icon:'🟠', bg:'rgba(255,179,0,0.08)'},
  2:{label:'WARNING',  color:'#78909C', icon:'🟡', bg:'rgba(120,144,156,0.06)'},
  1:{label:'INFO',     color:'#00B0FF', icon:'🔵', bg:'rgba(0,176,255,0.06)'},
  0:{label:'NC',       color:'#9E9E9E', icon:'⚪', bg:'rgba(158,158,158,0.04)'},
};

function makeIcon(type){
  const sz=48;
  const icons={
    external:['#f1c40f','M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z'],
    wan:['#00bcd4','M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z'],
    switch:['#3498db','M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zm7.02-2L18 5l-3.99-4v3H10v2h7.01v3z'],
    firewall:['#e74c3c','M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 4.99L18 8.74V11c0 3.61-2.43 7.01-6 8.06C8.43 18.01 6 14.61 6 11V8.74l6-2.75z'],
    palo:['#e67e22','M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z'],
    f5:['#2ecc71','M6 2v3H3l4.5 4.5L12 5H9V2H6zm12 17v-3h3l-4.5-4.5L12 16h3v3h3zM3.51 6.51L2 8l10 10 1.49-1.49L3.51 6.51zM22 8l-1.49-1.49-4.24 4.24 1.49 1.49L22 8z'],
    server:['#1abc9c','M20 2H4c-1.1 0-2 .9-2 2v4c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 6H4V4h16v4zM4 14h16c1.1 0 2-.9 2-2v-.5H2V12c0 1.1.9 2 2 2zm0 6h16c1.1 0 2-.9 2-2v-.5H2V18c0 1.1.9 2 2 2zM6 5.5h2v1H6zm0 6h2v1H6zm0 6h2v1H6z'],
    dbserver:['#e91e63','M12 3C7.58 3 4 4.79 4 7v10c0 2.21 3.59 4 8 4s8-1.79 8-4V7c0-2.21-3.58-4-8-4zm6 14c0 .5-2.13 2-6 2s-6-1.5-6-2v-2.23c1.61.78 3.72 1.23 6 1.23s4.39-.45 6-1.23V17zm0-5c0 .5-2.13 2-6 2s-6-1.5-6-2v-2.23C7.61 10.55 9.72 11 12 11s4.39-.45 6-1.23V12zm-6-3C8.13 9 6 7.5 6 7s2.13-2 6-2 6 1.5 6 2-2.13 2-6 2z'],
    hsm:['#9b59b6','M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z'],
    infra:['#78909c','M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z'],
  };
  const [color,path]=icons[type]||icons.infra;
  const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${sz}" height="${sz}" viewBox="0 0 ${sz} ${sz}"><rect width="${sz}" height="${sz}" rx="10" fill="${color}" fill-opacity="0.2"/><rect x="1.5" y="1.5" width="${sz-3}" height="${sz-3}" rx="8.5" fill="none" stroke="${color}" stroke-width="1.5" opacity="0.6"/><g transform="translate(12,12)" fill="${color}"><path d="${path}"/></g></svg>`;
  return 'data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(svg)));
}
const ICONS={external:makeIcon('external'),wan:makeIcon('wan'),switch:makeIcon('switch'),firewall:makeIcon('firewall'),palo:makeIcon('palo'),f5:makeIcon('f5'),server:makeIcon('server'),dbserver:makeIcon('dbserver'),hsm:makeIcon('hsm'),infra:makeIcon('infra')};
const COLORS={external:{border:'#f1c40f',font:'#f1c40f'},wan:{border:'#00bcd4',font:'#80deea'},switch:{border:'#3498db',font:'#90caf9'},firewall:{border:'#e74c3c',font:'#ef9a9a'},palo:{border:'#e67e22',font:'#ffb74d'},f5:{border:'#2ecc71',font:'#a5d6a7'},server:{border:'#1abc9c',font:'#80cbc4'},dbserver:{border:'#e91e63',font:'#f48fb1'},hsm:{border:'#9b59b6',font:'#ce93d8'},infra:{border:'#78909c',font:'#b0bec5'}};
const LX={ext:-900,wan:-680,inet:-440,core:-200,fw:40,fp:270,tor:510,app:750,srv:970,hsm:1200};

// ═══════════════════════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════════════════════
const S = {
  zabbixHosts:{},        // hostid -> host obj
  zabbixProblems:[],     // all active problems
  nodeHostMap:{},        // nodeId -> zabbixHostId
  dbNodes:{},            // nodeId -> db row (custom)
  currentAlarmFilter: -1,
  hostFilterMode:'all',
  hostSearchQ:'',
  allProblems:[],
  allHosts:[],
  refreshTimer:null,
  refreshInterval:30000,
  lastRefreshTs:null,
  currentMapId: 0,       // 0 = default Network Map, >0 = imported layout id
  currentMapName:'Network Map',
  currentMapHostIds: new Set(), // zabbixHostIds on current map (empty = show all)
  importAnalysisResult: null,   // holds last Claude analysis
  myRole: 'admin',       // current user role: admin | operator | viewer
  layouts: [],           // all map layouts from API
  hostMapIndex: {},      // hostId -> {mapId, mapName}
};

// ═══════════════════════════════════════════════════════════
//  DEFAULT DEVICE DATA (built-in nodes)
// ═══════════════════════════════════════════════════════════
const deviceData = {
  visa:           {name:'VISA Network',role:'External Payment Network',ip:'185.76.35.129',type:'external',status:'ok',ifaces:['P2P Link'],info:{Protocol:'ISO 8583',Auth:'VisaNet'}},
  mc:             {name:'MasterCard',role:'External Payment Network',ip:'10.92.46.55',type:'external',status:'ok',ifaces:['MC Switch P14'],info:{Protocol:'ISO 8583'}},
  cbi:            {name:'CBI — Central Bank Iraq',role:'Regulatory Authority',ip:'172.29.222.10',type:'external',status:'ok',ifaces:['CBI SW'],info:{Protocol:'SWIFT'}},
  isp:            {name:'ISP Uplink',role:'Internet Service Provider',ip:'204.106.240.53',type:'external',status:'ok',ifaces:['ScopeSky','Passport-SS'],info:{Provider:'ScopeSky / Passport'}},
  dr:             {name:'DR Site',role:'Disaster Recovery',ip:'100.127.40.2',type:'infra',status:'info',ifaces:['P2P'],info:{Mode:'Active-Passive',RPO:'4hr',RTO:'8hr'}},
  scopesky:       {name:'ScopeSky ISP',role:'WAN / P2P Link',ip:'204.106.240.53',type:'wan',status:'ok',ifaces:['To Internet-SW'],info:{Type:'Fiber'}},
  'passport-ss':  {name:'PassPort LocalSS',role:'WAN / P2P Link',ip:'10.130.200.103',type:'wan',status:'ok',ifaces:['To Internet-SW'],info:{Type:'MPLS'}},
  'asia-local':   {name:'Asia Local',role:'WAN / P2P Link',ip:'172.22.223.130',type:'wan',status:'ok',ifaces:['To Internet-SW'],info:{Type:'Leased Line'}},
  'zain-m2m':     {name:'Zain M2M',role:'M2M / IoT Network',ip:'151.236.160.30',type:'wan',status:'ok',ifaces:['To Internet-SW'],info:{Type:'4G/LTE'}},
  'mc-sw':        {name:'MC Switch',role:'MasterCard Switch P14',ip:'Internal',type:'wan',status:'ok',ifaces:['P14 → Internet-SW'],info:{}},
  'cbi-sw':       {name:'CBI Switch',role:'Central Bank Switch',ip:'Internal',type:'wan',status:'ok',ifaces:['To Internet-SW'],info:{}},
  'inet-sw':      {name:'Internet Switch',role:'L3 Edge Switching',ip:'10.1.0.15',type:'switch',status:'ok',ifaces:['Gi5/0/1 → Core-SW'],info:{Model:'Cisco 6800'}},
  'core-sw':      {name:'Core Switch',role:'L3 Core Distribution',ip:'10.1.0.5',type:'switch',status:'ok',ifaces:['→ Payment FW × 2'],info:{Model:'Catalyst 6800',VLAN:'Payment,Mgmt'}},
  'pmt-fw1':      {name:'FortiGate 601 — Primary',role:'Next-Gen Firewall (Active)',ip:'10.1.0.2',type:'firewall',status:'ok',ifaces:['PORT1 ← Core','PORT2 → FP1','HA'],info:{Model:'FortiGate 601E',Mode:'HA Active',IPS:'Enabled'}},
  'pmt-fw2':      {name:'FortiGate 601 — Secondary',role:'Next-Gen Firewall (Passive)',ip:'10.1.0.3',type:'firewall',status:'ok',ifaces:['PORT1 ← Core','PORT2 → FP2','HA'],info:{Model:'FortiGate 601E',Mode:'HA Passive'}},
  fp1:            {name:'Cisco Firepower 1',role:'IPS / NGIPS (Active)',ip:'10.1.0.4',type:'firewall',status:'ok',ifaces:['Eth1/15 ← FG1','Eth1/47 → TOR1'],info:{Model:'FP 4150',Mode:'HA Active',IPS:'Snort 3'}},
  fp2:            {name:'Cisco Firepower 2',role:'IPS / NGIPS (Passive)',ip:'10.1.0.6',type:'firewall',status:'ok',ifaces:['Eth1/15 ← FG2','Eth1/47 → TOR2'],info:{Model:'FP 4150',Mode:'HA Passive'}},
  tor1:           {name:'NXOS TOR Switch 1',role:'Top-of-Rack VPC Primary',ip:'10.1.0.7',type:'switch',status:'ok',ifaces:['Eth1/47 ← FP1','Eth1/11 → Palo','Eth1/36 → F5'],info:{Model:'Nexus 93xx',VPC:'Primary'}},
  tor2:           {name:'NXOS TOR Switch 2',role:'Top-of-Rack VPC Secondary',ip:'10.1.0.8',type:'switch',status:'ok',ifaces:['Eth1/47 ← FP2','Eth1/36 → F5','Eth1/3-7 → HSM'],info:{Model:'Nexus 93xx',VPC:'Secondary'}},
  palo1:          {name:'Palo Alto — Unit 1',role:'App-Layer FW (Active)',ip:'10.1.0.13',type:'palo',status:'ok',ifaces:['Eth1/11 ← TOR'],info:{Model:'PA-5250',Mode:'HA Active',AppID:'Enabled'}},
  palo2:          {name:'Palo Alto — Unit 2',role:'App-Layer FW (Passive)',ip:'10.1.0.14',type:'palo',status:'ok',ifaces:['Eth1/11 ← TOR'],info:{Model:'PA-5250',Mode:'HA Passive'}},
  'f5-1':         {name:'F5 BIG-IP LTM 1',role:'Load Balancer (Active)',ip:'10.1.0.11',type:'f5',status:'ok',ifaces:['Eth1/36 ← TOR1','→ Servers'],info:{Model:'i7800',Mode:'HA Active',SSL:'Offload'}},
  'f5-2':         {name:'F5 BIG-IP LTM 2',role:'Load Balancer (Passive)',ip:'10.1.0.12',type:'f5',status:'ok',ifaces:['Eth1/36 ← TOR2'],info:{Model:'i7800',Mode:'HA Passive'}},
  ag1000:         {name:'AG1000 Router',role:'Aggregation Router',ip:'100.64.2.68',type:'switch',status:'ok',ifaces:['← TOR2'],info:{Model:'AG1000'}},
  'web-servers':  {name:'WEB Servers Cluster',role:'Payment Application Servers',ip:'10.100.x.x',type:'server',status:'ok',ifaces:['← TOR1+2','← F5 VIP'],info:{OS:'RHEL 8',Instances:'4×',Cluster:'Active-Active'}},
  'db-servers':   {name:'DB Servers Cluster',role:'Payment Database Servers',ip:'10.200.x.x',type:'dbserver',status:'ok',ifaces:['← TOR1+2','← F5 VIP'],info:{DB:'Oracle RAC / MS SQL',Mode:'HA Active-Active'}},
  'hsm-auth1':    {name:'HSM-Auth-1',role:'Authentication HSM',ip:'100.66.0.122',type:'hsm',status:'ok',ifaces:['← TOR2'],info:{Model:'Thales payShield 10K',Function:'PIN/Key Mgmt',FIPS:'140-2 L3'}},
  'hsm-auth2':    {name:'HSM-Auth-2',role:'Authentication HSM',ip:'100.66.0.123',type:'hsm',status:'ok',ifaces:['Eth1/3 ← TOR2'],info:{Model:'Thales payShield 10K',Function:'PIN/Key Mgmt',FIPS:'140-2 L3'}},
  'hsm-acs1':     {name:'HSM-ACS-1',role:'Access Control Server HSM',ip:'100.66.0.124',type:'hsm',status:'ok',ifaces:['Eth1/4 ← TOR2'],info:{Model:'Thales payShield',Function:'EMV ACS',FIPS:'140-2 L3'}},
  'hsm-acs2':     {name:'HSM-ACS-2',role:'Access Control Server HSM',ip:'100.66.0.125',type:'hsm',status:'ok',ifaces:['Eth1/5 ← TOR2'],info:{Model:'Thales payShield',Function:'EMV ACS',FIPS:'140-2 L3'}},
  veeam:          {name:'VeeamSRV',role:'Backup Server',ip:'100.65.0.247',type:'infra',status:'ok',ifaces:['Eth1/43 ← TOR1'],info:{Software:'Veeam B&R v12'}},
  olvm:           {name:'OLVM Manager',role:'Oracle Linux Virt Mgr',ip:'10.1.0.25',type:'infra',status:'ok',ifaces:['Eth1/39 ← TOR1'],info:{Platform:'OLVM 4.5',Hosts:'8 hypervisors'}},
  'hv-prod':      {name:'HV-PROD',role:'Hyper-V Production Host',ip:'10.1.0.21',type:'infra',status:'ok',ifaces:['Eth1/30 ← TOR1'],info:{Platform:'Hyper-V 2022'}},
  hnv03:          {name:'HNV03',role:'Hyper-V Node 3',ip:'10.50.0.33',type:'infra',status:'ok',ifaces:['Eth1/26 ← TOR1'],info:{}},
  hnv04:          {name:'HNV04',role:'Hyper-V Node 4',ip:'10.50.0.34',type:'infra',status:'ok',ifaces:['Eth1/24 ← TOR2'],info:{}},
  'perso-fiber':  {name:'Perso-Fiber',role:'Personalization Fiber Channel',ip:'10.50.0.40',type:'infra',status:'ok',ifaces:['Eth1/32 ← TOR1'],info:{Type:'FC SAN'}},
  'storeonce-01': {name:'StoreOnce-01',role:'HPE StoreOnce Backup',ip:'100.64.2.43',type:'infra',status:'ok',ifaces:['← TOR1'],info:{Model:'HPE StoreOnce'}},
  'storeonce-02': {name:'StoreOnce-02',role:'HPE StoreOnce Backup',ip:'100.64.2.44',type:'infra',status:'ok',ifaces:['← TOR2'],info:{Model:'HPE StoreOnce'}},
};

// ═══════════════════════════════════════════════════════════
//  VIS-NETWORK SETUP
// ═══════════════════════════════════════════════════════════
function mkNode(id,label,type,x,y,extra={}){
  const c=COLORS[type]||COLORS.switch;
  return {id,x,y,label,shape:'image',image:ICONS[type]||ICONS.switch,
    size:extra.size||30,font:{color:c.font,size:extra.fontSize||11,bold:true,face:'Space Grotesk',multi:true},
    color:{border:c.border,background:'transparent',highlight:{border:'#00d4ff',background:'rgba(0,212,255,0.1)'},hover:{border:'#00d4ff'}},
    borderWidth:2,borderWidthSelected:3,
    shadow:{enabled:true,color:c.border+'44',size:14,x:0,y:2},
    _type:type,...extra};
}
function mkEdge(f,t,col,o={}){return{from:f,to:t,color:{color:col,opacity:0.85,highlight:'#00d4ff',hover:'#00d4ff'},_origColor:col,...o}}
function mkHA(f,t,col,lbl){return mkEdge(f,t,col,{width:1,dashes:[5,4],label:lbl,font:{color:col+'99',size:9,background:'rgba(10,14,26,.9)'},smooth:{enabled:true,type:'curvedCW',roundness:0.5}})}

const visNodes = new vis.DataSet([
  mkNode('visa','VISA\nNetwork','external',-900,-320,{size:28}),
  mkNode('isp','ISP\n204.106.240.53','external',-900,-160,{size:24}),
  mkNode('cbi','CBI\nCent.Bank Iraq','external',-900,0,{size:22}),
  mkNode('mc','MasterCard','external',-900,160,{size:26}),
  mkNode('dr','DR Site','infra',-900,320,{size:20}),
  mkNode('scopesky','ScopeSky ISP','wan',-680,-290,{size:18,fontSize:9}),
  mkNode('passport-ss','PassPort-SS','wan',-680,-180,{size:18,fontSize:9}),
  mkNode('asia-local','Asia Local','wan',-680,-60,{size:18,fontSize:9}),
  mkNode('zain-m2m','Zain M2M','wan',-680,60,{size:18,fontSize:9}),
  mkNode('mc-sw','MC Switch\nP14','switch',-680,190,{size:18,fontSize:9}),
  mkNode('cbi-sw','CBI Switch','switch',-680,300,{size:18,fontSize:9}),
  mkNode('inet-sw','Internet Switch\n10.1.0.15','switch',-440,0,{size:34,fontSize:13}),
  mkNode('core-sw','Core Switch\n10.1.0.5','switch',-200,0,{size:34,fontSize:13}),
  mkNode('pmt-fw1','FortiGate 601\nPrimary ●','firewall',40,-90,{size:28,fontSize:11}),
  mkNode('pmt-fw2','FortiGate 601\nSecondary ○','firewall',40,90,{size:28,fontSize:11}),
  mkNode('fp1','Firepower IPS\nUnit 1 ●','firewall',270,-90,{size:26,fontSize:11}),
  mkNode('fp2','Firepower IPS\nUnit 2 ○','firewall',270,90,{size:26,fontSize:11}),
  mkNode('tor1','NXOS-TOR 1\nVPC Primary','switch',510,-130,{size:30,fontSize:12}),
  mkNode('tor2','NXOS-TOR 2\nVPC Secondary','switch',510,130,{size:30,fontSize:12}),
  mkNode('ag1000','AG1000\nAgg.Router','switch',510,380,{size:22,fontSize:10}),
  mkNode('palo1','Palo Alto\nUnit 1 ●','palo',750,-280,{size:26,fontSize:11}),
  mkNode('palo2','Palo Alto\nUnit 2 ○','palo',750,-160,{size:26,fontSize:11}),
  mkNode('f5-1','F5 BIG-IP\n10.1.0.11 ●','f5',750,160,{size:26,fontSize:11}),
  mkNode('f5-2','F5 BIG-IP\n10.1.0.12 ○','f5',750,280,{size:26,fontSize:11}),
  mkNode('web-servers','WEB Servers\nCluster','server',970,-130,{size:30,fontSize:12}),
  mkNode('db-servers','DB Servers\nCluster','dbserver',970,130,{size:30,fontSize:12}),
  mkNode('hsm-auth1','HSM-Auth-1\n100.66.0.122','hsm',1200,-390,{size:22,fontSize:9}),
  mkNode('hsm-auth2','HSM-Auth-2\n100.66.0.123','hsm',1200,-290,{size:22,fontSize:9}),
  mkNode('hsm-acs1','HSM-ACS-1\n100.66.0.124','hsm',1200,-190,{size:22,fontSize:9}),
  mkNode('hsm-acs2','HSM-ACS-2\n100.66.0.125','hsm',1200,-90,{size:22,fontSize:9}),
  mkNode('veeam','VeeamSRV','infra',1200,60,{size:18,fontSize:9}),
  mkNode('olvm','OLVM Mgr','infra',1200,150,{size:18,fontSize:9}),
  mkNode('hv-prod','HV-PROD','infra',1200,240,{size:18,fontSize:9}),
  mkNode('hnv03','HNV03','infra',1200,320,{size:18,fontSize:9}),
  mkNode('hnv04','HNV04','infra',1200,400,{size:18,fontSize:9}),
  mkNode('perso-fiber','Perso-Fiber','infra',1200,480,{size:18,fontSize:9}),
  mkNode('storeonce-01','StoreOnce-01\n100.64.2.43','infra',1200,560,{size:18,fontSize:9}),
  mkNode('storeonce-02','StoreOnce-02\n100.64.2.44','infra',1200,640,{size:18,fontSize:9}),
]);

const visEdges = new vis.DataSet([
  mkEdge('visa','inet-sw','#f1c40f',{width:3,arrows:{to:{enabled:true,scaleFactor:0.6}}}),
  mkEdge('isp','inet-sw','#f1c40f',{width:3,arrows:{to:{enabled:true,scaleFactor:0.6}}}),
  mkEdge('cbi','inet-sw','#f1c40f',{width:2,arrows:{to:{enabled:true,scaleFactor:0.6}}}),
  mkEdge('mc','inet-sw','#f1c40f',{width:3,arrows:{to:{enabled:true,scaleFactor:0.6}}}),
  mkEdge('dr','inet-sw','#78909c',{width:1,dashes:[6,4]}),
  mkEdge('scopesky','inet-sw','#00bcd4',{width:1,dashes:[4,4]}),
  mkEdge('passport-ss','inet-sw','#00bcd4',{width:1,dashes:[4,4]}),
  mkEdge('asia-local','inet-sw','#00bcd4',{width:1,dashes:[4,4]}),
  mkEdge('zain-m2m','inet-sw','#00bcd4',{width:1,dashes:[4,4]}),
  mkEdge('mc-sw','inet-sw','#3498db',{width:1,label:'P14',font:{color:'#55555599',size:9,background:'rgba(10,14,26,.8)'}}),
  mkEdge('cbi-sw','inet-sw','#3498db',{width:1}),
  mkEdge('inet-sw','core-sw','#3498db',{width:5,label:'Gi5/0/1',font:{color:'#3498db',size:10,background:'rgba(10,14,26,.9)'}}),
  mkEdge('core-sw','pmt-fw1','#e74c3c',{width:4,label:'PORT1',font:{color:'#e74c3c',size:9,background:'rgba(10,14,26,.9)'}}),
  mkEdge('core-sw','pmt-fw2','#e74c3c',{width:4,label:'PORT1',font:{color:'#e74c3c',size:9,background:'rgba(10,14,26,.9)'}}),
  mkHA('pmt-fw1','pmt-fw2','#e74c3c','HA SYNC'),
  mkEdge('pmt-fw1','fp1','#e74c3c',{width:3,label:'Gi1/0/15',font:{color:'#e74c3c',size:9,background:'rgba(10,14,26,.9)'}}),
  mkEdge('pmt-fw2','fp2','#e74c3c',{width:3,label:'Gi1/0/15',font:{color:'#e74c3c',size:9,background:'rgba(10,14,26,.9)'}}),
  mkHA('fp1','fp2','#e74c3c','HA SYNC'),
  mkEdge('fp1','tor1','#3498db',{width:4,label:'Eth1/47',font:{color:'#3498db',size:9,background:'rgba(10,14,26,.9)'}}),
  mkEdge('fp2','tor2','#3498db',{width:4,label:'Eth1/47',font:{color:'#3498db',size:9,background:'rgba(10,14,26,.9)'}}),
  mkHA('tor1','tor2','#3498db','VPC PEER'),
  mkEdge('tor1','palo1','#e67e22',{width:2,label:'Eth1/11',font:{color:'#e67e22',size:9,background:'rgba(10,14,26,.9)'}}),
  mkEdge('tor1','palo2','#e67e22',{width:1}),mkEdge('tor2','palo1','#e67e22',{width:1}),mkEdge('tor2','palo2','#e67e22',{width:2}),
  mkHA('palo1','palo2','#e67e22','HA'),
  mkEdge('tor1','f5-1','#2ecc71',{width:2,label:'Eth1/36',font:{color:'#2ecc71',size:9,background:'rgba(10,14,26,.9)'}}),
  mkEdge('tor2','f5-2','#2ecc71',{width:2,label:'Eth1/36',font:{color:'#2ecc71',size:9,background:'rgba(10,14,26,.9)'}}),
  mkHA('f5-1','f5-2','#2ecc71','HA'),
  mkEdge('tor2','ag1000','#78909c',{width:2}),
  mkEdge('tor1','web-servers','#1abc9c',{width:3}),mkEdge('tor2','web-servers','#1abc9c',{width:2}),
  mkEdge('tor1','db-servers','#e91e63',{width:3}),mkEdge('tor2','db-servers','#e91e63',{width:2}),
  mkEdge('f5-1','web-servers','#2ecc71',{width:2,dashes:[4,4],arrows:{to:{enabled:true,scaleFactor:0.5}}}),
  mkEdge('f5-2','db-servers','#2ecc71',{width:1,dashes:[4,4],arrows:{to:{enabled:true,scaleFactor:0.5}}}),
  mkEdge('tor2','hsm-auth1','#9b59b6',{width:2,label:'Eth1/3',font:{color:'#9b59b6',size:9,background:'rgba(10,14,26,.9)'}}),
  mkEdge('tor2','hsm-auth2','#9b59b6',{width:2}),
  mkEdge('tor2','hsm-acs1','#9b59b6',{width:2,label:'Eth1/4',font:{color:'#9b59b6',size:9,background:'rgba(10,14,26,.9)'}}),
  mkEdge('tor2','hsm-acs2','#9b59b6',{width:2,label:'Eth1/5',font:{color:'#9b59b6',size:9,background:'rgba(10,14,26,.9)'}}),
  mkEdge('tor1','veeam','#78909c',{width:1,label:'Eth1/43',font:{color:'#55555599',size:8,background:'rgba(10,14,26,.9)'}}),
  mkEdge('tor1','olvm','#78909c',{width:1,label:'Eth1/39',font:{color:'#55555599',size:8,background:'rgba(10,14,26,.9)'}}),
  mkEdge('tor1','hv-prod','#78909c',{width:1,label:'Eth1/30',font:{color:'#55555599',size:8,background:'rgba(10,14,26,.9)'}}),
  mkEdge('tor1','hnv03','#78909c',{width:1,label:'Eth1/26',font:{color:'#55555599',size:8,background:'rgba(10,14,26,.9)'}}),
  mkEdge('tor1','perso-fiber','#78909c',{width:1,label:'Eth1/32',font:{color:'#55555599',size:8,background:'rgba(10,14,26,.9)'}}),
  mkEdge('tor2','hnv04','#78909c',{width:1,label:'Eth1/24',font:{color:'#55555599',size:8,background:'rgba(10,14,26,.9)'}}),
  mkEdge('tor1','storeonce-01','#78909c',{width:1,font:{color:'#55555599',size:8,background:'rgba(10,14,26,.9)'}}),
  mkEdge('tor2','storeonce-02','#78909c',{width:1,font:{color:'#55555599',size:8,background:'rgba(10,14,26,.9)'}}),
]);

const visNetwork = new vis.Network(document.getElementById('vis-network'), {nodes:visNodes,edges:visEdges}, {
  physics:{enabled:false},
  interaction:{hover:true,zoomView:true,dragView:true,dragNodes:true,tooltipDelay:200},
  edges:{smooth:{enabled:true,type:'cubicBezier',forceDirection:'horizontal',roundness:0.35},font:{color:'#666',size:9,align:'middle',background:'rgba(8,12,20,.9)',strokeWidth:0},selectionWidth:3},
  nodes:{borderWidth:2},
});

// ── Snapshot default map so we can restore it when switching back to id=0
const _defaultNodes = visNodes.get();
const _defaultEdges = visEdges.get();
const _defaultDeviceData = JSON.parse(JSON.stringify(deviceData));

// ═══════════════════════════════════════════════════════════
//  POS MAP — Built-in combined map (Asia + Zain + Passport)
// ═══════════════════════════════════════════════════════════
const _posmapDeviceData = {
  'pos-asia-wan':     {name:'Asia Link P2P',    role:'WAN / P2P Link — Asia ISP',      ip:'172.22.223.130', type:'wan',      status:'ok', ifaces:['Gig 1/0/7 → InternetSwitch'],              info:{Tunnel:'T7-T2AsiaPri','FGT-WAN-IP':'172.22.223.129',Type:'P2P Leased Line'}},
  'pos-zain-wan':     {name:'Zain Link P2P',    role:'WAN / P2P Link — Zain ISP',      ip:'10.106.23.193',  type:'wan',      status:'ok', ifaces:['Gi1/0/28 → InternetSwitch'],               info:{Tunnel:'T10-T2Zain',  'FGT-WAN-IP':'10.106.23.194', Type:'P2P Leased Line'}},
  'pos-passport-wan': {name:'Passport Link P2P',role:'WAN / P2P Link — Passport ISP',  ip:'172.17.252.9',   type:'wan',      status:'ok', ifaces:['Te1/1/3 → InternetSwitch'],                info:{Tunnel:'T2-SSTTa',    'FGT-WAN-IP':'172.17.252.14', Type:'P2P Leased Line'}},
  'pos-inet-sw':      {name:'Internet Switch',  role:'L3 Edge Switching',               ip:'10.1.0.15',      type:'switch',   status:'ok', ifaces:['Gig 1/0/7 ← Asia','Gi1/0/28 ← Zain','Te1/1/3 ← Passport','Po10 → CoreSwitch'], info:{Model:'Cisco Switch'}},
  'pos-core-sw':      {name:'Core Switch',      role:'L3 Core Distribution',            ip:'10.1.0.5',       type:'switch',   status:'ok', ifaces:['Po10 ← InternetSwitch','Po12 → FGT'],       info:{Model:'Cisco CoreSwitch',VLAN:'POS'}},
  'pos-fgt':          {name:'FGT Edge Firewall',role:'Next-Gen Firewall (Multi-WAN)',   ip:'10.1.0.2',       type:'firewall', status:'ok', ifaces:['UPLINK/Po10 ← CoreSwitch','T7-T2AsiaPri (172.22.223.129)','T10-T2Zain (10.106.23.194)','T2-SSTTa (172.17.252.14)','Port 3 → FTD'], info:{Model:'FortiGate',Tunnels:'Asia / Zain / Passport',Mode:'Multi-WAN'}},
  'pos-ftd':          {name:'FTD',              role:'Firepower Threat Defense IPS',    ip:'10.1.0.4',       type:'firewall', status:'ok', ifaces:['port 3 ← FGT','Eth1/47 → TOR1','vlan20'],     info:{Model:'Cisco FTD'}},
  'pos-tor1':         {name:'TOR 1',            role:'Top-of-Rack Switch',              ip:'10.1.0.7',       type:'switch',   status:'ok', ifaces:['Eth1/47 ← FTD','Eth1/37 → TOR-LAN1','Eth1/40 → F5','Po20 → SVLP / SVFE'], info:{Model:'Cisco Nexus'}},
  'pos-tor-lan1':     {name:'TOR-LAN 1',        role:'TOR LAN Access Switch',           ip:'10.1.0.81',      type:'switch',   status:'ok', ifaces:['Te1/1/1 ← TOR1','→ AG1000'],                 info:{Model:'Cisco Catalyst'}},
  'pos-ag1000':       {name:'AG1000',           role:'Aggregation Router',              ip:'100.64.2.68',    type:'switch',   status:'ok', ifaces:['← TOR-LAN1'],                                info:{Model:'AG1000'}},
  'pos-svlp':         {name:'SVLP',             role:'POS Application Server',          ip:'100.66.0.3',     type:'server',   status:'ok', ifaces:['Po20 ← TOR1'],                               info:{Role:'SVLP'}},
  'pos-f5':           {name:'F5',               role:'Load Balancer',                   ip:'10.1.0.11',      type:'f5',       status:'ok', ifaces:['Eth1/40 ← TOR1'],                            info:{Model:'F5 BIG-IP'}},
  'pos-svfe':         {name:'SVFE',             role:'POS Frontend Application Server', ip:'100.66.0.6',     type:'server',   status:'ok', ifaces:['Po20 ← TOR1'],                               info:{Role:'SVFE'}},
};

const DEFAULT_POS_NODE_HOST_MAP = {
  'pos-inet-sw':      '10785',  // Internet Switch   10.1.0.15
  'pos-core-sw':      '10929',  // Core Switch       10.1.0.5
  'pos-fgt':          '10907',  // FGT Edge FW       10.1.0.2
  'pos-ftd':          '10839',  // FTD               10.1.0.4
  'pos-tor1':         '10898',  // TOR 1             10.1.0.7
  'pos-tor-lan1':     '10901',  // TOR-LAN 1         10.1.0.81
  'pos-ag1000':       '10871',  // AG1000            100.64.2.68
  'pos-svlp':         '10788',  // SVLP              100.66.0.3
  'pos-f5':           '10830',  // F5                10.1.0.11
  'pos-svfe':         '10793',  // SVFE              100.66.0.6
};

function buildPosmapNodes(){
  return [
    // ── WAN / ISP layer (left, spread vertically)
    mkNode('pos-asia-wan',    'Asia Link P2P\n172.22.223.130',   'wan',      -750, -180, {size:24, fontSize:10}),
    mkNode('pos-zain-wan',    'Zain Link P2P\n10.106.23.193',    'wan',      -750,    0, {size:24, fontSize:10}),
    mkNode('pos-passport-wan','Passport Link P2P\n172.17.252.9', 'wan',      -750,  180, {size:24, fontSize:10}),
    // ── Internet Switch
    mkNode('pos-inet-sw',     'Internet Switch\n10.1.0.15',      'switch',   -480,    0, {size:32, fontSize:12}),
    // ── Core Switch
    mkNode('pos-core-sw',     'Core Switch\n10.1.0.5',           'switch',   -220,    0, {size:32, fontSize:12}),
    // ── FortiGate (multi-WAN)
    mkNode('pos-fgt',         'FGT Edge FW\n10.1.0.2',           'firewall',   50,    0, {size:30, fontSize:11}),
    // ── FTD
    mkNode('pos-ftd',         'FTD\n10.1.0.4',                   'firewall',  300,    0, {size:28, fontSize:11}),
    // ── TOR switches
    mkNode('pos-tor1',        'TOR 1\n10.1.0.7',                 'switch',    560, -120, {size:28, fontSize:11}),
    mkNode('pos-tor-lan1',    'TOR-LAN 1\n10.1.0.81',            'switch',    560,  120, {size:28, fontSize:11}),
    // ── End devices
    mkNode('pos-svlp',        'SVLP\n100.66.0.3',                'server',    820, -220, {size:22, fontSize:10}),
    mkNode('pos-f5',          'F5\n10.1.0.11',                   'f5',        820,  -80, {size:22, fontSize:10}),
    mkNode('pos-svfe',        'SVFE\n100.66.0.6',                'server',    820,   80, {size:22, fontSize:10}),
    mkNode('pos-ag1000',      'AG1000\n100.64.2.68',             'switch',    820,  220, {size:22, fontSize:10}),
  ];
}

function buildPosmapEdges(){
  return [
    // ── ISP → InternetSwitch
    mkEdge('pos-asia-wan',    'pos-inet-sw', '#00bcd4', {width:2, label:'Gig 1/0/7',  font:{color:'#00bcd4', size:9, background:'rgba(10,14,26,.9)'}}),
    mkEdge('pos-zain-wan',    'pos-inet-sw', '#00bcd4', {width:2, label:'Gi1/0/28',   font:{color:'#00bcd4', size:9, background:'rgba(10,14,26,.9)'}}),
    mkEdge('pos-passport-wan','pos-inet-sw', '#00bcd4', {width:2, label:'Te1/1/3',    font:{color:'#00bcd4', size:9, background:'rgba(10,14,26,.9)'}}),
    // ── InternetSwitch → CoreSwitch
    mkEdge('pos-inet-sw',  'pos-core-sw', '#3498db', {width:4, label:'Po10', font:{color:'#3498db', size:9, background:'rgba(10,14,26,.9)'}}),
    // ── CoreSwitch → FGT
    mkEdge('pos-core-sw',  'pos-fgt',     '#e74c3c', {width:3, label:'Po12 / FGT-EDG UPLINK', font:{color:'#e74c3c', size:9, background:'rgba(10,14,26,.9)'}}),
    // ── FGT → FTD
    mkEdge('pos-fgt',      'pos-ftd',     '#e74c3c', {width:3, label:'Port 3', font:{color:'#e74c3c', size:9, background:'rgba(10,14,26,.9)'}}),
    // ── FTD → TOR1
    mkEdge('pos-ftd',      'pos-tor1',    '#3498db', {width:4, label:'Eth1/47 / vlan20', font:{color:'#3498db', size:9, background:'rgba(10,14,26,.9)'}}),
    // ── TOR1 → TOR-LAN1
    mkEdge('pos-tor1',     'pos-tor-lan1','#3498db', {width:3, label:'Eth1/37 ↔ Te1/1/1', font:{color:'#3498db', size:9, background:'rgba(10,14,26,.9)'}}),
    // ── TOR-LAN1 → AG1000
    mkEdge('pos-tor-lan1', 'pos-ag1000',  '#78909c', {width:2}),
    // ── TOR1 → SVLP / F5 / SVFE
    mkEdge('pos-tor1',     'pos-svlp',    '#1abc9c', {width:2, label:'Po20',   font:{color:'#1abc9c', size:9, background:'rgba(10,14,26,.9)'}}),
    mkEdge('pos-tor1',     'pos-f5',      '#2ecc71', {width:2, label:'Eth1/40',font:{color:'#2ecc71', size:9, background:'rgba(10,14,26,.9)'}}),
    mkEdge('pos-tor1',     'pos-svfe',    '#1abc9c', {width:2, label:"Po20",   font:{color:'#1abc9c', size:9, background:'rgba(10,14,26,.9)'}}),
  ];
}

// Save positions on drag
visNetwork.on('dragEnd', p => { if(p.nodes.length) savePositions(); });

// ═══════════════════════════════════════════════════════════
//  ZABBIX STATUS — LIVE NODE COLORING + ALARM DOTS
// ═══════════════════════════════════════════════════════════
function updateMapStatus(){
  // Status badges are drawn on the traffic canvas per-frame (follows pan/zoom automatically)
  // Here we only update vis-network border/shadow for extra visual weight
  visNodes.getIds().forEach(nid=>{
    const hostId = S.nodeHostMap[nid];
    if(!hostId) return;

    const host = S.zabbixHosts[hostId];
    if(!host) return;

    const sev  = host.worst_severity || 0;
    const down = host.available == 2 && host.problem_count > 0;
    const nodeType = deviceData[nid]?.type || S.dbNodes[nid]?.type || 'switch';
    const c    = COLORS[nodeType] || COLORS.switch;

    let border, shadow, bw=2;
    if(down)       { border='#FF1744'; shadow='#FF174455'; bw=4; }
    else if(sev>=5){ border='#FF1744'; shadow='#FF174455'; bw=3; }
    else if(sev>=4){ border='#FF6D00'; shadow='#FF6D0055'; bw=3; }
    else if(sev>=3){ border='#FFB300'; shadow='#FFB30055'; bw=2; }
    else if(sev>=1){ border='#78909C'; shadow='#78909C44'; bw=2; }
    else           { border=c.border;  shadow=c.border+'33'; bw=2; }

    visNodes.update({id:nid,
      color:{border,background:'transparent',highlight:{border:'#00d4ff'}},
      shadow:{enabled:true,color:shadow,size:down?28:sev>=4?20:10,x:0,y:0},
      borderWidth:bw});
  });
  updateEdgeStatus();
}

// ── EDGE LINK-DOWN STATUS ────────────────────────────────
function updateEdgeStatus(){
  visEdges.getIds().forEach(eid=>{
    const e = visEdges.get(eid);
    const fromHost = S.zabbixHosts[S.nodeHostMap[e.from]];
    const toHost   = S.zabbixHosts[S.nodeHostMap[e.to]];
    if(!fromHost && !toHost) return; // neither end mapped, skip
    const down   = (fromHost?.available==2 && (fromHost?.problem_count||0)>0) || (toHost?.available==2 && (toHost?.problem_count||0)>0);
    const maxSev = Math.max(fromHost?.worst_severity||0, toHost?.worst_severity||0);
    if(down){
      visEdges.update({id:eid,color:{color:'#FF1744',opacity:0.9},dashes:[6,4],width:2});
    } else if(maxSev>=4){
      visEdges.update({id:eid,color:{color:'#FF6D00',opacity:0.85},dashes:[4,3],width:1.5});
    } else if(maxSev>=3){
      visEdges.update({id:eid,color:{color:'#FFB300',opacity:0.7},dashes:false,width:1});
    } else {
      // restore original color
      visEdges.update({id:eid,color:{color:e._origColor||'#1e3a5f',opacity:0.85},dashes:false,width:1});
    }
  });
}

// Update alarm dots on pan/zoom too
visNetwork.on('zoom',  updateMapStatus);
visNetwork.on('dragEnd', e=>{ if(!e.nodes.length) updateMapStatus(); });

// ═══════════════════════════════════════════════════════════
//  LIVE DATA REFRESH
// ═══════════════════════════════════════════════════════════
let refreshSeq = 0;
async function refreshData(){
  const t0 = Date.now();
  try{
    const mapIds = [...S.currentMapHostIds];
    const qs = mapIds.length ? '?' + mapIds.map(h=>'hostids='+encodeURIComponent(h)).join('&') : '';
    const data = await api('/api/zabbix/status'+qs);
    if(!data) return;

    // Build host lookup
    S.zabbixHosts = {};
    (data.hosts||[]).forEach(h=>{ S.zabbixHosts[h.hostid]=h; });
    S.zabbixProblems = data.problems || [];
    S.allHosts = data.hosts || [];

    // Update header stats
    const c = data.counts||{};
    document.getElementById('sc-total').textContent  = c.total||0;
    document.getElementById('sc-ok').textContent     = c.ok||0;
    document.getElementById('sc-prob').textContent   = c.with_problems||0;
    document.getElementById('sc-alarms').textContent = c.alarms||0;

    // Alarm badge
    const badge = document.getElementById('alarm-badge');
    if(c.alarms>0){
      badge.textContent = c.alarms>99?'99+':c.alarms;
      badge.classList.remove('hidden');
      badge.classList.toggle('badge-blink', c.alarms>0);
    } else {
      badge.classList.add('hidden');
    }

    S.lastRefreshTs = new Date();
    document.getElementById('refresh-info').textContent = 'Updated '+S.lastRefreshTs.toLocaleTimeString();

    // Update map colors + edge status
    updateMapStatus();

    // Update floating map alarm panel
    renderMapAlarmPanel();

    // If on alarms page, re-fetch fresh data; if on hosts page, re-render
    if(document.querySelector('.nav-item.active').dataset.page === 'alarms') refreshAlarms();
    if(document.querySelector('.nav-item.active').dataset.page === 'hosts')  renderHosts();

  }catch(e){
    document.getElementById('refresh-info').textContent = 'Connection error';
  }
}

function startRefresh(){
  refreshData();
  if(S.refreshTimer) clearInterval(S.refreshTimer);
  S.refreshTimer = setInterval(refreshData, S.refreshInterval);
}

// ═══════════════════════════════════════════════════════════
//  TOOLTIP
// ═══════════════════════════════════════════════════════════
const tip = document.getElementById('vis-tip');
visNetwork.on('hoverNode', p=>{
  const d = {...(deviceData[p.node]||{}), ...(S.dbNodes[p.node]||{})};
  if(!d.name) return;
  document.getElementById('tip-name').textContent = d.name;
  document.getElementById('tip-ip').textContent   = d.ip||'';
  document.getElementById('tip-role').textContent = d.role||'';
  const hid = S.nodeHostMap[p.node];
  const host = hid && S.zabbixHosts[hid];
  const ta = document.getElementById('tip-alarm');
  if(host && host.problem_count>0){
    ta.textContent = `⚠ ${host.problem_count} active problem${host.problem_count>1?'s':''}`;
    ta.style.display='block';
  } else { ta.style.display='none'; }
  tip.style.display='block';
});
visNetwork.on('blurNode', ()=>{ tip.style.display='none'; });
// Passive + RAF-throttled tooltip movement — never blocks the main thread
let _tipX=0,_tipY=0,_tipRaf=null;
document.addEventListener('mousemove', e=>{ _tipX=e.clientX; _tipY=e.clientY;
  if(!_tipRaf) _tipRaf=requestAnimationFrame(()=>{ tip.style.left=(_tipX+14)+'px'; tip.style.top=(_tipY+14)+'px'; _tipRaf=null; });
},{passive:true});

// ═══════════════════════════════════════════════════════════
//  DETAIL PANEL
// ═══════════════════════════════════════════════════════════
const typeEmoji={external:'🌐',wan:'📡',switch:'🔀',firewall:'🛡️',palo:'🔥',f5:'⚖️',server:'🖥️',dbserver:'🗄️',hsm:'🔐',infra:'🏗️'};
const typeColors={external:'#f1c40f',wan:'#00bcd4',switch:'#3498db',firewall:'#e74c3c',palo:'#e67e22',f5:'#2ecc71',server:'#1abc9c',dbserver:'#e91e63',hsm:'#9b59b6',infra:'#78909c'};
let panelNodeId = null;

visNetwork.on('click', p=>{
  if(p.nodes.length){ showPanel(p.nodes[0]); }
  else { closePanel(); }
});

function showPanel(nid){
  panelNodeId = nid;
  const d = {...(deviceData[nid]||{}), ...(S.dbNodes[nid]||{})};
  const col   = typeColors[d.type]||'#3498db';
  const emoji = typeEmoji[d.type]||'💻';

  // Zabbix host data
  const hostId = S.nodeHostMap[nid];
  const host   = hostId ? S.zabbixHosts[hostId] : null;

  const sClass = {ok:'pill-ok',warn:'pill-warn',crit:'pill-crit',info:'pill-info'}[d.status]||'pill-info';
  const sLabel = {ok:'ONLINE',warn:'WARNING',crit:'CRITICAL',info:'INFO'}[d.status]||'UNKNOWN';

  let zbxHtml = '';
  if(host){
    const avail = host.available==1?'<span class="sev-pill pill-ok">● AVAILABLE</span>':host.available==2&&host.problem_count>0?'<span class="sev-pill pill-down">✗ UNREACHABLE</span>':'<span class="sev-pill pill-info">? UNKNOWN</span>';
    zbxHtml = `<div class="info-section">
      <div class="info-sec-title">🔵 Zabbix Live</div>
      <div class="info-row"><span class="info-key">Availability</span><span class="info-val">${avail}</span></div>
      <div class="info-row"><span class="info-key">Active Problems</span><span class="info-val" style="color:${host.problem_count>0?'var(--red)':'var(--green)'}">${host.problem_count}</span></div>
      ${host.problem_count>0?`<div class="info-row"><span class="info-key">Worst Severity</span><span class="info-val">${SEV[host.worst_severity]?.icon||''} ${SEV[host.worst_severity]?.label||''}</span></div>`:''}
      ${(host.problems||[]).slice(0,4).map(pr=>`<div class="info-row" style="background:${SEV[pr.severity]?.bg||''}"><span class="info-key" style="color:${SEV[pr.severity]?.color||'#fff'}">${SEV[pr.severity]?.icon||''} ${pr.name}</span></div>`).join('')}
    </div>`;
  }

  let infoHtml = Object.entries(d.info||{}).map(([k,v])=>`<div class="info-row"><span class="info-key">${k}</span><span class="info-val">${v}</span></div>`).join('');
  let ifaceHtml = (d.ifaces||[]).map(i=>`<span class="iface-tag">${i}</span>`).join('');

  document.getElementById('dp-body').innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
      <div style="width:44px;height:44px;border-radius:10px;background:${col}22;border:1px solid ${col}44;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">${emoji}</div>
      <div><div style="font-size:14px;font-weight:700;color:#fff">${d.name||nid}</div><div style="font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace">${d.role||''}</div></div>
    </div>
    ${zbxHtml}
    <div class="info-section">
      <div class="info-sec-title">Network</div>
      <div class="info-row"><span class="info-key">IP</span><span class="info-val" style="color:var(--cyan)">${d.ip||'—'}</span></div>
      <div class="info-row"><span class="info-key">Type</span><span class="info-val">${d.type||'—'}</span></div>
      <div class="info-row"><span class="info-key">Status</span><span class="info-val"><span class="sev-pill ${sClass}">${sLabel}</span></span></div>
      ${hostId?`<div class="info-row"><span class="info-key">Zabbix ID</span><span class="info-val" style="color:var(--cyan)">${hostId}</span></div>`:''}
    </div>
    ${infoHtml?`<div class="info-section"><div class="info-sec-title">Config</div>${infoHtml}</div>`:''}
    ${ifaceHtml?`<div class="info-section"><div class="info-sec-title">Interfaces</div><div style="margin-top:4px">${ifaceHtml}</div></div>`:''}
    ${hostId?`<div class="info-section" id="dp-perf-section">
      <div class="info-sec-title">Performance (1h)</div>
      <div id="dp-graphs" style="display:flex;flex-direction:column;gap:8px;margin-top:6px">
        <div style="color:var(--muted);font-size:11px;text-align:center;padding:8px 0">Loading…</div>
      </div>
    </div>`:''}
  `;

  if(hostId) loadPanelGraphs(hostId);

  document.getElementById('dp-footer').style.display='flex';
  const canEdit=S.myRole!=='viewer';
  const canDelete=S.myRole==='admin';
  document.getElementById('dp-footer').innerHTML=`
    ${canEdit?`<button class="btn btn-ghost" style="flex:1" onclick="showEditPanel('${nid}')"><i data-lucide="pencil" style="width:12px;height:12px;vertical-align:-1px"></i> Edit</button>`:''}
    <button class="btn btn-primary" style="flex:1;background:linear-gradient(135deg,#6366f1,#8b5cf6);border-color:transparent" onclick="openHostChat('${nid}')"><i data-lucide="bot" style="width:12px;height:12px;vertical-align:-1px"></i> Ask AI</button>
    ${canDelete?`<button class="btn btn-danger" onclick="deleteNode('${nid}')"><i data-lucide="trash-2" style="width:12px;height:12px"></i></button>`:''}
  `;
  lucide.createIcons();
  document.getElementById('detail-panel').classList.add('open');
}

function showEditPanel(nid){
  const d = {...(deviceData[nid]||{}), ...(S.dbNodes[nid]||{})};
  const hostId = S.nodeHostMap[nid]||'';
  document.getElementById('dp-title').textContent='Edit Device';
  const ifStr = (d.ifaces||[]).join('\n');
  const infoStr = Object.entries(d.info||{}).map(([k,v])=>`${k}: ${v}`).join('\n');
  const sopts=['ok','warn','crit','info'].map(s=>`<option value="${s}"${d.status===s?' selected':''}>${{ok:'● ONLINE',warn:'⚠ WARNING',crit:'✗ CRITICAL',info:'ℹ INFO'}[s]}</option>`).join('');
  const topts=['external','wan','switch','firewall','palo','f5','server','dbserver','hsm','infra'].map(t=>`<option value="${t}"${d.type===t?' selected':''}>${t}</option>`).join('');

  document.getElementById('dp-body').innerHTML=`
    <div class="ef"><label>Name</label><input class="edit-inp" id="e-name" value="${d.name||''}"></div>
    <div class="ef"><label>IP Address</label><input class="edit-inp" id="e-ip" value="${d.ip||''}"></div>
    <div class="ef"><label>Role</label><input class="edit-inp" id="e-role" value="${d.role||''}"></div>
    <div class="ef-row">
      <div class="ef"><label>Status</label><select class="edit-inp" id="e-status">${sopts}</select></div>
      <div class="ef"><label>Type</label><select class="edit-inp" id="e-type">${topts}</select></div>
    </div>
    <div class="ef"><label>Zabbix Host ID (links live data)</label><input class="edit-inp" id="e-zbxid" value="${hostId}" placeholder="e.g. 10084"></div>
    <div class="ef"><label>Interfaces (one per line)</label><textarea class="edit-inp" id="e-ifaces" rows="3">${ifStr}</textarea></div>
    <div class="ef"><label>Config (Key: Value per line)</label><textarea class="edit-inp" id="e-info" rows="3">${infoStr}</textarea></div>
  `;
  document.getElementById('dp-footer').innerHTML=`
    <button class="btn btn-ghost" style="flex:1" onclick="showPanel('${nid}')">Cancel</button>
    <button class="btn btn-primary" style="flex:1" onclick="saveNodeEdit('${nid}')">Save</button>
  `;
  // Inline edit styles
  document.querySelectorAll('.edit-inp').forEach(el=>{
    el.style.cssText='width:100%;background:#111d35;border:1px solid #1e2d4a;border-radius:6px;padding:7px 10px;color:#fff;font-size:11px;font-family:JetBrains Mono,monospace;outline:none;transition:border-color .15s;box-sizing:border-box;';
    el.addEventListener('focus',()=>el.style.borderColor='#00d4ff');
    el.addEventListener('blur', ()=>el.style.borderColor='#1e2d4a');
  });
}

async function saveNodeEdit(nid){
  const name   = document.getElementById('e-name').value.trim() || nid;
  const ip     = document.getElementById('e-ip').value.trim();
  const role   = document.getElementById('e-role').value.trim();
  const status = document.getElementById('e-status').value;
  const type   = document.getElementById('e-type').value;
  const zbxid  = document.getElementById('e-zbxid').value.trim();
  const ifaces = document.getElementById('e-ifaces').value.split('\n').map(s=>s.trim()).filter(Boolean);
  const info   = {};
  document.getElementById('e-info').value.split('\n').forEach(l=>{
    const i=l.indexOf(':'); if(i>0) info[l.slice(0,i).trim()]=l.slice(i+1).trim();
  });

  // Update state
  const existing = deviceData[nid]||{};
  const updated = {...existing,name,ip,role,status,type,ifaces,info};
  S.dbNodes[nid] = updated;
  if(zbxid){ S.nodeHostMap[nid]=zbxid; } else { delete S.nodeHostMap[nid]; }

  // Update vis label
  const showIp = ip && !['External','Internal','Remote','Private','Unknown',''].includes(ip);
  visNodes.update({id:nid, label:name+(showIp?'\n'+ip:'')});

  // Save to DB
  const pos = visNetwork.getPosition(nid);
  await api('/api/nodes',{method:'POST',body:JSON.stringify({
    id:nid, label:name+(showIp?'\n'+ip:''), ip, role, type,
    x:pos.x, y:pos.y, status, ifaces, info, zabbix_host_id:zbxid||null,
    layer_key: layerKeyFromX(pos.x),
  })});

  saveNodeHostMap();
  updateMapStatus();
  showPanel(nid);
}

function closePanel(){
  document.getElementById('detail-panel').classList.remove('open');
  document.getElementById('dp-title').textContent='Device Details';
  panelNodeId=null;
}

// ═══════════════════════════════════════════════════════════
//  ADD / DELETE NODES
// ═══════════════════════════════════════════════════════════
function openAddModal(){ document.getElementById('add-modal').classList.add('open'); document.getElementById('add-label').focus(); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

function layerKeyFromX(x){
  const keys=Object.keys(LX);
  return keys.reduce((best,k)=>Math.abs(LX[k]-x)<Math.abs(LX[best]-x)?k:best, keys[0]);
}

function getNextY(lk){
  const x=LX[lk]||LX.srv;
  const layerNodes=visNodes.get().filter(n=>Math.abs(n.x-x)<20);
  if(!layerNodes.length) return 0;
  return Math.max(...layerNodes.map(n=>n.y||0))+120;
}

async function submitAddNode(){
  const label  = document.getElementById('add-label').value.trim(); if(!label){alert('Label required');return;}
  const ip     = document.getElementById('add-ip').value.trim()||'Unknown';
  const role   = document.getElementById('add-role').value.trim()||'Custom Node';
  const type   = document.getElementById('add-type').value;
  const lk     = document.getElementById('add-layer').value;
  const status = document.getElementById('add-status').value;
  const ifaces = document.getElementById('add-ifaces').value.split('\n').map(s=>s.trim()).filter(Boolean);
  const zbxid  = document.getElementById('add-zbxid').value.trim();

  const id  = 'custom_'+Date.now();
  const x   = LX[lk]||LX.srv;
  const y   = getNextY(lk);
  const lbl = label+(ip!=='Unknown'?'\n'+ip:'');

  visNodes.add(mkNode(id,lbl,type,x,y,{size:22,fontSize:10}));
  deviceData[id]={name:label,ip,role,type,status,ifaces,info:{}};
  if(zbxid) S.nodeHostMap[id]=zbxid;

  await api('/api/nodes',{method:'POST',body:JSON.stringify({
    id,label:lbl,ip,role,type,layer_key:lk,x,y,status,ifaces,info:{},zabbix_host_id:zbxid||null,
  })});
  saveNodeHostMap();
  closeModal('add-modal');
  ['add-label','add-ip','add-role','add-ifaces','add-zbxid'].forEach(i=>document.getElementById(i).value='');
  showPanel(id);
}

async function deleteNode(nid){
  if(!confirm(`Delete node "${deviceData[nid]?.name||nid}"? This removes all its connections.`)) return;
  visEdges.remove(visNetwork.getConnectedEdges(nid));
  visNodes.remove(nid);
  delete deviceData[nid]; delete S.dbNodes[nid]; delete S.nodeHostMap[nid];
  await api(`/api/nodes?id=${nid}`,{method:'DELETE'});
  saveNodeHostMap();
  closePanel();
}

// ═══════════════════════════════════════════════════════════
//  LAYOUT SAVE / LOAD
// ═══════════════════════════════════════════════════════════
function savePositions(){
  const pos=visNetwork.getPositions();
  localStorage.setItem('tab_positions',JSON.stringify(pos));
  // Persist to DB for custom nodes
  const updates = Object.entries(pos)
    .filter(([id])=>id.startsWith('custom_')||S.dbNodes[id])
    .map(([id,p])=>({id,x:p.x,y:p.y}));
  if(updates.length) api('/api/nodes',{method:'PATCH',body:JSON.stringify(updates)});
}

function loadSavedPositions(){
  const raw=localStorage.getItem('tab_positions');
  if(!raw) return;
  const pos=JSON.parse(raw);
  const updates=Object.entries(pos).filter(([id])=>visNodes.get(id)).map(([id,p])=>({id,x:p.x,y:p.y}));
  if(updates.length) visNodes.update(updates);
}

function saveLayoutPrompt(){ document.getElementById('layout-modal').classList.add('open'); document.getElementById('layout-name').focus(); }

async function submitSaveLayout(){
  const name=document.getElementById('layout-name').value.trim(); if(!name){alert('Name required');return;}
  const isDefault=document.getElementById('layout-default').checked;
  const positions=visNetwork.getPositions();
  await api('/api/layout',{method:'POST',body:JSON.stringify({name,positions,is_default:isDefault})});
  closeModal('layout-modal');
  document.getElementById('layout-name').value='';
  if(document.querySelector('.nav-item.active').dataset.page==='settings') loadLayouts();
}

async function loadLayouts(){
  const rows=await api('/api/layout')||[];
  const el=document.getElementById('layouts-list');
  if(!rows.length){el.innerHTML='<div style="color:var(--muted);font-size:12px">No saved layouts yet.</div>';return;}
  el.innerHTML=rows.map(r=>`
    <div class="layout-row">
      <span class="layout-name">${r.name}${r.is_default?'<span style="color:var(--cyan);font-size:9px;margin-left:6px">DEFAULT</span>':''}</span>
      <span class="layout-date">${new Date(r.created_at).toLocaleDateString()}</span>
      <button class="btn btn-ghost" style="padding:4px 10px;font-size:10px" onclick="applyLayout(${r.id})">Load</button>
      <button class="btn btn-danger" style="padding:4px 8px;font-size:10px" onclick="deleteLayout(${r.id},this)">✕</button>
    </div>`).join('');
}

async function applyLayout(id){
  const row=await api(`/api/layout?id=${id}`);
  if(!row||!row.positions) return;
  const updates=Object.entries(row.positions).filter(([id])=>visNodes.get(id)).map(([id,p])=>({id,x:p.x,y:p.y}));
  if(updates.length){ visNodes.update(updates); visNetwork.fit({animation:{duration:500}}); }
}

async function deleteLayout(id,btn){
  if(!confirm('Delete this layout?')) return;
  await api(`/api/layout/${id}`,{method:'DELETE'});
  btn.closest('.layout-row').remove();
}

function resetLayout(){
  localStorage.removeItem('tab_positions');
  location.reload();
}

// ═══════════════════════════════════════════════════════════
//  NODE-HOST MAP PERSISTENCE
// ═══════════════════════════════════════════════════════════
function saveNodeHostMap(){
  localStorage.setItem('tab_nhm',JSON.stringify(S.nodeHostMap));
}
// Default node → Zabbix host mappings (verified against zabbix.tabadul.iq)
const DEFAULT_NODE_HOST_MAP = {
  'visa':         '10972',  // VISA Network      185.76.35.129
  'mc':           '10833',  // MasterCard        10.92.46.55
  'cbi':          '10922',  // CBI               172.29.222.10
  'isp':          '10906',  // ISP Uplink        204.106.240.53
  'scopesky':     '10906',  // ScopeSky-Public   204.106.240.53
  'passport-ss':  '10848',  // PassPort LocalSS  10.130.200.103
  'asia-local':   '10861',  // Asia Local        172.22.223.130
  'zain-m2m':     '11124',  // Zain M2M          151.236.160.30
  'dr':           '10900',  // DR-Monitor        100.127.40.2
  'inet-sw':      '10785',  // INT-SW            10.1.0.15
  'core-sw':      '10929',  // CoreSwitch        10.1.0.5
  'pmt-fw1':      '10907',  // Fortigate FW      10.1.0.2
  'pmt-fw2':      '11108',  // Fortigate FW 2    10.1.0.3
  'fp1':          '10839',  // FTD-1 (Firepower) 10.1.0.4
  'fp2':          '10840',  // FTD-2             10.1.0.6
  'tor1':         '10898',  // Tor-1             10.1.0.7
  'tor2':         '10899',  // Tor-2             10.1.0.8
  'palo1':        '10832',  // PA-1              10.1.0.13
  'palo2':        '10831',  // PA-2              10.1.0.14
  'f5-1':         '10830',  // F5-1              10.1.0.11
  'f5-2':         '10829',  // F5-2              10.1.0.12
  'ag1000':       '10871',  // AG-01 (AG1000)    100.64.2.68
  'hsm-auth1':    '10875',  // HSM-Auth-1        100.66.0.122
  'hsm-auth2':    '10876',  // HSM-Auth-2        100.66.0.123
  'hsm-acs1':     '10877',  // HSM-ACS-1         100.66.0.124
  'hsm-acs2':     '10878',  // HSM-ACS-2         100.66.0.125
  'veeam':        '10841',  // ITP-e01-veeam     100.65.0.247
  'olvm':         '10776',  // MGM - OLVM        10.1.0.25
  'hv-prod':      '10778',  // MGM-HVN-PROD01    10.1.0.21
  'storeonce-01': '11088',  // StoreOnce-01      100.64.2.43
  'storeonce-02': '11089',  // StoreOnce-02      100.64.2.44
};

function loadNodeHostMap(){
  const raw=localStorage.getItem('tab_nhm');
  const stored = raw ? JSON.parse(raw) : {};
  // Merge: defaults first, then stored (stored values override defaults)
  S.nodeHostMap = {...DEFAULT_NODE_HOST_MAP, ...stored};
  // Persist merged result so future saves include defaults
  localStorage.setItem('tab_nhm', JSON.stringify(S.nodeHostMap));
}

// ═══════════════════════════════════════════════════════════
//  LAYER FILTER / SEARCH
// ═══════════════════════════════════════════════════════════
// Layer configs per map context
const LAYER_CONFIGS = {
  default: [
    {key:'all',       label:'ALL'},
    {key:'external',  label:'External'},
    {key:'switching', label:'Switching'},
    {key:'firewall',  label:'Firewalls'},
    {key:'loadbalancer',label:'LB/FW'},
    {key:'servers',   label:'Servers'},
    {key:'hsm',       label:'HSM'},
  ],
  'Tabadul Servers Infra': [
    {key:'all',        label:'ALL'},
    {key:'storage',    label:'Storage'},
    {key:'fabric',     label:'Fabric'},
    {key:'servers',    label:'Servers'},
    {key:'production', label:'Production'},
    {key:'corporate',  label:'Corporate'},
  ],
  'POS MAP': [
    {key:'all',       label:'ALL'},
    {key:'switching', label:'Switching'},
    {key:'servers',   label:'Servers'},
    {key:'external',  label:'External'},
  ],
};

// Production cluster node IDs in the infra map
const _PROD_IDS=new Set(['infra_zabbix','infra_olvm','infra_hv_prod1','infra_hv_prod2','infra_perso','infra_uat_olvm','infra_san_sw1','infra_san_sw2','infra_san1','infra_san2','infra_nas1','infra_commvault','infra_tor_sw1','infra_tor_sw2']);
const _CORP_IDS=new Set(['infra_vcenter','infra_esxi1','infra_esxi2','infra_esxi3','infra_sap_uat','infra_corp_sw1','infra_corp_sw2','infra_ag1000_1','infra_ag1000_2','infra_dell_emc','infra_tape','infra_nas2']);

function renderLayerButtons(){
  const cfg=LAYER_CONFIGS[S.currentMapName]||LAYER_CONFIGS.default;
  const el=document.getElementById('layer-btns');
  if(!el) return;
  el.innerHTML=cfg.map((b,i)=>
    `<button class="tb-btn${i===0?' active':''}" onclick="filterLayer('${b.key}',this)">${b.label}</button>`
  ).join('');
  // Show/hide the layer rail only for default map
  const rail=document.getElementById('layer-rail');
  if(rail) rail.style.display=S.currentMapId===0?'':'none';
}

function filterLayer(layer,btn){
  document.querySelectorAll('#layer-btns .tb-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const showAll=()=>{ visNodes.getIds().forEach(id=>visNodes.update({id,hidden:false,opacity:1})); visEdges.getIds().forEach(id=>visEdges.update({id,hidden:false})); };
  if(layer==='all'){ showAll(); return; }
  // Special ID-based filters for infra map
  if(layer==='production'){ visNodes.get().forEach(n=>{ const v=_PROD_IDS.has(n.id); visNodes.update({id:n.id,hidden:!v,opacity:v?1:0.1}); }); return; }
  if(layer==='corporate'){  visNodes.get().forEach(n=>{ const v=_CORP_IDS.has(n.id); visNodes.update({id:n.id,hidden:!v,opacity:v?1:0.1}); }); return; }
  // Type-based filters
  const m={external:['external','wan'],switching:['switch'],firewall:['firewall'],loadbalancer:['palo','f5'],servers:['server','dbserver','infra'],hsm:['hsm'],storage:['storage'],fabric:['switch','endpoint']};
  const show=m[layer]||[];
  visNodes.get().forEach(n=>{ const d=deviceData[n.id]; const v=d&&show.includes(d.type); visNodes.update({id:n.id,hidden:!v,opacity:v?1:0.1}); });
}

function searchNode(q){
  if(!q.trim()){visNodes.get().forEach(n=>visNodes.update({id:n.id,opacity:1}));return;}
  q=q.toLowerCase();
  visNodes.get().forEach(n=>{
    const d=deviceData[n.id];
    const m=n.id.includes(q)||d?.name?.toLowerCase().includes(q)||d?.ip?.toLowerCase().includes(q)||d?.role?.toLowerCase().includes(q);
    visNodes.update({id:n.id,opacity:m?1:0.1});
  });
}

// ═══════════════════════════════════════════════════════════
//  ALARMS PAGE
// ═══════════════════════════════════════════════════════════
async function refreshAlarms(){
  const params=[];
  if(S.currentAlarmFilter>=0) params.push('severity='+S.currentAlarmFilter);
  const mapIds=[...S.currentMapHostIds];
  mapIds.forEach(h=>params.push('hostids='+encodeURIComponent(h)));
  const probs=await api('/api/zabbix/problems'+(params.length?'?'+params.join('&'):''))||[];
  S.allProblems=probs;
  renderAlarms();
}

function filterAlarms(sev,btn){
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  S.currentAlarmFilter=sev;
  refreshAlarms();
}

function timeDiff(ts){
  const d=Math.floor((Date.now()/1000)-ts);
  if(d<60) return d+'s';
  if(d<3600) return Math.floor(d/60)+'m';
  if(d<86400) return Math.floor(d/3600)+'h '+Math.floor((d%3600)/60)+'m';
  return Math.floor(d/86400)+'d '+Math.floor((d%86400)/3600)+'h';
}

function renderAlarms(){
  let probs = S.allProblems;
  // Filter to current map's hosts only
  if(S.currentMapHostIds.size>0){
    probs=probs.filter(p=>{
      const ids=(p.host_ids||[]).concat((p.hosts||[]).map(h=>h.hostid));
      return ids.some(hid=>S.currentMapHostIds.has(hid));
    });
  }
  if(S.currentAlarmFilter==='unack') probs=probs.filter(p=>p.acknowledged=='0');
  else if(S.currentAlarmFilter>=0)   probs=probs.filter(p=>(p.severity||p.priority)==S.currentAlarmFilter);

  const tbody=document.getElementById('alarms-tbody');
  if(!probs.length){
    tbody.innerHTML=`<tr><td colspan="8" class="empty-state" style="color:var(--green)">✓ No active alarms</td></tr>`;
    return;
  }

  tbody.innerHTML=probs.map(p=>{
    const sv=parseInt(p.severity||p.priority||0);
    const s=SEV[sv]||SEV[0];
    const acked=p.acknowledged=='1';
    const hosts=(p.hosts||[]).map(h=>h.name||h.host).join(', ')||'—';
    const since=new Date(p.clock*1000).toLocaleString();
    return `<tr style="border-left:4px solid ${s.color};background:${s.bg}">
      <td style="width:4px;padding:0;background:${s.color}"></td>
      <td><span style="color:${s.color};font-weight:700;font-size:11px;font-family:'JetBrains Mono',monospace">${s.icon} ${s.label}</span></td>
      <td><span class="alarm-host">${hosts}</span></td>
      <td><span class="alarm-name">${p.name||p.trigger_desc||'—'}</span></td>
      <td><span class="duration">${timeDiff(p.clock)}</span></td>
      <td><span class="duration">${since}</span></td>
      <td><span class="sev-pill ${acked?'pill-ok':'pill-crit'}" style="font-size:9px">${acked?'✓ ACK':'OPEN'}</span></td>
      <td>${!acked?`<button class="ack-btn" onclick="ackAlarm('${p.eventid}',this)">Acknowledge</button>`:''}</td>
    </tr>`;
  }).join('');
}

async function ackAlarm(eventid,btn){
  btn.textContent='Acking...'; btn.disabled=true;
  await api('/api/zabbix/acknowledge',{method:'POST',body:JSON.stringify({eventid,message:'Acknowledged via Tabadul NOC'})});
  btn.closest('tr').querySelector('.sev-pill').className='sev-pill pill-ok';
  btn.closest('tr').querySelector('.sev-pill').textContent='✓ ACK';
  btn.remove();
}

// ═══════════════════════════════════════════════════════════
//  HOSTS PAGE
// ═══════════════════════════════════════════════════════════
function renderHostCard(h){
  const sv=h.worst_severity||0;
  const down=h.available==2 && h.problem_count>0;
  const s=SEV[sv]||SEV[0];
  const stripe=down?'#FF1744':sv>=1?s.color:'#00e676';
  const cls=['host-card', h.problem_count>0?'has-problems':'', sv>=5?'has-disaster':'', down?'unavailable':''].filter(Boolean).join(' ');
  const badge=h.problem_count>0?`<span class="problem-badge${sv<=3?' avg':sv===4?' warn':''}">${h.problem_count} ${sv>=5?'💀':sv>=4?'🔴':sv>=3?'🟠':'⚠'}</span>`:`<span class="sev-pill pill-ok" style="font-size:9px">✓ OK</span>`;
  const avail=down?`<span style="color:var(--red);font-size:9px;font-family:'JetBrains Mono',monospace">✗ UNREACHABLE</span>`:h.available==1?`<span style="color:var(--green);font-size:9px;font-family:'JetBrains Mono',monospace">● AVAILABLE</span>`:h.available==2?`<span style="color:var(--muted);font-size:9px;font-family:'JetBrains Mono',monospace">? UNKNOWN</span>`:'';
  return `<div class="${cls}" onclick="highlightHostOnMap('${h.hostid}')">
    <div class="hc-top-stripe" style="background:${stripe}"></div>
    <div class="hc-name">${h.name||h.host}</div>
    <div class="hc-ip">${h.ip||'No IP'}</div>
    <div class="hc-bottom">${avail}${badge}</div>
  </div>`;
}

function renderHosts(){
  let hosts=[...S.allHosts];
  // Filter to current map's hosts only
  if(S.currentMapHostIds.size>0) hosts=hosts.filter(h=>S.currentMapHostIds.has(h.hostid));
  const q=S.hostSearchQ.toLowerCase();
  if(q) hosts=hosts.filter(h=>(h.name||h.host).toLowerCase().includes(q)||h.ip?.includes(q));
  if(S.hostFilterMode==='problems') hosts=hosts.filter(h=>h.problem_count>0);
  if(S.hostFilterMode==='ok')       hosts=hosts.filter(h=>h.problem_count===0&&h.available==1);
  if(S.hostFilterMode==='down')     hosts=hosts.filter(h=>h.available==2);

  const grid=document.getElementById('hosts-grid');
  if(!hosts.length){grid.innerHTML='<div class="empty-state">No hosts found.</div>';return;}

  // Group by map
  const groupMap={};
  hosts.forEach(h=>{
    const info=S.hostMapIndex[h.hostid];
    const key=info?info.mapId:'__other__';
    const name=info?info.mapName:'Other';
    if(!groupMap[key]) groupMap[key]={name,mapId:key,hosts:[]};
    groupMap[key].hosts.push(h);
  });

  // Sort groups: problems first, then by name; "Other" always last
  const groups=Object.values(groupMap).sort((a,b)=>{
    if(a.mapId==='__other__') return 1;
    if(b.mapId==='__other__') return -1;
    const ap=a.hosts.reduce((s,h)=>s+h.problem_count,0);
    const bp=b.hosts.reduce((s,h)=>s+h.problem_count,0);
    return bp-ap||a.name.localeCompare(b.name);
  });

  grid.innerHTML=groups.map(g=>{
    const totalProbs=g.hosts.reduce((s,h)=>s+h.problem_count,0);
    const hasDown=g.hosts.some(h=>h.available==2&&h.problem_count>0);
    const statusDot=totalProbs>0?`<span style="color:var(--red)">●</span>`:hasDown?`<span style="color:var(--orange)">●</span>`:`<span style="color:var(--green)">●</span>`;
    const sortedHosts=g.hosts.sort((a,b)=>b.worst_severity-a.worst_severity||b.problem_count-a.problem_count);
    return `<div class="host-group">
      <div class="host-group-header">
        ${statusDot}
        <span class="host-group-title">🗺 ${g.name}</span>
        <span class="host-group-meta">
          ${g.hosts.length} host${g.hosts.length!==1?'s':''}
          ${totalProbs>0?`<span class="problem-badge" style="font-size:9px;padding:1px 6px">${totalProbs} alarm${totalProbs!==1?'s':''}</span>`:''}
        </span>
      </div>
      <div class="host-group-grid">${sortedHosts.map(renderHostCard).join('')}</div>
    </div>`;
  }).join('');
}

function filterHosts(q){ S.hostSearchQ=q; renderHosts(); }
function hostFilter(mode,btn){
  S.hostFilterMode=mode;
  document.querySelectorAll('#page-hosts .filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderHosts();
}

function highlightHostOnMap(hostId){
  navigate('map');
  // Find node linked to this host
  const nid=Object.keys(S.nodeHostMap).find(k=>S.nodeHostMap[k]===hostId);
  if(nid){
    visNetwork.selectNodes([nid]);
    visNetwork.focus(nid,{scale:1.5,animation:{duration:500}});
    showPanel(nid);
  }
}

// ═══════════════════════════════════════════════════════════
//  SETTINGS PAGE
// ═══════════════════════════════════════════════════════════
async function loadSettingsData(){
  const cfg=await api('/api/zabbix/config');
  if(cfg){
    document.getElementById('cfg-url').value=cfg.url||'';
    document.getElementById('cfg-token').value=cfg.token_masked||'';
    document.getElementById('cfg-refresh').value=cfg.refresh||30;
  }
  // Load Claude key status
  const ck=await api('/api/import/key');
  const ckStatus=document.getElementById('claude-key-status');
  if(ck?.has_key) ckStatus.innerHTML=`<span style="color:var(--green)">✓ Key saved: ${ck.masked}</span>`;
  else ckStatus.innerHTML=`<span style="color:var(--muted)">No key saved</span>`;
  await loadLayouts();
  // Show admin-only sections if admin
  if(S.myRole==='admin'){
    document.getElementById('user-mgmt-card').style.display='block';
    document.getElementById('ldap-card').style.display='block';
    loadUsersTable();
    loadLdapConfig();
    lucide.createIcons();
  }
  // Load AI provider keys
  await loadAiKeys();
}

// ── USER MANAGEMENT ────────────────────────────────────────
async function loadUsersTable(){
  const users=await api('/api/users')||[];
  const el=document.getElementById('users-table');
  if(!users.length){el.innerHTML='<div style="color:var(--muted);font-size:12px">No users found.</div>';return;}
  el.innerHTML=users.map(u=>`
    <div class="user-row">
      <div style="width:30px;height:30px;border-radius:8px;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:13px">
        ${u.display_name?u.display_name[0].toUpperCase():u.username[0].toUpperCase()}
      </div>
      <div style="flex:1;min-width:0">
        <div style="font-size:12px;font-weight:600;color:#fff">${u.display_name||u.username} ${u.is_ldap?'<span style="font-size:9px;color:var(--cyan);font-family:JetBrains Mono,monospace">[AD]</span>':''}</div>
        <div style="font-size:10px;color:var(--muted);font-family:JetBrains Mono,monospace">${u.username}${u.email?' · '+u.email:''}</div>
      </div>
      <span class="role-badge ${u.role}">${u.role}</span>
      <div style="font-size:9px;color:var(--muted);font-family:JetBrains Mono,monospace;text-align:right;flex-shrink:0">
        ${u.last_login?new Date(u.last_login).toLocaleDateString():'Never'}
      </div>
      <button onclick="editUserRole(${u.id},'${u.username}','${u.role}')" style="background:none;border:none;color:var(--muted);cursor:pointer;padding:4px" title="Edit"><i data-lucide="pencil" style="width:12px;height:12px"></i></button>
      <button onclick="deleteUser(${u.id},'${u.username}')" style="background:none;border:none;color:var(--muted);cursor:pointer;padding:4px" title="Delete"><i data-lucide="trash-2" style="width:12px;height:12px"></i></button>
    </div>`).join('');
  lucide.createIcons();
}

function openAddUserModal(){
  ['nu-username','nu-display','nu-email','nu-pass'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('nu-result').innerHTML='';
  document.getElementById('add-user-modal').classList.add('open');
  setTimeout(()=>document.getElementById('nu-username').focus(),100);
}

async function doAddUser(){
  const username=document.getElementById('nu-username').value.trim();
  const display=document.getElementById('nu-display').value.trim();
  const email=document.getElementById('nu-email').value.trim();
  const role=document.getElementById('nu-role').value;
  const pass=document.getElementById('nu-pass').value;
  const res=document.getElementById('nu-result');
  if(!username||!pass){res.innerHTML='<span style="color:var(--red)">Username and password required</span>';return;}
  const r=await api('/api/users',{method:'POST',body:JSON.stringify({username,display_name:display,email,role,password:pass})});
  if(r?.ok){
    res.innerHTML='<span style="color:var(--green)">✓ User created</span>';
    setTimeout(()=>{document.getElementById('add-user-modal').classList.remove('open');loadUsersTable();},800);
  } else {
    res.innerHTML=`<span style="color:var(--red)">✗ ${r?.error||'Error'}</span>`;
  }
}

async function editUserRole(id,username,currentRole){
  const roles=['viewer','operator','admin'];
  const newRole=prompt(`Change role for "${username}".\nCurrent: ${currentRole}\nEnter new role (admin/operator/viewer):`);
  if(!newRole||!roles.includes(newRole)||newRole===currentRole) return;
  const r=await api(`/api/users/${id}`,{method:'PUT',body:JSON.stringify({id,role:newRole})});
  if(r?.ok) loadUsersTable();
  else alert('Error: '+(r?.error||'Failed'));
}

async function deleteUser(id,username){
  if(!confirm(`Delete user "${username}"? This cannot be undone.`)) return;
  const r=await api(`/api/users/${id}`,{method:'DELETE'});
  if(r?.ok) loadUsersTable();
  else alert('Error: '+(r?.error||'Failed'));
}

// ── LDAP / AD ──────────────────────────────────────────────
async function loadLdapConfig(){
  const cfg=await api('/api/users/ldap');
  if(!cfg) return;
  document.getElementById('ldap-enabled').checked=cfg.enabled==1;
  document.getElementById('ldap-host').value=cfg.host||'';
  document.getElementById('ldap-port').value=cfg.port||389;
  document.getElementById('ldap-base-dn').value=cfg.base_dn||'';
  document.getElementById('ldap-bind-dn').value=cfg.bind_dn||'';
  document.getElementById('ldap-bind-pass').value=cfg.bind_pass_masked||'';
  document.getElementById('ldap-user-filter').value=cfg.user_filter||'(&(objectClass=user)(sAMAccountName=%s))';
  document.getElementById('ldap-admin-group').value=cfg.admin_group||'';
  document.getElementById('ldap-operator-group').value=cfg.operator_group||'';
  document.getElementById('ldap-use-tls').checked=cfg.use_tls==1;
}

async function saveLdap(){
  const payload={
    host: document.getElementById('ldap-host').value.trim(),
    port: parseInt(document.getElementById('ldap-port').value)||389,
    base_dn: document.getElementById('ldap-base-dn').value.trim(),
    bind_dn: document.getElementById('ldap-bind-dn').value.trim(),
    bind_pass: document.getElementById('ldap-bind-pass').value,
    user_filter: document.getElementById('ldap-user-filter').value.trim(),
    admin_group: document.getElementById('ldap-admin-group').value.trim(),
    operator_group: document.getElementById('ldap-operator-group').value.trim(),
    use_tls: document.getElementById('ldap-use-tls').checked?1:0,
    enabled: document.getElementById('ldap-enabled').checked?1:0,
  };
  const r=await api('/api/users/ldap',{method:'POST',body:JSON.stringify(payload)});
  const res=document.getElementById('ldap-result');
  if(r?.ok) res.innerHTML='<span style="color:var(--green)">✓ LDAP config saved</span>';
  else res.innerHTML=`<span style="color:var(--red)">✗ ${r?.error||'Error'}</span>`;
}

async function testLdap(){
  const res=document.getElementById('ldap-result');
  res.innerHTML='<span style="color:var(--muted)">Testing connection...</span>';
  const payload={
    host: document.getElementById('ldap-host').value.trim(),
    port: parseInt(document.getElementById('ldap-port').value)||389,
    base_dn: document.getElementById('ldap-base-dn').value.trim(),
    bind_dn: document.getElementById('ldap-bind-dn').value.trim(),
    bind_pass: document.getElementById('ldap-bind-pass').value,
    use_tls: document.getElementById('ldap-use-tls').checked?1:0,
  };
  const r=await api('/api/users/ldap/test',{method:'POST',body:JSON.stringify(payload)});
  if(r?.ok) res.innerHTML=`<span style="color:var(--green)">✓ ${r.message}</span>`;
  else res.innerHTML=`<span style="color:var(--red)">✗ ${r?.error||'Connection failed'}</span>`;
}

async function saveClaudeKey(){
  const key=document.getElementById('claude-key-input').value.trim();
  const st=document.getElementById('claude-key-status');
  if(!key){st.innerHTML='<span style="color:var(--red)">Enter a key</span>';return;}
  const r=await api('/api/import/key',{method:'POST',body:JSON.stringify({claude_key:key})});
  if(r?.ok){
    st.innerHTML='<span style="color:var(--green)">✓ Saved</span>';
    document.getElementById('claude-key-input').value='';
  } else {
    st.innerHTML=`<span style="color:var(--red)">✗ ${r?.error||'Error'}</span>`;
  }
}

async function testZabbix(){
  document.getElementById('cfg-result').textContent='Testing...';
  const r=await api('/api/zabbix/test');
  if(r?.ok) document.getElementById('cfg-result').innerHTML=`<span style="color:var(--green)">✓ Connected — Zabbix ${r.version}</span>`;
  else document.getElementById('cfg-result').innerHTML=`<span style="color:var(--red)">✗ ${r?.error||'Connection failed'}</span>`;
}

async function saveZabbixConfig(){
  const url     = document.getElementById('cfg-url').value.trim();
  const token   = document.getElementById('cfg-token').value.trim();
  const refresh = parseInt(document.getElementById('cfg-refresh').value)||30;
  const r=await api('/api/zabbix/config',{method:'PUT',body:JSON.stringify({url,token,refresh})});
  S.refreshInterval=refresh*1000;
  if(r?.ok){document.getElementById('cfg-result').innerHTML='<span style="color:var(--green)">✓ Saved. Reconnecting...</span>';startRefresh();}
}

async function changePassword(){
  const cur=document.getElementById('pw-cur').value;
  const nw =document.getElementById('pw-new').value;
  const cn =document.getElementById('pw-con').value;
  const res=document.getElementById('pw-result');
  if(nw!==cn){res.innerHTML='<span style="color:var(--red)">Passwords do not match</span>';return;}
  const r=await api('/api/auth/password',{method:'POST',body:JSON.stringify({current:cur,new:nw})});
  if(r?.ok){res.innerHTML='<span style="color:var(--green)">✓ Password updated</span>';['pw-cur','pw-new','pw-con'].forEach(i=>document.getElementById(i).value='');}
  else res.innerHTML=`<span style="color:var(--red)">✗ ${r?.error||'Error'}</span>`;
}

// ═══════════════════════════════════════════════════════════
//  MAP MANAGEMENT
// ═══════════════════════════════════════════════════════════
async function loadMaps(){
  const layouts=await api('/api/layout')||[];
  S.layouts=layouts;
  buildHostMapIndex();
  const container=document.getElementById('map-list');
  // Keep the default "Network Map" item (mapid=0)
  const defaultItem=`<div class="map-list-item${S.currentMapId===0?' active-map':''}" data-mapid="0" onclick="switchMap(0,'Network Map')"><span>🗺️</span><span>Network Map</span></div>`;
  const posmapItem=`<div class="map-list-item${S.currentMapId===-1?' active-map':''}" data-mapid="-1" onclick="switchMap(-1,'POS MAP')"><span>🗺️</span><span>POS MAP</span></div>`;
  const imported=layouts.map(l=>`
    <div class="map-list-item${S.currentMapId==l.id?' active-map':''}" data-mapid="${l.id}" onclick="switchMap(${l.id},'${l.name.replace(/'/g,"\\'")}')">
      <span>🗺</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${l.name}</span>
      <span class="map-del" onclick="deleteMap(event,${l.id})">✕</span>
    </div>`).join('');
  container.innerHTML=defaultItem+posmapItem+imported;
}

function buildHostMapIndex(){
  S.hostMapIndex={};
  const layoutNames={};
  (S.layouts||[]).forEach(l=>{ layoutNames[l.id]=l.name; });
  // Default "Network Map" hosts (JS hardcoded)
  Object.values(DEFAULT_NODE_HOST_MAP).filter(Boolean).forEach(hid=>{
    if(!S.hostMapIndex[hid]) S.hostMapIndex[hid]={mapId:0,mapName:'Network Map'};
  });
  // POS MAP hosts (JS hardcoded)
  Object.values(DEFAULT_POS_NODE_HOST_MAP).filter(Boolean).forEach(hid=>{
    if(!S.hostMapIndex[hid]) S.hostMapIndex[hid]={mapId:-1,mapName:'POS MAP'};
  });
  // DB nodes (imported layouts + custom nodes on default map)
  Object.values(S.dbNodes).forEach(n=>{
    if(!n.zabbix_host_id) return;
    if(S.hostMapIndex[n.zabbix_host_id]) return; // already assigned
    const mid=n.layout_id||0;
    const mname=mid===0?'Network Map':(layoutNames[mid]||`Map ${mid}`);
    S.hostMapIndex[n.zabbix_host_id]={mapId:mid,mapName:mname};
  });
}

async function switchMap(id, name){
  S.currentMapId=id;
  S.currentMapName=name;
  // Persist selected map in URL hash so refresh restores it
  history.replaceState(null,'', id===0 ? location.pathname+location.search : '#map='+id);
  // Update active state in sidebar
  document.querySelectorAll('.map-list-item').forEach(el=>{
    el.classList.toggle('active-map', parseInt(el.dataset.mapid)===id);
  });
  // Update page title
  document.getElementById('page-title').textContent=name;
  // Render map-specific layer buttons and rail
  renderLayerButtons();
  if(id===0){
    // Restore default map nodes/edges/deviceData from startup snapshot
    visNodes.clear(); visEdges.clear();
    visNodes.add(_defaultNodes);
    visEdges.add(_defaultEdges);
    Object.keys(deviceData).forEach(k=>delete deviceData[k]);
    Object.assign(deviceData, JSON.parse(JSON.stringify(_defaultDeviceData)));
    S.nodeHostMap={...DEFAULT_NODE_HOST_MAP};
    S.currentMapHostIds=new Set(Object.values(S.nodeHostMap).filter(Boolean));
    saveNodeHostMap();
    navigate('map');
    document.getElementById('page-title').textContent='Network Map';
    setTimeout(()=>visNetwork.fit({animation:{duration:500}}),100);
    updateMapStatus();
    renderHosts();
    renderAlarms();
    return;
  }
  if(id===-1){
    // Load built-in POS MAP (Asia + Zain + Passport combined)
    visNodes.clear(); visEdges.clear();
    visNodes.add(buildPosmapNodes());
    visEdges.add(buildPosmapEdges());
    Object.keys(deviceData).forEach(k=>delete deviceData[k]);
    Object.assign(deviceData, JSON.parse(JSON.stringify(_posmapDeviceData)));
    S.nodeHostMap={...DEFAULT_POS_NODE_HOST_MAP};
    S.currentMapHostIds=new Set(Object.values(DEFAULT_POS_NODE_HOST_MAP).filter(Boolean));
    saveNodeHostMap();
    navigate('map');
    document.getElementById('page-title').textContent='POS MAP';
    setTimeout(()=>visNetwork.fit({animation:{duration:600}}),100);
    updateMapStatus();
    renderHosts();
    renderAlarms();
    return;
  }
  // Load imported layout
  const layout=await api(`/api/layout/${id}`);
  if(!layout){return;}
  // Build nodeHostMap from this layout's nodes
  const newMap={};
  visNodes.clear(); visEdges.clear();
  (layout.nodes||[]).forEach(n=>{
    if(n.zabbix_host_id) newMap[n.id]=n.zabbix_host_id;
    visNodes.add(mkNode(n.id, n.label, n.type||'switch', n.x, n.y, {size:22,fontSize:10}));
    deviceData[n.id]={name:n.label,ip:n.ip,role:n.role||'',type:n.type||'switch',status:n.status||'ok',ifaces:n.ifaces||[],info:n.info||{}};
  });
  // Load edges with multi-color by link speed
  const SPEED_COL={'25G':'#00C853','16G':'#2979FF','10G':'#FF6D00','1G':'#607D8B','mgmt':'#AB47BC'};
  (layout.positions?.edges||[]).forEach(e=>{
    const lbl=e.label||'';
    const col=SPEED_COL[lbl]||'#1e3a5f';
    visEdges.add(mkEdge(e.from,e.to,col,lbl?{label:lbl,font:{color:col+'cc',size:8,background:'rgba(8,12,20,.85)',strokeWidth:0},width:lbl==='25G'?2.5:lbl==='16G'?2:1.5}:{}));
  });
  S.nodeHostMap=newMap;
  S.currentMapHostIds=new Set(Object.values(newMap).filter(Boolean));
  saveNodeHostMap();
  navigate('map');
  document.getElementById('page-title').textContent=name;
  setTimeout(()=>visNetwork.fit({animation:{duration:500}}),100);
  updateMapStatus();
  renderHosts();
  renderAlarms();
}

async function deleteMap(evt, id){
  evt.stopPropagation();
  if(!confirm('Delete this map and all its nodes?')) return;
  await api(`/api/layout/${id}`,{method:'DELETE'});
  if(S.currentMapId===id) switchMap(0,'Network Map');
  loadMaps();
}

// ═══════════════════════════════════════════════════════════
//  IMPORT MODAL
// ═══════════════════════════════════════════════════════════
let _impFile=null;

function openImportModal(){
  _impFile=null;
  S.importAnalysisResult=null;
  document.getElementById('imp-name').value='';
  document.getElementById('imp-file-info').textContent='';
  document.getElementById('imp-err').textContent='';
  document.getElementById('imp-analyze-btn').disabled=true;
  impGoStep(1);
  document.getElementById('import-modal').style.display='flex';
}
function closeImportModal(){ document.getElementById('import-modal').style.display='none'; }

function impGoStep(n){
  [1,2,3].forEach(i=>{
    document.getElementById('imp-step'+i).style.display=i===n?'':'none';
    const s=document.getElementById('imp-s'+i);
    s.className='import-step'+(i<n?' done':i===n?' active':'');
  });
}

function onFileSelected(input){
  _impFile=input.files[0];
  if(_impFile){
    document.getElementById('imp-file-info').textContent='📎 '+_impFile.name+' ('+Math.round(_impFile.size/1024)+' KB)';
    document.getElementById('imp-analyze-btn').disabled=false;
    document.getElementById('imp-err').textContent='';
  }
}

// Drag & drop support
document.addEventListener('DOMContentLoaded',()=>{
  const dz=document.getElementById('imp-drop');
  if(!dz) return;
  dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag-over');});
  dz.addEventListener('dragleave',()=>dz.classList.remove('drag-over'));
  dz.addEventListener('drop',e=>{
    e.preventDefault(); dz.classList.remove('drag-over');
    const f=e.dataTransfer.files[0];
    if(f){ _impFile=f; document.getElementById('imp-file-info').textContent='📎 '+f.name+' ('+Math.round(f.size/1024)+' KB)'; document.getElementById('imp-analyze-btn').disabled=false; }
  });
});

async function doAnalyzeMap(){
  const name=document.getElementById('imp-name').value.trim();
  const errEl=document.getElementById('imp-err');
  if(!name){errEl.textContent='Enter a map name';return;}
  if(!_impFile){errEl.textContent='Select a file';return;}
  const btn=document.getElementById('imp-analyze-btn');
  btn.textContent='Analyzing…'; btn.disabled=true;
  errEl.textContent='';

  const fd=new FormData();
  fd.append('map',_impFile);

  try{
    const resp=await fetch('/api/import/analyze',{method:'POST',credentials:'include',body:fd});
    const r=await resp.json();
    if(r.error){errEl.textContent='✗ '+r.error;btn.textContent='Analyze with Claude →';btn.disabled=false;return;}
    S.importAnalysisResult=r;
    renderImportPreview(r);
    impGoStep(2);
  }catch(e){
    errEl.textContent='Request failed: '+e.message;
    btn.textContent='Analyze with Claude →';btn.disabled=false;
  }
}

function renderImportPreview(r){
  const sum=document.getElementById('imp-summary');
  sum.innerHTML=`
    <div class="sum-chip" style="border-color:var(--green);color:var(--green)">✓ ${r.matched} matched</div>
    <div class="sum-chip" style="border-color:var(--red);color:var(--muted)">✗ ${r.skipped} not in Zabbix</div>
    <div class="sum-chip">📊 ${r.total} total extracted</div>`;
  const tbody=document.getElementById('imp-preview-body');
  tbody.innerHTML=r.nodes.map(n=>`
    <tr class="${n.matched?'matched':'unmatched'}">
      <td>${n.name}</td>
      <td style="font-family:'JetBrains Mono',monospace">${n.ip||'—'}</td>
      <td>${n.type}</td>
      <td style="font-size:10px;color:${n.matched?'var(--cyan)':'var(--muted)'}">${n.matched?(n.zabbix_host?.name||n.zabbix_host?.host):'Not found'}</td>
      <td><span class="match-pill ${n.matched?'match-ok':'match-no'}">${n.matched?'✓ MATCH':'✗ SKIP'}</span></td>
    </tr>`).join('');
  const hasMatches=r.matched>0;
  document.getElementById('imp-create-btn').disabled=!hasMatches;
}

async function doCreateMap(){
  const name=document.getElementById('imp-name').value.trim();
  const matched=(S.importAnalysisResult?.nodes||[]).filter(n=>n.matched);
  const btn=document.getElementById('imp-create-btn');
  btn.textContent='Creating…'; btn.disabled=true;
  const r=await api('/api/import/create',{method:'POST',body:JSON.stringify({name, nodes:matched})});
  if(r?.ok){
    document.getElementById('imp-done-msg').textContent=`"${name}" created with ${r.nodes_created} nodes`;
    impGoStep(3);
    loadMaps();
    // Auto-switch to the new map
    switchMap(r.layout_id, name);
  } else {
    btn.textContent='Create Map →'; btn.disabled=false;
    alert(r?.error||'Failed to create map');
  }
}

// ═══════════════════════════════════════════════════════════
//  NAVIGATION
// ═══════════════════════════════════════════════════════════
const PAGE_TITLES={map:'Network Map',alarms:'Active Alarms',hosts:'Hosts',intel:'AI Network Intelligence',settings:'Settings',hreality:'Host Reality Management',office:'AI Employees Office'};
function navigate(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.querySelectorAll('.nav-item[data-page]').forEach(n=>n.classList.toggle('active',n.dataset.page===page));
  document.getElementById('page-title').textContent=PAGE_TITLES[page]||page;
  if(page==='alarms')   refreshAlarms();
  if(page==='hosts')    renderHosts();
  if(page==='settings') loadSettingsData();
  if(page==='intel')    initIntelPage();
  if(page==='map')      setTimeout(()=>visNetwork.fit({animation:{duration:400}}),50);
  if(page==='hreality') renderHRealityPage();
  if(page==='office')   { renderOfficePage(); updateOfficeHealthPct(); }
}

// ═══════════════════════════════════════════════════════════
//  AUTH
// ═══════════════════════════════════════════════════════════
async function api(path,opts={}){
  try{
    const r=await fetch(path,{credentials:'include',headers:{'Content-Type':'application/json'},...opts});
    if(r.status===401){showLogin();return null;}
    return r.json();
  }catch(e){return null;}
}

function showLogin(){document.getElementById('login-overlay').style.display='flex';}

async function doLogin(){
  const u=document.getElementById('l-user').value.trim();
  const p=document.getElementById('l-pass').value;
  const e=document.getElementById('l-err');
  const btn=document.querySelector('.login-btn');
  if(!u||!p){e.textContent='Enter username and password';return;}
  btn.textContent='Signing in…';btn.disabled=true;
  try{
    const resp=await fetch('/api/auth/login',{
      method:'POST',credentials:'include',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({username:u,password:p})
    });
    let r=null;
    try{r=await resp.json();}catch(_){
      e.textContent='Server error — make sure you ran install.php first';
      btn.textContent='Sign In →';btn.disabled=false;return;
    }
    if(r?.ok){
      document.getElementById('login-overlay').style.display='none';
      e.textContent='';
      init();
    } else {
      e.textContent=r?.error||'Invalid credentials';
      document.getElementById('l-pass').value='';
      document.getElementById('l-pass').focus();
    }
  }catch(err){
    e.textContent='Cannot reach server';
  }
  btn.textContent='Sign In →';btn.disabled=false;
}

async function doLogout(){
  await api('/api/auth/logout');
  showLogin();
}

// ═══════════════════════════════════════════════════════════
//  LOAD DB NODES (custom nodes added by user)
// ═══════════════════════════════════════════════════════════
async function loadDbNodes(){
  const rows=await api('/api/nodes')||[];
  rows.forEach(r=>{
    S.dbNodes[r.id]=r;
    if(r.zabbix_host_id) S.nodeHostMap[r.id]=r.zabbix_host_id;
    // If it's a custom node not already in vis, add it
    if(r.id.startsWith('custom_') && !visNodes.get(r.id)){
      visNodes.add(mkNode(r.id,r.label,r.type,r.x||0,r.y||0,{size:22,fontSize:10}));
      deviceData[r.id]={name:r.label,ip:r.ip,role:r.role,type:r.type,status:r.status,ifaces:r.ifaces,info:r.info};
    } else if(visNodes.get(r.id)){
      // Update existing node with DB overrides
      const showIp = r.ip && !['External','Internal','Remote','Private','Unknown',''].includes(r.ip);
      visNodes.update({id:r.id, label:r.label+(showIp&&!r.label.includes(r.ip)?'\n'+r.ip:'')});
      deviceData[r.id]={...deviceData[r.id],...r,ifaces:r.ifaces,info:r.info};
    }
  });
  buildHostMapIndex();
}

// ═══════════════════════════════════════════════════════════
//  MAP ALARM PANEL
// ═══════════════════════════════════════════════════════════
const MAP_ALARM = { open: false };
function toggleMapAlarmPanel(){
  MAP_ALARM.open = !MAP_ALARM.open;
  const body = document.getElementById('map-alarm-body');
  const chev = document.getElementById('map-alarm-chevron');
  const hdr  = document.getElementById('map-alarm-header');
  body.style.display = MAP_ALARM.open ? 'block' : 'none';
  chev.style.transform = MAP_ALARM.open ? 'rotate(180deg)' : '';
  hdr.style.borderBottomColor = MAP_ALARM.open ? 'var(--border)' : 'transparent';
}

const SEV_COLORS=['#9E9E9E','#00B0FF','#78909C','#FFB300','#FF6D00','#FF1744'];
const SEV_ICONS =['⚪','🔵','🔵','🟡','🔴','💀'];
function renderMapAlarmPanel(){
  // Non-default map with no Zabbix hosts linked → show placeholder
  if(S.currentMapId !== 0 && S.currentMapHostIds.size === 0){
    const cnt  = document.getElementById('map-alarm-count');
    const list = document.getElementById('map-alarm-list');
    cnt.textContent = 0; cnt.classList.add('hidden');
    list.innerHTML = '<div style="padding:16px 14px;font-size:11px;color:var(--muted);font-family:\'JetBrains Mono\',monospace;text-align:center">⚠ No Zabbix hosts linked on this map</div>';
    return;
  }
  let probs = [...(S.zabbixProblems||[])];
  if(S.currentMapHostIds.size>0)
    probs = probs.filter(p=>{
      const ids=(p.host_ids||[]).concat((p.hosts||[]).map(h=>h.hostid));
      return ids.some(id=>S.currentMapHostIds.has(id));
    });
  probs.sort((a,b)=>(b.severity||0)-(a.severity||0));

  const cnt = document.getElementById('map-alarm-count');
  cnt.textContent = probs.length;
  cnt.classList.toggle('hidden', probs.length===0);
  // Badge color: red if any sev>=4, orange if sev>=3, else default
  const worst = probs.length ? (probs[0].severity||0) : 0;
  cnt.style.background = worst>=4?'var(--red)':worst>=3?'var(--orange)':'var(--red)';

  const list = document.getElementById('map-alarm-list');
  if(!probs.length){
    list.innerHTML='<div style="padding:16px 14px;font-size:11px;color:var(--muted);font-family:\'JetBrains Mono\',monospace;text-align:center">✓ No active alarms on this map</div>';
    return;
  }
  // Find host name for each problem
  const hostNameMap={};
  Object.values(S.zabbixHosts).forEach(h=>{hostNameMap[h.hostid]=h.name||h.host;});
  list.innerHTML = probs.slice(0,30).map(p=>{
    const sev=(p.severity||0);
    const col=SEV_COLORS[sev]||'#9E9E9E';
    const hids=(p.host_ids||[]);
    const hn=hids.map(id=>hostNameMap[id]).filter(Boolean).join(', ')||'Unknown';
    const ago=timeDiff(p.clock||0);
    const ack=p.acknowledged=='1';
    // Find a nodeId to highlight
    const hostId=hids[0]||'';
    return `<div class="map-alarm-row" onclick="highlightHostOnMap('${hostId}')" style="border-left:3px solid ${col}">
      <div style="width:6px;height:6px;border-radius:50%;background:${col};flex-shrink:0;box-shadow:0 0 4px ${col}"></div>
      <div style="flex:1;min-width:0">
        <div style="font-size:10px;color:${col};font-weight:600;font-family:'JetBrains Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${hn}</div>
        <div style="font-size:11px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name||'Unknown problem'}</div>
      </div>
      <div style="font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace;flex-shrink:0;text-align:right">
        ${ago}<br>${ack?'<span style="color:var(--green)">ACK</span>':'<span style="color:var(--orange)">UNACK</span>'}
      </div>
    </div>`;
  }).join('');
}

// ═══════════════════════════════════════════════════════════
//  TRAFFIC ANIMATION
// ═══════════════════════════════════════════════════════════
const TA = {
  data:         {},
  packets:      [],
  animFrame:    null,
  enabled:      true,
  lastFetch:    0,
  fetchInterval:60000,
  canvas:       null,
  ctx:          null,
  moving:       false,    // true during pan/zoom — skip heavy packet draws
  moveTimer:    null,
  posCache:     {},       // nodeId -> {x,y} DOM positions, rebuilt after movement
  posDirty:     true,     // force position cache rebuild
};

function formatBps(bps){
  if(bps>=1e9) return (bps/1e9).toFixed(1)+'Gbps';
  if(bps>=1e6) return (bps/1e6).toFixed(1)+'Mbps';
  if(bps>=1e3) return (bps/1e3).toFixed(1)+'Kbps';
  return Math.round(bps)+'bps';
}

function initTrafficCanvas(){
  TA.canvas = document.getElementById('traffic-canvas');
  if(TA.canvas) TA.canvas.style.willChange='transform'; // GPU layer promotion
  TA.ctx    = TA.canvas ? TA.canvas.getContext('2d',{alpha:true,desynchronized:true}) : null;
  resizeTrafficCanvas();
  // Pause heavy packet drawing during pan/zoom for smooth interaction
  const setMoving = ()=>{
    TA.moving=true;
    clearTimeout(TA.moveTimer);
    TA.moveTimer=setTimeout(()=>{ TA.moving=false; TA.posDirty=true; },120);
  };
  visNetwork.on('dragStart', setMoving);
  visNetwork.on('dragging',  setMoving);
  visNetwork.on('zoom',      setMoving);
  // Invalidate posCache only when viewport scale/position actually changed
  let _lastSc=0, _lastVx=0, _lastVy=0;
  visNetwork.on('afterDrawing', ()=>{
    if(TA.moving) return;
    const sc=visNetwork.getScale();
    let vx=0,vy=0;
    try{ const vp=visNetwork.getViewPosition();vx=vp.x|0;vy=vp.y|0; }catch(_){}
    if(sc!==_lastSc||vx!==_lastVx||vy!==_lastVy){ _lastSc=sc;_lastVx=vx;_lastVy=vy;TA.posDirty=true; }
  });
  // Start canvas loop (handles packets + status badges every frame)
  if(!TA.animFrame) TA.animFrame = requestAnimationFrame(animateTraffic);
  // Spawn idle packets after vis-network has drawn its initial frame
  // Use both the stabilized event AND a fallback timeout for reliability
  let spawned = false;
  const doSpawn = ()=>{ if(!spawned){ spawned=true; spawnPacketsAll(); } };
  visNetwork.once('stabilized', ()=>{ setTimeout(doSpawn, 400); });
  setTimeout(doSpawn, 2000);                // fallback: always fires
  // Periodic Zabbix traffic fetch (enriches idle flow with real bps)
  setTimeout(refreshTrafficData, 5000);
}

function resizeTrafficCanvas(){
  if(!TA.canvas) return;
  const wrap = document.getElementById('map-wrap');
  if(!wrap) return;
  const w = wrap.clientWidth  || wrap.offsetWidth  || 0;
  const h = wrap.clientHeight || wrap.offsetHeight || 0;
  if(!w || !h){ setTimeout(resizeTrafficCanvas, 250); return; }
  TA.canvas.width        = w;
  TA.canvas.height       = h;
  TA.canvas.style.width  = w + 'px';
  TA.canvas.style.height = h + 'px';
}

function toggleTraffic(){
  TA.enabled = !TA.enabled;
  const btn = document.getElementById('tb-traffic');
  if(btn){
    btn.style.color     = TA.enabled ? 'var(--cyan)' : '';
    btn.style.boxShadow = TA.enabled ? '0 0 0 1px var(--cyan)' : '';
  }
  if(TA.enabled){ spawnPacketsAll(); refreshTrafficData(); }
  else { TA.packets=[]; updateEdgeTrafficLabels({}); }
  // Canvas loop keeps running regardless (status badges always need it)
}

async function refreshTrafficData(){
  if(!TA.enabled) return;

  // Try to enrich with real Zabbix bps — but ALWAYS spawn packets regardless
  const hostIds = Object.values(S.nodeHostMap).filter(Boolean);
  if(hostIds.length){
    const qs = hostIds.map(h=>'hosts='+encodeURIComponent(h)).join('&');
    try{
      const r = await fetch('/api/zabbix/traffic?'+qs);
      if(r.ok){
        const j = await r.json();
        if(j && !j.error){ TA.data = j; updateEdgeTrafficLabels(TA.data); }
      }
    }catch(_){}
  }

  // Always respawn packets (idle flow for all reachable edges)
  spawnPacketsAll();
  TA.lastFetch = Date.now();
  setTimeout(refreshTrafficData, TA.fetchInterval);
}

function _bpsForEdge(eid){
  const e = visEdges.get(eid);
  if(!e) return 0;
  const fromHost = S.nodeHostMap[e.from];
  const toHost   = S.nodeHostMap[e.to];
  const d1 = (fromHost && TA.data[fromHost]) ? TA.data[fromHost] : null;
  const d2 = (toHost   && TA.data[toHost])   ? TA.data[toHost]   : null;
  const bps = Math.max(d1?((d1.in||0)+(d1.out||0)):0, d2?((d2.in||0)+(d2.out||0)):0);
  return bps;
}

function spawnPacketsAll(){
  TA.packets = [];   // clear and respawn fresh
  visEdges.getIds().forEach(eid=>{
    const e = visEdges.get(eid);
    if(!e) return;

    // Check if either endpoint is explicitly DOWN in Zabbix → no traffic
    const fromHostId = S.nodeHostMap[e.from];
    const toHostId   = S.nodeHostMap[e.to];
    const fromHost   = fromHostId ? S.zabbixHosts[fromHostId] : null;
    const toHost     = toHostId   ? S.zabbixHosts[toHostId]   : null;
    if(fromHost?.available==2 || toHost?.available==2) return; // dead link

    // Use real Zabbix bps when available, else idle default (node is reachable)
    const d1  = fromHostId ? TA.data[fromHostId] : null;
    const d2  = toHostId   ? TA.data[toHostId]   : null;
    const bps1 = d1 ? ((d1.in||0)+(d1.out||0)) : 0;
    const bps2 = d2 ? ((d2.in||0)+(d2.out||0)) : 0;
    const realBps = Math.max(bps1, bps2);
    // Idle default: 150Kbps so all reachable (or unmapped) links always animate
    const bps = realBps > 0 ? realBps : 150000;

    spawnPackets(eid, bps, realBps===0);
  });
}

function spawnPackets(eid, totalBps, isIdle=false){
  // Idle (no Zabbix data): 1-2 slow dim packets to show link is alive
  // Real traffic: 1-8 packets, speed + color by bps
  const count = isIdle
    ? 2
    : Math.max(1, Math.min(8, Math.round(Math.log2(totalBps/1000+2))));

  let color, alpha;
  if(isIdle){
    color='#1e6e8c'; alpha=0.55;                   // dim teal: alive but idle
  } else if(totalBps>=50e6){ color='#FF6D00'; alpha=0.9; }  // orange: >50Mbps
  else if(totalBps>=5e6)   { color='#00E676'; alpha=0.85; } // green: >5Mbps
  else if(totalBps>=500e3) { color='#00BCD4'; alpha=0.8; }  // cyan: moderate
  else                     { color='#0288D1'; alpha=0.65; } // dim blue: low

  const speed = isIdle
    ? 0.0008 + Math.random()*0.0005
    : 0.0015 + Math.log10(totalBps/1000+1)*0.0018;

  for(let i=0;i<count;i++){
    TA.packets.push({
      edgeId:   eid,
      progress: Math.random(),
      speed,
      color,
      alpha,
      dir:      (i%2===0) ? 1 : -1,
      isIdle,
    });
  }
}

// Rebuild DOM position cache for all visible nodes
function _rebuildPosCache(){
  TA.posCache={};
  visNodes.getIds().forEach(nid=>{
    try{ TA.posCache[nid]=visNetwork.canvasToDOM(visNetwork.getPosition(nid)); }catch(_){}
  });
  TA.posDirty=false;
}

function animateTraffic(){
  TA.animFrame = requestAnimationFrame(animateTraffic);
  const canvas=TA.canvas, ctx=TA.ctx;
  if(!canvas||!ctx||!visNetwork) return;

  // Skip frame if truly nothing to draw (saves CPU when map is idle)
  const hasBadges = Object.keys(S.zabbixHosts).length > 0;
  const hasPackets = TA.enabled && TA.packets.length > 0;
  const hasZones   = !!MAP_ZONES[S.currentMapName];
  if(!hasBadges && !hasPackets && !hasZones && !TA.posDirty) return;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  // During pan/zoom: skip heavy packet work — just draw zone outlines & badges
  if(TA.moving){
    drawZoneOverlays(ctx);
    drawNodeStatusBadges(ctx);
    return;
  }

  // Rebuild position cache when needed (after pan/zoom ends)
  if(TA.posDirty) _rebuildPosCache();

  // ── Zone overlays (map section backgrounds) ───────────────
  drawZoneOverlays(ctx);

  // ── Traffic packets ───────────────────────────────────────
  if(TA.enabled && TA.packets.length){
    const dead=[];
    const rn=0.35;
    ctx.save();
    TA.packets.forEach((pkt,idx)=>{
      pkt.progress += pkt.speed * pkt.dir;
      if(pkt.progress>1||pkt.progress<0){ pkt.dir*=-1; pkt.progress=pkt.progress>1?1:0; }

      const e=visEdges.get(pkt.edgeId);
      if(!e){ dead.push(idx); return; }

      const p0=TA.posCache[e.from], p3=TA.posCache[e.to];
      if(!p0||!p3) return;

      const p1={x:p0.x+rn*(p3.x-p0.x), y:p0.y};
      const p2={x:p0.x+(1-rn)*(p3.x-p0.x), y:p3.y};
      const t=pkt.progress, mt=1-t;
      const px=mt*mt*mt*p0.x+3*mt*mt*t*p1.x+3*mt*t*t*p2.x+t*t*t*p3.x;
      const py=mt*mt*mt*p0.y+3*mt*mt*t*p1.y+3*mt*t*t*p2.y+t*t*t*p3.y;

      const r=pkt.isIdle?2:3;
      ctx.globalAlpha=pkt.alpha||0.85;
      ctx.beginPath();
      ctx.arc(px,py,r,0,Math.PI*2);
      ctx.fillStyle=pkt.color;
      ctx.fill();  // no shadowBlur — major perf win
    });
    ctx.globalAlpha=1;
    ctx.restore();
    for(let i=dead.length-1;i>=0;i--) TA.packets.splice(dead[i],1);
  }

  // ── Node status badges ────────────────────────────────────
  drawNodeStatusBadges(ctx);
}

// ── Zone overlay definitions (per map name) ────────────────
const MAP_ZONES = {
  'Tabadul Servers Infra': [
    { label:'Production Environment', color:'rgba(0,150,136,0.06)', border:'rgba(0,200,160,0.30)',
      nodeIds:['infra_zabbix','infra_olvm','infra_hv_prod1','infra_hv_prod2','infra_perso','infra_uat_olvm',
               'infra_san_sw1','infra_san_sw2','infra_tor_sw1','infra_tor_sw2',
               'infra_nas1','infra_san1','infra_san2','infra_commvault'] },
    { label:'Corporate / vCenter Environment', color:'rgba(63,81,181,0.06)', border:'rgba(100,120,220,0.30)',
      nodeIds:['infra_vcenter','infra_esxi1','infra_esxi2','infra_esxi3','infra_sap_uat',
               'infra_corp_sw1','infra_corp_sw2','infra_ag1000_1','infra_ag1000_2',
               'infra_dell_emc','infra_tape','infra_nas2'] },
  ]
};

function drawZoneOverlays(ctx){
  const zones = MAP_ZONES[S.currentMapName];
  if(!zones||!visNetwork) return;
  const PAD=60;
  zones.forEach(z=>{
    let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
    z.nodeIds.forEach(nid=>{
      const pos=TA.posCache[nid];
      if(!pos) return;
      if(pos.x-PAD<minX) minX=pos.x-PAD;
      if(pos.y-PAD<minY) minY=pos.y-PAD;
      if(pos.x+PAD>maxX) maxX=pos.x+PAD;
      if(pos.y+PAD>maxY) maxY=pos.y+PAD;
    });
    if(!isFinite(minX)) return;
    const w=maxX-minX, h=maxY-minY;
    ctx.save();
    ctx.beginPath();
    const r=14;
    ctx.moveTo(minX+r,minY); ctx.lineTo(maxX-r,minY); ctx.arcTo(maxX,minY,maxX,minY+r,r);
    ctx.lineTo(maxX,maxY-r); ctx.arcTo(maxX,maxY,maxX-r,maxY,r);
    ctx.lineTo(minX+r,maxY); ctx.arcTo(minX,maxY,minX,maxY-r,r);
    ctx.lineTo(minX,minY+r); ctx.arcTo(minX,minY,minX+r,minY,r);
    ctx.closePath();
    ctx.fillStyle=z.color; ctx.fill();
    ctx.strokeStyle=z.border; ctx.lineWidth=1.5; ctx.setLineDash([6,4]); ctx.stroke();
    ctx.setLineDash([]);
    // Label
    ctx.font='bold 11px "JetBrains Mono",monospace';
    ctx.fillStyle=z.border.replace('0.30','0.9');
    ctx.fillText(z.label, minX+10, minY+18);
    ctx.restore();
  });
}

// Draw per-node status indicators on the traffic canvas.
// Because this runs every RAF frame with canvasToDOM, badges never drift.
function drawNodeStatusBadges(ctx){
  if(!visNetwork || !Object.keys(S.zabbixHosts).length) return;
  const now = Date.now() / 1000;

  visNodes.getIds().forEach(nid=>{
    const hostId = S.nodeHostMap[nid];
    if(!hostId) return;
    const host = S.zabbixHosts[hostId];
    if(!host) return;

    const down = host.available==2 && host.problem_count>0;
    const sev  = host.worst_severity||0;
    if(!down && sev<1) return;  // all clear — no badge

    // Always use posCache — eliminates canvasToDOM from the hot animation loop
    const dom = TA.posCache[nid];
    if(!dom) return;

    const ndata    = visNodes.get(nid);
    const nodeSize = (ndata?.size||28);
    const scale    = visNetwork.getScale();
    const sr       = nodeSize * scale;  // scaled radius

    // ── Pulsing ring for DOWN nodes ───────────────────────
    if(down){
      const pulse = 0.4 + 0.6 * Math.abs(Math.sin(now * 2.5));
      ctx.beginPath();
      ctx.arc(dom.x, dom.y, sr + 6 + pulse*10, 0, Math.PI*2);
      ctx.strokeStyle = '#FF1744';
      ctx.lineWidth   = 2.5;
      ctx.globalAlpha = 0.25 + 0.35*pulse;
      ctx.stroke();
      ctx.globalAlpha = 1;
    }

    // ── Badge position: top-right corner of node ──────────
    const bx = dom.x + sr * 0.65 + 3;
    const by = dom.y - sr * 0.65 - 3;
    const r  = Math.max(8, Math.min(12, sr * 0.38));

    // Determine badge style
    let badgeColor, sym;
    if(down)       { badgeColor='#FF1744'; sym='x'; }
    else if(sev>=5){ badgeColor='#FF1744'; sym='!'; }
    else if(sev>=4){ badgeColor='#FF6D00'; sym='!'; }
    else if(sev>=3){ badgeColor='#FFB300'; sym='!'; }
    else           { badgeColor='#78909C'; sym='.'; }

    // Outer glow
    ctx.beginPath(); ctx.arc(bx, by, r+4, 0, Math.PI*2);
    ctx.fillStyle = badgeColor+'33'; ctx.fill();

    // Badge circle
    ctx.beginPath(); ctx.arc(bx, by, r, 0, Math.PI*2);
    ctx.fillStyle   = badgeColor;
    ctx.shadowColor = badgeColor;
    ctx.shadowBlur  = 10;
    ctx.fill();
    ctx.shadowBlur  = 0;
    ctx.strokeStyle = 'rgba(0,0,0,0.5)';
    ctx.lineWidth   = 1.5;
    ctx.stroke();

    // Symbol inside badge
    ctx.strokeStyle = 'white';
    ctx.fillStyle   = 'white';
    ctx.lineWidth   = Math.max(1.5, r*0.22);
    ctx.lineCap     = 'round';
    if(sym==='x'){
      const d=r*0.42;
      ctx.beginPath(); ctx.moveTo(bx-d,by-d); ctx.lineTo(bx+d,by+d); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(bx+d,by-d); ctx.lineTo(bx-d,by+d); ctx.stroke();
    } else if(sym==='!'){
      const d=r*0.38;
      ctx.beginPath(); ctx.moveTo(bx, by-d); ctx.lineTo(bx, by+d*0.2); ctx.stroke();
      ctx.beginPath(); ctx.arc(bx, by+d*0.72, r*0.15, 0, Math.PI*2); ctx.fill();
    } else {
      // info dot
      ctx.beginPath(); ctx.arc(bx, by, r*0.25, 0, Math.PI*2); ctx.fill();
    }
  });
}

function updateEdgeTrafficLabels(data){
  visEdges.getIds().forEach(eid=>{
    const bps = _bpsForEdge(eid);  // real Zabbix bps only
    const e   = visEdges.get(eid);
    if(!e) return;
    if(bps>0 && TA.enabled){
      visEdges.update({id:eid, label: formatBps(bps),
        font:{color:'#00BCD4',size:9,background:'rgba(10,14,26,0.85)'}});
    } else {
      const cur = e.label||'';
      if(/bps$/.test(cur)) visEdges.update({id:eid, label:'', font:{color:'',size:9,background:''}});
    }
  });
}

// ═══════════════════════════════════════════════════════════
//  AI CHAT — HOST CONTEXT
// ═══════════════════════════════════════════════════════════
const HC = { open:false, messages:[], hostContext:null, thinking:false };

function openHostChat(nid){
  const d = {...(deviceData[nid]||{}), ...(S.dbNodes[nid]||{})};
  const hostId = S.nodeHostMap[nid]||'';
  const zbxHost = hostId ? S.zabbixHosts[hostId] : null;
  const probs   = zbxHost ? (zbxHost.problems||[]) : [];

  HC.hostContext = {
    name:       d.name||nid,
    ip:         d.ip||'',
    type:       d.type||'switch',
    role:       d.role||'',
    status:     d.status||'ok',
    zabbix_id:  hostId,
    problems:   probs,
    ifaces:     d.ifaces||[],
    info:       d.info||{},
  };
  HC.messages = [];

  document.getElementById('hc-context-label').textContent = d.name||nid;
  document.getElementById('hc-messages').innerHTML='';

  const panel=document.getElementById('host-chat-panel');
  panel.style.display='flex';
  HC.open=true;
  document.getElementById('hc-chevron').style.transform='rotate(0deg)';

  // Auto-start: send greeting from AI
  hcAppendThinking();
  apiChat({
    messages:[{role:'user',content:`I'm reviewing ${d.name||nid} (IP: ${d.ip||'unknown'}). Please greet me and start your investigation.`}],
    mode:'host', host_context:HC.hostContext
  }).then(r=>{
    hcRemoveThinking();
    if(r?.reply){
      HC.messages.push({role:'assistant',content:r.reply});
      hcRenderMsg('assistant',r.reply);
    }
  });
}

function toggleHostChat(){
  HC.open=!HC.open;
  document.getElementById('hc-body').style.display=HC.open?'flex':'none';
  document.getElementById('hc-chevron').style.transform=HC.open?'rotate(0deg)':'rotate(180deg)';
}

function hcAppendThinking(){
  const el=document.createElement('div');
  el.className='ai-msg assistant'; el.id='hc-thinking';
  el.innerHTML='<div class="ai-bubble thinking">Analyzing...</div>';
  document.getElementById('hc-messages').appendChild(el);
  scrollHC();
}
function hcRemoveThinking(){const el=document.getElementById('hc-thinking');if(el)el.remove();}

function hcRenderMsg(role,text){
  const el=document.createElement('div');
  el.className='ai-msg '+role;
  el.innerHTML=`<div class="ai-bubble ${role}">${text.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')}</div>`;
  document.getElementById('hc-messages').appendChild(el);
  scrollHC();
}
function scrollHC(){const el=document.getElementById('hc-messages');if(el)el.scrollTop=el.scrollHeight;}

async function sendHostChat(){
  if(HC.thinking) return;
  const inp=document.getElementById('hc-input');
  const text=inp.value.trim();
  if(!text) return;
  inp.value='';
  HC.messages.push({role:'user',content:text});
  hcRenderMsg('user',text);
  HC.thinking=true;
  hcAppendThinking();
  const msgs=[...HC.messages];
  const r=await apiChat({messages:msgs,mode:'host',host_context:HC.hostContext});
  hcRemoveThinking();
  HC.thinking=false;
  if(r?.reply){
    HC.messages.push({role:'assistant',content:r.reply});
    hcRenderMsg('assistant',r.reply);
  } else if(r?.error){
    hcRenderMsg('assistant','⚠ '+r.error);
  }
}

// ═══════════════════════════════════════════════════════════
//  AI CHAT — INTEL PAGE
// ═══════════════════════════════════════════════════════════
const INTEL = { messages:[], context:'network', thinking:false, initialized:false };

function initIntelPage(){
  if(INTEL.initialized) return;
  INTEL.initialized=true;
  // Welcome message
  const welcome=`**Welcome to NOC Sentinel Intelligence**\n\nI have access to your live network data:\n- **${document.getElementById('sc-total').textContent}** monitored hosts\n- **${document.getElementById('sc-alarms').textContent}** active alarms\n\nI'm here to help you:\n• Analyze current network health\n• Identify monitoring gaps\n• Provide Zabbix configuration guidance\n• Learn about your network topology\n\nWhat would you like to explore?`;
  INTEL.messages=[];
  document.getElementById('intel-messages').innerHTML='';
  intelRenderMsg('assistant',welcome);
}

function setIntelContext(ctx,btn){
  INTEL.context=ctx;
  document.querySelectorAll('.intel-ctx-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('intel-context-label').textContent={
    network:'Full Network Analysis',alarms:'Alarm Analysis',
    topology:'Topology Review',performance:'Performance Analysis'}[ctx]||ctx;
}

function intelRenderMsg(role,text){
  const el=document.createElement('div');
  el.className='ai-msg '+role;
  const badge=role==='assistant'?'<div class="ai-badge"><i data-lucide="bot" style="width:9px;height:9px"></i> NOC Sentinel</div>':'';
  const html=role==='user'?text.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'):_md(text);
  el.innerHTML=`${badge}<div class="ai-bubble ${role}">${html}</div>`;
  document.getElementById('intel-messages').appendChild(el);
  document.getElementById('intel-messages').scrollTop=1e9;
  lucide.createIcons();
}

function intelAppendThinking(){
  const el=document.createElement('div');el.className='ai-msg assistant';el.id='intel-thinking';
  el.innerHTML='<div class="ai-bubble thinking"><i data-lucide="loader" style="width:11px;height:11px;animation:spin 1s linear infinite;vertical-align:-1px"></i> Thinking...</div>';
  document.getElementById('intel-messages').appendChild(el);
  document.getElementById('intel-messages').scrollTop=1e9;
  lucide.createIcons();
}

// Simple markdown → safe HTML
function _md(t){
  return t
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/`([^`]+)`/g,'<code style="background:rgba(0,212,255,0.12);border-radius:3px;padding:1px 4px;font-family:\'JetBrains Mono\',monospace;font-size:0.9em">$1</code>')
    .replace(/^#{1,3} (.+)$/gm,'<span style="color:#fff;font-weight:700">$1</span>')
    .replace(/^[-•]\s+(.+)$/gm,'◆ $1')
    .replace(/\n/g,'<br>');
}

async function sendIntelMessage(){
  if(INTEL.thinking) return;
  const inp=document.getElementById('intel-input');
  const text=inp.value.trim(); if(!text) return;
  inp.value='';
  INTEL.messages.push({role:'user',content:text});
  intelRenderMsg('user',text);
  INTEL.thinking=true;
  intelAppendThinking();

  // Build network stats + context
  const stats={
    total:parseInt(document.getElementById('sc-total').textContent)||0,
    ok:parseInt(document.getElementById('sc-ok').textContent)||0,
    with_problems:parseInt(document.getElementById('sc-prob').textContent)||0,
    alarms:parseInt(document.getElementById('sc-alarms').textContent)||0,
    unavailable:parseInt(document.getElementById('sc-prob').textContent)||0,
  };
  const ctxData={
    alarm_list:(S.zabbixProblems||[]).slice(0,20).map(p=>({name:p.name,severity:p.severity||0})),
    problem_hosts:Object.values(S.zabbixHosts||{}).filter(h=>(h.problem_count||0)>0).slice(0,15).map(h=>({host:h.host,problems:h.problem_count,severity:h.worst_severity||0,available:h.available})),
  };

  // Create streaming bubble
  const msgEl=document.createElement('div'); msgEl.className='ai-msg assistant';
  const badge='<div class="ai-badge"><i data-lucide="bot" style="width:9px;height:9px"></i> NOC Sentinel</div>';
  msgEl.innerHTML=badge+'<div class="ai-bubble assistant streaming" id="_intel_stream"></div>';
  const thinking=document.getElementById('intel-thinking');
  if(thinking) thinking.replaceWith(msgEl); else document.getElementById('intel-messages').appendChild(msgEl);
  lucide.createIcons();
  const bubble=document.getElementById('_intel_stream');

  let fullText='';
  try{
    const resp=await fetch('/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({messages:[...INTEL.messages],mode:'network',context_focus:INTEL.context,stream:true,network_stats:stats,context_data:ctxData}),
    });
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    const reader=resp.body.getReader();
    const dec=new TextDecoder();
    let buf='';
    while(true){
      const {done,value}=await reader.read();
      if(done) break;
      buf+=dec.decode(value,{stream:true});
      const lines=buf.split('\n');
      buf=lines.pop();
      for(const line of lines){
        if(line.startsWith('event: done')){break;}
        if(!line.startsWith('data: ')) continue;
        try{
          const ev=JSON.parse(line.slice(6));
          if(ev.t){ fullText+=ev.t; bubble.innerHTML=_md(fullText); document.getElementById('intel-messages').scrollTop=1e9; }
          if(ev.error){ fullText='⚠ '+ev.error; bubble.innerHTML=_md(fullText); }
        }catch(_){}
      }
    }
  }catch(e){
    fullText='⚠ Connection error — check Claude API key in Settings';
    bubble.innerHTML=_md(fullText);
  }
  bubble.classList.remove('streaming');
  bubble.id='';
  if(fullText) INTEL.messages.push({role:'assistant',content:fullText});
  INTEL.thinking=false;
}

async function apiChat(payload){
  const stats={
    total:parseInt(document.getElementById('sc-total').textContent)||0,
    ok:parseInt(document.getElementById('sc-ok').textContent)||0,
    with_problems:parseInt(document.getElementById('sc-prob').textContent)||0,
    alarms:parseInt(document.getElementById('sc-alarms').textContent)||0,
    unavailable:parseInt(document.getElementById('sc-prob').textContent)||0,
  };
  return await api('/api/chat',{method:'POST',body:JSON.stringify({...payload,network_stats:stats})});
}

// ═══════════════════════════════════════════════════════════
//  HOST REALITY MANAGEMENT
// ═══════════════════════════════════════════════════════════
const HR = {
  searchQ: '',
  colFilters: { label:'', mapName:'all', ip:'', zbxId:'', missingIp:false, missingZbx:false }
};

const _hrMissingIp  = ip  => !ip || ip.includes('x.x') || ['External','Internal','Remote','Private','Unknown'].some(p => ip.includes(p));
const _hrMissingZbx = zbx => !zbx;

function _hrApplyFilters(allRows){
  const q = HR.searchQ.toLowerCase();
  const f = HR.colFilters;
  let rows = allRows;
  if(q) rows = rows.filter(r =>
    r.label.toLowerCase().includes(q) || r.ip.toLowerCase().includes(q) ||
    r.zbxId.includes(q) || r.mapName.toLowerCase().includes(q) || r.id.toLowerCase().includes(q));
  if(f.label)              rows = rows.filter(r => r.label.toLowerCase().includes(f.label.toLowerCase()));
  if(f.mapName !== 'all')  rows = rows.filter(r => r.mapName === f.mapName);
  if(f.ip)                 rows = rows.filter(r => r.ip.toLowerCase().includes(f.ip.toLowerCase()));
  if(f.zbxId)              rows = rows.filter(r => r.zbxId.includes(f.zbxId));
  if(f.missingIp)          rows = rows.filter(r => _hrMissingIp(r.ip));
  if(f.missingZbx)         rows = rows.filter(r => _hrMissingZbx(r.zbxId));
  return rows;
}

function _hrGetAllNodes(){
  const rows = [];
  const layoutNames = {};
  (S.layouts || []).forEach(l => { layoutNames[l.id] = l.name; });
  const zbxName = id => id && S.zabbixHosts[id] ? S.zabbixHosts[id].host : '';
  const getMap = (id, dbRow) => {
    if(dbRow && dbRow.layout_id != null){
      const lid = parseInt(dbRow.layout_id);
      if(lid === 0) return 'Network Map';
      if(lid === -1) return 'POS MAP';
      return layoutNames[lid] || 'Map '+lid;
    }
    if(DEFAULT_NODE_HOST_MAP.hasOwnProperty(id)) return 'Network Map';
    if(DEFAULT_POS_NODE_HOST_MAP.hasOwnProperty(id)) return 'POS MAP';
    return 'Network Map';
  };
  const seen = new Set();

  // 1. Network Map hardcoded nodes
  Object.keys(deviceData).forEach(id => {
    if(seen.has(id)) return; seen.add(id);
    const d = deviceData[id];
    const dbRow = S.dbNodes[id] || null;
    const zbxId = S.nodeHostMap[id] || DEFAULT_NODE_HOST_MAP[id] || '';
    rows.push({ id, label: dbRow ? dbRow.label : d.name, mapName: getMap(id, dbRow), ip: dbRow ? dbRow.ip : (d.ip || ''), zbxId, zbxHostName: zbxName(zbxId) });
  });

  // 2. POS MAP hardcoded nodes
  Object.keys(_posmapDeviceData).forEach(id => {
    if(seen.has(id)) return; seen.add(id);
    const d = _posmapDeviceData[id];
    const dbRow = S.dbNodes[id] || null;
    const zbxId = DEFAULT_POS_NODE_HOST_MAP[id] || S.nodeHostMap[id] || '';
    rows.push({ id, label: dbRow ? dbRow.label : d.name, mapName: 'POS MAP', ip: dbRow ? dbRow.ip : (d.ip || ''), zbxId, zbxHostName: zbxName(zbxId) });
  });

  // 3. DB-only nodes (custom + imported layout nodes)
  Object.values(S.dbNodes).forEach(n => {
    if(seen.has(n.id)) return; seen.add(n.id);
    const lid = n.layout_id != null ? parseInt(n.layout_id) : 0;
    const mapName = lid === 0 ? 'Network Map' : (lid === -1 ? 'POS MAP' : (layoutNames[lid] || 'Map '+lid));
    const zbxId = n.zabbix_host_id || S.nodeHostMap[n.id] || '';
    rows.push({ id: n.id, label: n.label, mapName, ip: n.ip || '', zbxId, zbxHostName: zbxName(zbxId) });
  });

  return rows;
}

function renderHRealityPage(){
  const allRows = _hrGetAllNodes();
  const f = HR.colFilters;
  const mapNames = [...new Set(allRows.map(r => r.mapName))].sort();
  const mapOpts  = mapNames.map(n => `<option value="${n.replace(/"/g,'&quot;')}"${f.mapName===n?' selected':''}>${n}</option>`).join('');

  // Render filter row (re-built on full render to update map options + chip active states)
  const thead = document.getElementById('hr-thead');
  thead.innerHTML = `<tr>
    <th style="width:30%">Host Name / Node ID</th>
    <th style="width:14%">Map</th>
    <th style="width:18%">IP Address</th>
    <th style="width:29%">Zabbix Host ID → Linked Host</th>
    <th style="width:9%;text-align:center"><span id="hr-count" style="font-size:9px;font-weight:400;color:var(--muted)"></span></th>
  </tr>
  <tr class="hr-filter-row">
    <td><input class="hr-filter-input" id="hr-f-label" placeholder="Filter name…" value="${f.label.replace(/"/g,'&quot;')}" oninput="HR.colFilters.label=this.value;_hrRefilter()"></td>
    <td><select class="hr-filter-select" id="hr-f-map" onchange="HR.colFilters.mapName=this.value;_hrRefilter()"><option value="all"${f.mapName==='all'?' selected':''}>All Maps</option>${mapOpts}</select></td>
    <td>
      <input class="hr-filter-input" id="hr-f-ip" placeholder="Filter IP…" value="${f.ip.replace(/"/g,'&quot;')}" oninput="HR.colFilters.ip=this.value;_hrRefilter()">
      <div id="hr-chip-ip" class="hr-missing-chip${f.missingIp?' active':''}" onclick="HR.colFilters.missingIp=!HR.colFilters.missingIp;this.classList.toggle('active');_hrRefilter()">⚠ Missing only</div>
    </td>
    <td>
      <input class="hr-filter-input" id="hr-f-zbx" placeholder="Filter ZBX ID…" value="${f.zbxId.replace(/"/g,'&quot;')}" oninput="HR.colFilters.zbxId=this.value;_hrRefilter()" style="font-family:'JetBrains Mono',monospace">
      <div id="hr-chip-zbx" class="hr-missing-chip${f.missingZbx?' active':''}" onclick="HR.colFilters.missingZbx=!HR.colFilters.missingZbx;this.classList.toggle('active');_hrRefilter()">⚠ Missing only</div>
    </td>
    <td></td>
  </tr>`;

  _hrRenderRows(allRows);
}

// Only re-renders tbody — called on text input changes to preserve focus
function _hrRefilter(){
  _hrRenderRows(_hrGetAllNodes());
  // Keep chip states in sync (chips might have been toggled via onclick, state already updated)
  const chipIp  = document.getElementById('hr-chip-ip');
  const chipZbx = document.getElementById('hr-chip-zbx');
  if(chipIp)  chipIp.classList.toggle('active',  HR.colFilters.missingIp);
  if(chipZbx) chipZbx.classList.toggle('active', HR.colFilters.missingZbx);
}

function _hrRenderRows(allRows){
  const filtered = _hrApplyFilters(allRows);
  const countEl  = document.getElementById('hr-count');
  if(countEl) countEl.textContent = `${filtered.length} / ${allRows.length}`;

  const MAP_COLORS = { 'Network Map':'#00d4ff', 'POS MAP':'#a78bfa' };
  const tbody = document.getElementById('hr-tbody');
  tbody.innerHTML = filtered.map((r,i) => {
    const mc      = MAP_COLORS[r.mapName] || '#f59e0b';
    const misIp   = _hrMissingIp(r.ip);
    const misZbx  = _hrMissingZbx(r.zbxId);
    const rowCls  = (misIp || misZbx) ? ' hr-issue' : '';
    const safeLbl = r.label.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/\n/g,' ');
    const safeIp  = r.ip.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');
    return `<tr id="hr-row-${i}" data-id="${r.id}" class="${rowCls}">
      <td style="padding:9px 14px">
        <input class="hr-edit" id="hr-label-${i}" value="${safeLbl}" placeholder="Host name">
        <div class="hr-node-id">${r.id}</div>
      </td>
      <td style="padding:9px 14px">
        <span class="hr-map-badge" style="background:${mc}1a;border-color:${mc}33;color:${mc}">${r.mapName}</span>
      </td>
      <td style="padding:9px 14px${misIp?';background:rgba(239,68,68,0.04)':''}">
        <input class="hr-edit${misIp?' hr-missing-val':''}" id="hr-ip-${i}" value="${safeIp}" placeholder="IP Address">
        ${misIp?'<div class="hr-warn-lbl">⚠ No IP configured</div>':''}
      </td>
      <td style="padding:9px 14px${misZbx?';background:rgba(239,68,68,0.04)':''}">
        <input class="hr-edit${misZbx?' hr-missing-val':''}" id="hr-zbx-${i}" value="${r.zbxId}" placeholder="Zabbix Host ID" style="font-family:'JetBrains Mono',monospace">
        <div class="${r.zbxHostName?'hr-zbx-name':'hr-zbx-none'}" id="hr-zbxn-${i}">${r.zbxHostName||(r.zbxId?'— not in Zabbix':'— not linked')}</div>
        ${misZbx?'<div class="hr-warn-lbl">⚠ Not linked to Zabbix</div>':''}
      </td>
      <td style="padding:9px 14px;text-align:center">
        <button class="hr-save-btn" onclick="hrSaveRow(${i},'${r.id}')">Save</button>
        <div class="hr-saved" id="hr-saved-${i}" style="display:none">✓</div>
      </td>
    </tr>`;
  }).join('') || `<tr><td colspan="5" style="padding:32px;text-align:center;color:var(--muted);font-size:12px">No hosts match filters</td></tr>`;
}

async function hrSaveRow(i, nodeId){
  const label  = document.getElementById(`hr-label-${i}`).value.trim();
  const ip     = document.getElementById(`hr-ip-${i}`).value.trim();
  const zbxId  = document.getElementById(`hr-zbx-${i}`).value.trim();
  if(!label) return;

  const existing = S.dbNodes[nodeId] || deviceData[nodeId] || _posmapDeviceData[nodeId] || {};
  let layout_id = null;
  if(S.dbNodes[nodeId] && S.dbNodes[nodeId].layout_id != null) layout_id = S.dbNodes[nodeId].layout_id;
  else if(DEFAULT_POS_NODE_HOST_MAP.hasOwnProperty(nodeId)) layout_id = -1;
  else layout_id = 0;

  const payload = {
    id: nodeId, label, ip,
    role: existing.role || '',
    type: existing.type || 'switch',
    layer_key: S.dbNodes[nodeId]?.layer_key || 'srv',
    x: S.dbNodes[nodeId]?.x || 0,
    y: S.dbNodes[nodeId]?.y || 0,
    status: S.dbNodes[nodeId]?.status || 'ok',
    ifaces: existing.ifaces || [],
    info: existing.info || {},
    zabbix_host_id: zbxId || null,
    layout_id,
  };

  const btn = document.querySelector(`#hr-row-${i} .hr-save-btn`);
  if(btn){ btn.textContent='…'; btn.disabled=true; }

  const result = await api('/api/nodes', { method:'POST', body:JSON.stringify(payload) });
  if(btn){ btn.textContent='Save'; btn.disabled=false; }
  if(!result?.ok){ alert('Save failed — check console'); return; }

  // Update in-memory state
  S.dbNodes[nodeId] = { ...(S.dbNodes[nodeId]||{}), ...payload };
  if(zbxId) S.nodeHostMap[nodeId] = zbxId; else delete S.nodeHostMap[nodeId];
  if(deviceData[nodeId])       { deviceData[nodeId].name = label; deviceData[nodeId].ip = ip; }
  if(_posmapDeviceData[nodeId]){ _posmapDeviceData[nodeId].name = label; _posmapDeviceData[nodeId].ip = ip; }

  // Update vis node label if present on canvas
  if(visNodes.get(nodeId)){
    const showIp = ip && !['External','Internal','Remote','Private','Unknown',''].includes(ip);
    visNodes.update({ id:nodeId, label: label+(showIp?'\n'+ip:'') });
  }

  saveNodeHostMap();
  buildHostMapIndex();
  updateMapStatus();

  // Refresh zbx name display
  const zbxHost = zbxId && S.zabbixHosts[zbxId] ? S.zabbixHosts[zbxId].host : '';
  const zbxNameEl = document.getElementById(`hr-zbxn-${i}`);
  if(zbxNameEl){
    zbxNameEl.className = zbxHost ? 'hr-zbx-name' : 'hr-zbx-none';
    zbxNameEl.textContent = zbxHost || (zbxId ? '— not in Zabbix' : '— not linked');
  }

  // Flash saved indicator
  const savedEl = document.getElementById(`hr-saved-${i}`);
  if(savedEl && btn){
    btn.style.display='none'; savedEl.style.display='block';
    setTimeout(()=>{ btn.style.display=''; savedEl.style.display='none'; }, 2000);
  }
}

// ═══════════════════════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════════════════════
async function init(){
  lucide.createIcons();
  // Fetch current user role
  const me=await api('/api/auth/me');
  if(!me) return; // not logged in — showLogin() already called by api()
  document.getElementById('login-overlay').style.display='none';
  if(me?.role) S.myRole=me.role;
  applyRoleUI();
  loadNodeHostMap();
  await loadDbNodes();
  loadSavedPositions();
  // Default map: build host filter from nodeHostMap
  S.currentMapHostIds=new Set(Object.values(S.nodeHostMap).filter(Boolean));
  startRefresh();
  await loadMaps();
  // Restore map from URL hash on refresh (e.g. #map=6)
  const _hashMap = location.hash.match(/^#map=(-?\d+)$/);
  if(_hashMap){
    const _mid=parseInt(_hashMap[1]);
    if(_mid===-1) switchMap(-1,'POS MAP');
    else if(_mid>0){ const _ml=S.layouts.find(l=>parseInt(l.id)===_mid); if(_ml) switchMap(_mid,_ml.name); }
  }
  initTrafficCanvas();
  visNetwork.once('stabilized',()=>visNetwork.fit({animation:{duration:700}}));
  window.addEventListener('resize',()=>{ visNetwork.fit(); resizeTrafficCanvas(); });
  dismissSplash('SYSTEM READY');
}

function applyRoleUI(){
  // Hide write actions for viewer
  const isViewer=S.myRole==='viewer';
  const isOperatorPlus=S.myRole==='admin'||S.myRole==='operator';
  // Nodes toolbar add button
  const addBtn=document.querySelector('[onclick*="openAddNodeModal"],#tb-add');
  if(addBtn&&isViewer) addBtn.style.display='none';
  // Map import
  const impBtn=document.querySelector('[onclick*="openImportModal"]');
  if(impBtn&&isViewer) impBtn.style.display='none';
  // Save layout button
  document.querySelectorAll('[onclick*="saveLayoutPrompt"]').forEach(b=>{ if(isViewer)b.style.display='none'; });
}

// ── SPLASH DISMISS ────────────────────────────────────────
const _splashT0 = Date.now();
function dismissSplash(msg){
  const s  = document.getElementById('splash-screen');
  const st = document.getElementById('spl-status');
  if(!s) return;
  if(st && msg) st.textContent = msg;
  const elapsed = Date.now() - _splashT0;
  const wait    = Math.max(0, 2400 - elapsed);
  setTimeout(()=>{
    s.classList.add('done');
    setTimeout(()=>{ if(s.parentNode) s.parentNode.removeChild(s); }, 700);
  }, wait);
}

// ═══════════════════════════════════════════════════════════
//  AUTO-COLLAB TOGGLE
// ═══════════════════════════════════════════════════════════
function toggleAutoCollab() {
  OFFICE_STATE.autoCollabEnabled = !OFFICE_STATE.autoCollabEnabled;
  const btn = document.getElementById('auto-collab-btn');
  if (btn) {
    btn.textContent = `🤝 Auto-Collab: ${OFFICE_STATE.autoCollabEnabled ? 'ON' : 'OFF'}`;
    btn.classList.toggle('active', OFFICE_STATE.autoCollabEnabled);
  }
}

// ═══════════════════════════════════════════════════════════
//  OFFICE PAGE TABS
// ═══════════════════════════════════════════════════════════
function switchOfficeTab(tab) {
  ['employees','teamchat','workflows','vault','whatsapp'].forEach(t => {
    document.getElementById(`otp-${t}`).style.display = t === tab ? '' : 'none';
    const btn = document.getElementById(`otab-${t}`);
    if (btn) btn.classList.toggle('active', t === tab);
  });
  lucide.createIcons();
  if (tab === 'workflows') loadWorkflows();
  if (tab === 'teamchat')  loadTeamSessionHistory();
  if (tab === 'vault')     loadVault();
  if (tab === 'whatsapp')  loadWAStatus();
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.getElementById('wf-modal').style.display        = 'none';
    document.getElementById('wf-runs-modal').style.display   = 'none';
    document.getElementById('emp-memory-modal').style.display = 'none';
    document.getElementById('vault-modal').style.display     = 'none';
  }
});

// Make sure the employees panel is the default display
document.addEventListener('DOMContentLoaded', () => {
  const emp = document.getElementById('otp-employees');
  if (emp) emp.style.display = '';
});

// ═══════════════════════════════════════════════════════════
//  EMPLOYEE MEMORY PANEL
// ═══════════════════════════════════════════════════════════
async function showEmpMemory(empId) {
  const modal = document.getElementById('emp-memory-modal');
  const title = document.getElementById('emp-memory-title');
  const list  = document.getElementById('emp-memory-list');
  const names = {aria:'ARIA',nexus:'NEXUS',cipher:'CIPHER',vega:'VEGA'};
  title.textContent = `${names[empId]||empId} — Memory & Learnings`;
  list.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:16px">Loading...</div>';
  modal.style.display = 'flex';

  const data = await api(`/api/office/memory/${empId}`);
  if (!data || !data.memories || !data.memories.length) {
    list.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:16px">No memories yet — run some tasks first.</div>';
    return;
  }
  list.innerHTML = data.memories.map(m => `
    <div style="border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:10px;background:rgba(11,17,34,0.8)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <span style="font-size:10px;background:rgba(0,212,255,0.1);color:var(--cyan);padding:2px 7px;border-radius:4px;font-weight:600">${m.task_type||'task'}</span>
        <span style="font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace">${m.created_at ? new Date(m.created_at).toLocaleString() : ''}</span>
      </div>
      <div style="font-size:11px;color:var(--text);margin-bottom:6px;font-weight:600">${m.task_summary||''}</div>
      <div style="font-size:11px;color:var(--muted);line-height:1.6;white-space:pre-wrap">${m.key_learnings||m.outcome_summary||''}</div>
    </div>
  `).join('');
}

// ═══════════════════════════════════════════════════════════
//  WORKFLOW BUILDER
// ═══════════════════════════════════════════════════════════
let _wfEditId = null;

const WF_PROMPT_TEMPLATES = {
  'alarm-analysis': 'Analyze the alarm "{alarm_name}" on host {host} (severity: {severity}). Diagnose the probable root cause, assess the business impact, and recommend an immediate action plan with specific steps.',
  'daily-check': 'Perform your daily operational check. Review the current network health, identify any concerns or trends, and provide a concise status summary with your top 3 action items for today.',
  'security-review': 'Conduct a security posture review. Check for any anomalies in firewall logs, unauthorized access attempts, policy violations, or suspicious traffic patterns. Report findings and recommended mitigations.',
  'capacity': 'Generate a capacity report. Analyze current bandwidth utilization, device CPU/memory trends, and storage consumption. Identify any resources approaching limits and recommend scaling actions.',
};

async function loadWorkflows() {
  const grid = document.getElementById('workflows-grid');
  grid.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:32px;text-align:center;grid-column:1/-1">Loading...</div>';
  const wfs = await api('/api/workflows') || [];
  if (!wfs.length) {
    grid.innerHTML = `<div style="color:var(--muted);font-size:12px;padding:32px;text-align:center;grid-column:1/-1">
      No workflows yet.<br><br>
      <button class="ofc-btn ofc-btn-assign" onclick="openCreateWorkflowModal()">+ Create your first workflow</button>
    </div>`;
    return;
  }
  const empColors = {aria:'#00d4ff',nexus:'#a855f7',cipher:'#ff8c00',vega:'#4ade80'};
  const empNames  = {aria:'ARIA',nexus:'NEXUS',cipher:'CIPHER',vega:'VEGA'};
  const trigIcons = {manual:'🖱️',alarm:'🔔',schedule:'🕐'};
  const actIcons  = {log:'📝',webhook:'🌐',zabbix_ack:'✅',whatsapp_group:'📱'};
  grid.innerHTML = wfs.map(w => {
    const tc = w.trigger_config ? (typeof w.trigger_config==='string'?JSON.parse(w.trigger_config):w.trigger_config) : {};
    let trigDetail = '';
    if (w.trigger_type==='alarm') {
      const sevLabels = {0:'Any alarm',3:'Avg+',4:'High+',5:'Disaster'};
      trigDetail = sevLabels[tc.severity_min] || `sev≥${tc.severity_min}`;
      if (tc.host_filter) trigDetail += ` · ${tc.host_filter}`;
    } else if (w.trigger_type==='schedule') {
      trigDetail = tc.cron || '';
    }
    const empColor = empColors[w.employee_id] || '#8aa0c0';
    const empLabel = empNames[w.employee_id]  || w.employee_id;
    return `
    <div class="wf-card" id="wf-${w.id}">
      <div class="wf-card-top">
        <div class="wf-name">${w.name}</div>
        <div class="wf-active-badge ${w.is_active ? 'active' : 'inactive'}">${w.is_active ? '● ON' : '○ OFF'}</div>
      </div>
      <div class="wf-meta">
        <span class="wf-badge ${w.trigger_type}">${trigIcons[w.trigger_type]||''} ${w.trigger_type}${trigDetail?' · '+trigDetail:''}</span>
        <span style="font-size:10px;font-weight:700;color:${empColor};background:rgba(255,255,255,0.04);border:1px solid ${empColor}33;padding:2px 6px;border-radius:5px">${empLabel}</span>
        <span class="wf-badge" style="background:rgba(168,85,247,0.1);color:#a855f7;border-color:rgba(168,85,247,0.25)">${actIcons[w.action_type]||''} ${w.action_type}</span>
      </div>
      ${w.prompt_template ? `<div class="wf-prompt-preview" title="${w.prompt_template.replace(/"/g,'&quot;')}">${w.prompt_template.substring(0,90)}${w.prompt_template.length>90?'…':''}</div>` : ''}
      <div class="wf-actions">
        <button class="wf-btn run" onclick="triggerWorkflow(${w.id},'${w.name.replace(/'/g,"\\'")}')">▶ Run Now</button>
        <button class="wf-btn" onclick="viewWfRuns(${w.id},'${w.name.replace(/'/g,"\\'")}')">📋 History</button>
        <button class="wf-btn" onclick="openEditWorkflowModal(${w.id})">✏️ Edit</button>
        <button class="wf-btn del" onclick="deleteWorkflow(${w.id})">🗑 Delete</button>
      </div>
    </div>`;
  }).join('');
}

// Card-based trigger/employee/action selectors
function wfSelectTrigger(t) {
  ['manual','alarm','schedule'].forEach(v => {
    document.getElementById(`wtc-${v}`).classList.toggle('active', v===t);
  });
  document.getElementById('wf-f-trigger').value = t;
  document.getElementById('wf-trigger-alarm').style.display    = t==='alarm'    ? '' : 'none';
  document.getElementById('wf-trigger-schedule').style.display = t==='schedule' ? '' : 'none';
}
function wfSelectEmp(e) {
  ['aria','nexus','cipher','vega'].forEach(v => {
    document.getElementById(`wec-${v}`).classList.toggle('active', v===e);
  });
  document.getElementById('wf-f-employee').value = e;
}
function wfSelectAction(a) {
  ['log','webhook','zabbix_ack','whatsapp_group'].forEach(v => {
    document.getElementById(`wac-${v}`).classList.toggle('active', v===a);
  });
  document.getElementById('wf-f-action').value = a;
  document.getElementById('wf-action-webhook').style.display        = a==='webhook'         ? '' : 'none';
  document.getElementById('wf-action-whatsapp_group').style.display = a==='whatsapp_group'  ? '' : 'none';
}
async function wfLoadGroups() {
  const empId  = document.getElementById('wf-f-wa-emp').value;
  const sel    = document.getElementById('wf-f-wa-group');
  const status = document.getElementById('wf-wa-groups-status');
  status.textContent = 'Loading groups…'; status.style.color = 'var(--muted)';
  try {
    const r = await fetch(`/api/workflows/wa/groups/${empId}`, { credentials:'include' });
    const groups = await r.json();
    if (groups.error) throw new Error(groups.error);
    if (!groups.length) {
      sel.innerHTML = '<option value="">— no groups found (employee not in any group) —</option>';
      status.textContent = 'No groups found. Add the employee to a WhatsApp group first.';
      status.style.color = '#ffb300';
      return;
    }
    sel.innerHTML = '<option value="">— Select a group —</option>' +
      groups.map(g => `<option value="${g.jid}" data-name="${g.name.replace(/"/g,'&quot;')}">${g.name} (${g.participants} members)</option>`).join('');
    status.textContent = `✓ ${groups.length} group(s) loaded.`; status.style.color = '#4ade80';
  } catch(e) {
    status.textContent = `✗ ${e.message}`; status.style.color = '#f87171';
    sel.innerHTML = '<option value="">— Error loading groups —</option>';
  }
}
async function wfTestWebhook() {
  const url = document.getElementById('wf-f-webhook-url').value.trim();
  const res  = document.getElementById('wf-webhook-test-result');
  if (!url) { res.textContent = '⚠ Enter a URL first'; res.style.color='#ffb300'; return; }
  res.textContent = 'Sending...'; res.style.color = 'var(--muted)';
  try {
    const r = await fetch('/api/workflows/test-webhook', {
      method:'POST', credentials:'include',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ url, payload: {workflow:'Test Ping', employee:'aria', trigger:{type:'test'}, ai_response:'This is a test ping from NOC Sentinel workflow builder.'} })
    });
    const d = await r.json();
    if (d.ok) { res.textContent = `✓ ${d.status}`; res.style.color='#4ade80'; }
    else       { res.textContent = `✗ ${d.error||'failed'}`; res.style.color='#f87171'; }
  } catch(e) { res.textContent = `✗ ${e.message}`; res.style.color='#f87171'; }
}
function wfApplySchedPreset() {
  const sel = document.getElementById('wf-f-sched-preset');
  const cronEl = document.getElementById('wf-f-cron');
  if (sel.value === 'custom') {
    cronEl.style.display = '';
    cronEl.focus();
  } else {
    cronEl.style.display = 'none';
    cronEl.value = sel.value;
  }
}
function wfFillPrompt(tpl) {
  document.getElementById('wf-f-prompt').value = WF_PROMPT_TEMPLATES[tpl] || '';
}

// Severity label → number sync
document.addEventListener('change', e => {
  if (e.target.id === 'wf-f-severity-label') {
    document.getElementById('wf-f-severity').value = e.target.value;
  }
});

function openCreateWorkflowModal() {
  _wfEditId = null;
  document.getElementById('wf-modal-title').textContent = 'New Workflow';
  document.getElementById('wf-f-name').value = '';
  document.getElementById('wf-f-prompt').value = '';
  document.getElementById('wf-f-hostfilter').value = '';
  document.getElementById('wf-f-webhook-url').value = '';
  document.getElementById('wf-f-wa-emp').value = 'aria';
  document.getElementById('wf-f-wa-group').innerHTML = '<option value="">— click Load Groups first —</option>';
  document.getElementById('wf-wa-groups-status').textContent = '';
  document.getElementById('wf-f-active').checked = true;
  document.getElementById('wf-f-cron').value = '0 8 * * *';
  document.getElementById('wf-f-cron').style.display = 'none';
  document.getElementById('wf-f-sched-preset').value = '0 8 * * *';
  wfSelectTrigger('manual');
  wfSelectEmp('aria');
  wfSelectAction('log');
  document.getElementById('wf-modal').style.display = 'flex';
}

async function openEditWorkflowModal(id) {
  const wf = await api(`/api/workflows/${id}`);
  if (!wf) return;
  _wfEditId = id;
  document.getElementById('wf-modal-title').textContent = 'Edit Workflow';
  document.getElementById('wf-f-name').value = wf.name || '';
  document.getElementById('wf-f-prompt').value = wf.prompt_template || '';
  document.getElementById('wf-f-active').checked = !!wf.is_active;
  const tc = wf.trigger_config ? (typeof wf.trigger_config==='string'?JSON.parse(wf.trigger_config):wf.trigger_config) : {};
  const ac = wf.action_config  ? (typeof wf.action_config ==='string'?JSON.parse(wf.action_config ):wf.action_config ) : {};
  document.getElementById('wf-f-hostfilter').value = tc.host_filter || '';
  const sevMap = {0:'0',3:'3',4:'4',5:'5'};
  document.getElementById('wf-f-severity-label').value = sevMap[tc.severity_min] || '3';
  document.getElementById('wf-f-severity').value = tc.severity_min ?? 3;
  const cron = tc.cron || '0 8 * * *';
  document.getElementById('wf-f-cron').value = cron;
  const presetOpts = ['0 8 * * *','0 18 * * *','0 * * * *','0 9 * * 1','0 0 * * *'];
  const isCustom = !presetOpts.includes(cron);
  document.getElementById('wf-f-sched-preset').value = isCustom ? 'custom' : cron;
  document.getElementById('wf-f-cron').style.display = isCustom ? '' : 'none';
  document.getElementById('wf-f-webhook-url').value = ac.url || '';
  // Restore WhatsApp group config if any
  if (wf.action_type === 'whatsapp_group' && ac.group_jid) {
    document.getElementById('wf-f-wa-emp').value = ac.emp_id || 'aria';
    const grpSel = document.getElementById('wf-f-wa-group');
    grpSel.innerHTML = `<option value="${ac.group_jid}">${ac.group_name || ac.group_jid}</option>`;
    document.getElementById('wf-wa-groups-status').textContent = 'Saved group loaded. You can reload to refresh the list.';
  } else {
    document.getElementById('wf-f-wa-emp').value = 'aria';
    document.getElementById('wf-f-wa-group').innerHTML = '<option value="">— click Load Groups first —</option>';
    document.getElementById('wf-wa-groups-status').textContent = '';
  }
  wfSelectTrigger(wf.trigger_type || 'manual');
  wfSelectEmp(wf.employee_id || 'aria');
  wfSelectAction(wf.action_type || 'log');
  document.getElementById('wf-modal').style.display = 'flex';
}

function closeWfModal() { document.getElementById('wf-modal').style.display = 'none'; }

async function saveWorkflow() {
  const name = document.getElementById('wf-f-name').value.trim();
  if (!name) { document.getElementById('wf-f-name').focus(); return; }
  const trigger_type = document.getElementById('wf-f-trigger').value;
  let trigger_config = {};
  if (trigger_type === 'alarm') {
    trigger_config = {
      severity_min: parseInt(document.getElementById('wf-f-severity').value) || 3,
      host_filter:  document.getElementById('wf-f-hostfilter').value.trim(),
    };
  } else if (trigger_type === 'schedule') {
    trigger_config = { cron: document.getElementById('wf-f-cron').value.trim() || '0 8 * * *' };
  }
  const action_type = document.getElementById('wf-f-action').value;
  let action_config = {};
  if (action_type === 'webhook') {
    action_config = { url: document.getElementById('wf-f-webhook-url').value.trim() };
  } else if (action_type === 'whatsapp_group') {
    const grpSel  = document.getElementById('wf-f-wa-group');
    const grpJid  = grpSel.value;
    const grpName = grpSel.options[grpSel.selectedIndex]?.dataset?.name || grpSel.options[grpSel.selectedIndex]?.text || grpJid;
    if (!grpJid) { showToast('Select a WhatsApp group first.', 'warn'); return; }
    action_config = {
      emp_id:     document.getElementById('wf-f-wa-emp').value,
      group_jid:  grpJid,
      group_name: grpName,
    };
  }
  const body = {
    name,
    description:     '',
    trigger_type,
    trigger_config:  JSON.stringify(trigger_config),
    employee_id:     document.getElementById('wf-f-employee').value,
    prompt_template: document.getElementById('wf-f-prompt').value.trim(),
    action_type,
    action_config:   JSON.stringify(action_config),
    is_active:       document.getElementById('wf-f-active').checked ? 1 : 0,
  };
  const url    = _wfEditId ? `/api/workflows/${_wfEditId}` : '/api/workflows';
  const method = _wfEditId ? 'PUT' : 'POST';
  const r = await api(url, { method, body: JSON.stringify(body) });
  if (r) { closeWfModal(); loadWorkflows(); }
}

async function triggerWorkflow(id, name) {
  if (!confirm(`Run "${name}" now?`)) return;
  const r = await api(`/api/workflows/${id}/trigger`, { method: 'POST', body: '{}' });
  if (r?.ok) { alert('Workflow triggered! Check History to see the result.'); }
}

async function viewWfRuns(id, name) {
  const modal = document.getElementById('wf-runs-modal');
  document.getElementById('wf-runs-title').textContent = `Run History — ${name}`;
  document.getElementById('wf-runs-list').innerHTML = '<div style="color:var(--muted);font-size:12px;padding:16px">Loading...</div>';
  modal.style.display = 'flex';
  const runs = await api(`/api/workflows/${id}/runs`) || [];
  if (!runs.length) {
    document.getElementById('wf-runs-list').innerHTML = '<div style="color:var(--muted);font-size:12px;padding:16px">No runs yet. Click ▶ Run Now to trigger manually.</div>';
    return;
  }
  const statusColor = {success:'#4ade80',error:'#ef4444',running:'#fbbf24'};
  document.getElementById('wf-runs-list').innerHTML = runs.map(r => `
    <div style="border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:10px;background:rgba(11,17,34,0.8)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <span style="font-size:10px;color:${statusColor[r.status]||'#fff'};font-weight:700">● ${(r.status||'').toUpperCase()}</span>
        <span style="font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-left:auto">${r.created_at||''}</span>
      </div>
      ${r.ai_response ? `<div style="font-size:11px;color:var(--text);line-height:1.6;white-space:pre-wrap;max-height:200px;overflow-y:auto">${r.ai_response.substring(0,600)}${r.ai_response.length>600?'…':''}</div>` : ''}
      ${r.action_result ? `<div style="font-size:10px;color:var(--muted);margin-top:6px;font-family:'JetBrains Mono',monospace">Action: ${r.action_result}</div>` : ''}
    </div>
  `).join('');
}

async function deleteWorkflow(id) {
  if (!confirm('Delete this workflow?')) return;
  const r = await api(`/api/workflows/${id}`, { method: 'DELETE' });
  if (r) loadWorkflows();
}

// ═══════════════════════════════════════════════════════════
//  VAULT
// ═══════════════════════════════════════════════════════════
let _vaultEditId  = null;
let _vaultEntries = [];

async function loadVault() {
  const grid = document.getElementById('vault-grid');
  grid.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:32px;text-align:center;grid-column:1/-1">Loading...</div>';
  _vaultEntries = await api('/api/vault') || [];
  _renderVault(_vaultEntries);
  _renderVaultCats(_vaultEntries);
}

function _renderVaultCats(entries) {
  const cats = ['All', ...new Set(entries.map(e=>e.category).filter(Boolean))];
  document.getElementById('vault-cats').innerHTML = cats.map(c => `
    <button class="vault-cat-btn ${c==='All'?'active':''}" onclick="filterVaultCat('${c}',this)">${c}</button>
  `).join('');
}

function filterVaultCat(cat, btn) {
  document.querySelectorAll('.vault-cat-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const filtered = cat==='All' ? _vaultEntries : _vaultEntries.filter(e=>e.category===cat);
  _renderVault(filtered);
}

function _renderVault(entries) {
  const grid = document.getElementById('vault-grid');
  if (!entries.length) {
    grid.innerHTML = `<div style="color:var(--muted);font-size:12px;padding:32px;text-align:center;grid-column:1/-1">
      No entries yet.<br><br>
      <button class="ofc-btn ofc-btn-autocollab" onclick="openVaultModal()" style="background:rgba(168,142,238,0.1);border-color:#a88eee;color:#c8b4ff">+ Add first entry</button>
    </div>`;
    return;
  }
  grid.innerHTML = entries.map(v => `
    <div class="vault-card">
      <div class="vault-card-top">
        <div class="vault-card-name">${v.name}</div>
        <div class="vault-cat-badge">${v.category||'Other'}</div>
      </div>
      <div class="vault-val-row">
        <div class="vault-val" id="vval-${v.id}">${v.value_masked||'••••••••'}</div>
        <button class="vault-show-btn" onclick="vaultRevealEntry(${v.id})" title="Reveal">👁</button>
      </div>
      ${v.notes ? `<div class="vault-notes">${v.notes}</div>` : ''}
      <div class="vault-footer">
        <span class="vault-ai-badge ${v.share_with_ai?'on':'off'}">${v.share_with_ai?'🤖 AI can use':'⛔ AI hidden'}</span>
        <span style="flex:1"></span>
        <button class="vault-btn edit" onclick="openVaultModal(${v.id})">Edit</button>
        <button class="vault-btn del" onclick="deleteVaultEntry(${v.id})">Delete</button>
      </div>
    </div>
  `).join('');
}

async function vaultRevealEntry(id) {
  const full = await api(`/api/vault/${id}`);
  if (!full) return;
  const el = document.getElementById(`vval-${id}`);
  if (el) {
    if (el.dataset.revealed) {
      el.textContent = _vaultEntries.find(v=>v.id===id)?.value_masked || '••••••••';
      delete el.dataset.revealed;
    } else {
      el.textContent = full.value;
      el.dataset.revealed = '1';
    }
  }
}

function openVaultModal(id=null) {
  _vaultEditId = id;
  document.getElementById('vault-modal-title').textContent = id ? 'Edit Vault Entry' : 'Add Vault Entry';
  if (id) {
    const entry = _vaultEntries.find(v=>v.id===id);
    if (entry) {
      document.getElementById('vault-f-name').value     = entry.name || '';
      document.getElementById('vault-f-category').value = entry.category || 'Other';
      document.getElementById('vault-f-notes').value    = entry.notes || '';
      document.getElementById('vault-f-share').checked  = !!entry.share_with_ai;
      // Fetch full value for edit
      api(`/api/vault/${id}`).then(full => {
        if (full) document.getElementById('vault-f-value').value = full.value || '';
      });
    }
  } else {
    document.getElementById('vault-f-name').value     = '';
    document.getElementById('vault-f-category').value = 'Zabbix';
    document.getElementById('vault-f-value').value    = '';
    document.getElementById('vault-f-notes').value    = '';
    document.getElementById('vault-f-share').checked  = true;
  }
  document.getElementById('vault-f-value').type = 'password';
  document.getElementById('vault-reveal-btn').textContent = '👁';
  document.getElementById('vault-modal').style.display = 'flex';
}

function closeVaultModal() { document.getElementById('vault-modal').style.display = 'none'; }

function vaultToggleReveal() {
  const inp = document.getElementById('vault-f-value');
  const btn = document.getElementById('vault-reveal-btn');
  if (inp.type === 'password') { inp.type='text';  btn.textContent='🙈'; }
  else                         { inp.type='password'; btn.textContent='👁'; }
}

async function saveVaultEntry() {
  const name = document.getElementById('vault-f-name').value.trim();
  const value = document.getElementById('vault-f-value').value;
  if (!name)  { document.getElementById('vault-f-name').focus(); return; }
  if (!value) { document.getElementById('vault-f-value').focus(); return; }
  const body = {
    name,
    category:     document.getElementById('vault-f-category').value,
    value,
    notes:        document.getElementById('vault-f-notes').value.trim(),
    share_with_ai: document.getElementById('vault-f-share').checked ? 1 : 0,
  };
  const url    = _vaultEditId ? `/api/vault/${_vaultEditId}` : '/api/vault';
  const method = _vaultEditId ? 'PUT' : 'POST';
  const r = await api(url, { method, body: JSON.stringify(body) });
  if (r) { closeVaultModal(); loadVault(); }
}

async function deleteVaultEntry(id) {
  if (!confirm('Delete this vault entry?')) return;
  const r = await api(`/api/vault/${id}`, { method: 'DELETE' });
  if (r) loadVault();
}

// ═══════════════════════════════════════════════════════════
//  WHATSAPP GATEWAY
// ═══════════════════════════════════════════════════════════
const WA_SERVICE = '/api/workflows/wa';  // proxied through FastAPI — works for remote browsers
let _waRefreshTimer = null;

async function loadWAStatus() {
  const grid   = document.getElementById('wa-grid');
  const badge  = document.getElementById('wa-svc-badge');
  const note   = document.getElementById('wa-setup-note');
  if (!grid) return;

  try {
    const r = await fetch(`${WA_SERVICE}/status`, { credentials: 'include', signal: AbortSignal.timeout(8000) });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();

    badge.textContent = '● Service online';
    badge.style.cssText = 'color:#4ade80;border-color:rgba(74,222,128,0.3);background:rgba(74,222,128,0.08)';
    // Show setup guide if any employee is not yet connected (still needs QR scan)
    const anyNotConnected = Object.values(data).some(d => d.status !== 'connected');
    note.style.display = anyNotConnected ? '' : 'none';

    const empIds = ['aria','nexus','cipher','vega'];
    grid.innerHTML = empIds.map(empId => {
      const d = data[empId] || {};
      const st = d.status || 'disconnected';
      const stLabel = {connected:'Connected',qr:'Scan QR',connecting:'Connecting…',disconnected:'Offline'}[st] || st;
      const color = d.color || '#888';

      let middle = '';
      if (st === 'qr' && d.qr) {
        middle = `<div class="wa-qr-wrap">
          <img src="${d.qr}" alt="QR code">
          <div class="wa-qr-hint">
            Register a <b>TextNow</b> number → install WhatsApp → verify SMS<br>
            Then: <b>Settings → Linked Devices → Link a Device → Scan this QR</b>
          </div>
        </div>`;
      } else if (st === 'connected' && d.phone) {
        middle = `<div class="wa-phone">+${d.phone}</div>
          <div class="wa-msg-row" id="wa-msgs-${empId}">
            <div style="font-size:10px;color:var(--muted);font-style:italic">Loading recent messages...</div>
          </div>`;
        setTimeout(() => loadWAMsgs(empId), 100);
      } else if (st === 'connecting') {
        middle = `<div style="font-size:11px;color:var(--muted);margin-top:4px">Initializing connection...</div>`;
      } else {
        middle = `<div style="font-size:11px;color:var(--muted);margin-top:4px">Not connected — service may be offline</div>`;
      }

      return `<div class="wa-card">
        <div class="wa-card-top">
          <div class="wa-emp-dot ${st}" style="background:${st==='connected'?'#25d366':st==='qr'?'#ffb300':st==='connecting'?color:'#555'}"></div>
          <div>
            <div class="wa-emp-name" style="color:${color}">${d.name||empId.toUpperCase()}</div>
            <div style="font-size:10px;color:var(--muted)">${d.role||''}</div>
          </div>
          <div class="wa-status-badge ${st}">${stLabel}</div>
        </div>
        ${middle}
        <div class="wa-btn-row">
          <button class="wa-btn reconnect" onclick="waReconnect('${empId}')">↺ Reconnect</button>
          ${st==='connected' ? `<button class="wa-btn logout" onclick="waLogout('${empId}')">Log Out</button>` : ''}
        </div>
      </div>`;
    }).join('');

    // Auto-refresh every 8s while on this tab
    clearTimeout(_waRefreshTimer);
    _waRefreshTimer = setTimeout(() => {
      if (document.getElementById('otp-whatsapp')?.style.display !== 'none') loadWAStatus();
    }, 8000);

  } catch(e) {
    badge.textContent = '● Service offline';
    badge.style.cssText = 'color:#f87171;border-color:rgba(248,113,113,0.3);background:rgba(248,113,113,0.06)';
    note.style.display = '';
    grid.innerHTML = `<div style="grid-column:1/-1;padding:32px;text-align:center">
      <div style="font-size:13px;font-weight:600;color:#f87171;margin-bottom:8px">WhatsApp service not running</div>
      <div style="font-size:11px;color:var(--muted);line-height:1.6">
        Start it with:<br>
        <code style="background:rgba(0,0,0,0.4);padding:4px 10px;border-radius:4px;color:#7de0a0;font-size:11px">cd whatsapp &amp;&amp; node index.js</code>
      </div>
    </div>`;
  }
}

async function loadWAMsgs(empId) {
  try {
    const r = await fetch(`${WA_SERVICE}/log/${empId}`, { credentials: 'include', signal: AbortSignal.timeout(5000) });
    const msgs = await r.json();
    const el = document.getElementById(`wa-msgs-${empId}`);
    if (!el) return;
    if (!msgs.length) { el.innerHTML = '<div style="font-size:10px;color:var(--muted);font-style:italic">No messages yet</div>'; return; }
    el.innerHTML = msgs.slice(0,5).map(m => {
      const ts = new Date(m.ts).toLocaleTimeString('en',{hour12:false,hour:'2-digit',minute:'2-digit'});
      return `<div class="wa-msg-item"><b>+${m.from}</b> [${ts}]: ${m.text.substring(0,60)}${m.text.length>60?'…':''}</div>`;
    }).join('');
  } catch {}
}

async function waLogout(empId) {
  if (!confirm(`Log out ${empId.toUpperCase()} from WhatsApp? They will need to re-scan QR.`)) return;
  try {
    await fetch(`${WA_SERVICE}/logout/${empId}`, { method: 'DELETE', credentials: 'include' });
    loadWAStatus();
  } catch(e) { alert('Could not reach WhatsApp service: ' + e.message); }
}

async function waReconnect(empId) {
  try {
    await fetch(`${WA_SERVICE}/reconnect/${empId}`, { method: 'POST', credentials: 'include' });
    setTimeout(loadWAStatus, 2000);
  } catch(e) { alert('Could not reach WhatsApp service: ' + e.message); }
}

// ═══════════════════════════════════════════════════════════
//  TEAM CHAT / COLLABORATION
// ═══════════════════════════════════════════════════════════
const EMP_COLORS = {aria:'#00d4ff',nexus:'#a855f7',cipher:'#ff8c00',vega:'#4ade80'};
const EMP_NAMES  = {aria:'ARIA',nexus:'NEXUS',cipher:'CIPHER',vega:'VEGA'};
let _tcXhr = null;

async function startTeamChat() {
  const topic = document.getElementById('tc-topic').value.trim();
  if (!topic) { document.getElementById('tc-topic').focus(); return; }

  const participants = [...document.querySelectorAll('.tc-chk:checked')].map(c => c.value);
  if (!participants.length) { alert('Select at least one participant'); return; }

  const rounds  = parseInt(document.getElementById('tc-rounds').value) || 2;
  const useNet  = document.getElementById('tc-use-net-ctx').checked;
  const provider= document.getElementById('ofc-provider-sel')?.value || 'claude';
  const modelId = document.getElementById('ofc-model-sel')?.value  || '';

  // Clear previous session from view
  const chatArea = document.getElementById('tc-chat-area');
  const emptyState = document.getElementById('tc-empty-state');
  if (emptyState) emptyState.style.display = 'none';
  chatArea.innerHTML = '';

  // Build network context
  const netCtx = useNet ? {
    stats:  { total: Object.keys(S.zabbixHosts||{}).length,
              ok: Object.values(S.zabbixHosts||{}).filter(h=>!h.problem_count).length,
              with_problems: Object.values(S.zabbixHosts||{}).filter(h=>h.problem_count>0).length,
              alarms: (S.zabbixProblems||[]).length },
    alarms: (S.zabbixProblems||[]).slice(0,10).map(p=>({name:p.name,severity:parseInt(p.severity)||0})),
    hosts:  Object.values(S.zabbixHosts||{}).filter(h=>h.problem_count>0).slice(0,8).map(h=>({host:h.host||h.name,problems:h.problem_count})),
  } : {};

  const btn = document.getElementById('tc-start-btn');
  btn.disabled = true; btn.textContent = '⏳ Running...';

  if (_tcXhr) { try { _tcXhr.abort(); } catch {} }
  _tcXhr = new XMLHttpRequest();
  _tcXhr.open('POST', '/api/office/collaborate', true);
  _tcXhr.setRequestHeader('Content-Type', 'application/json');
  _tcXhr.withCredentials = true;

  let xhrPos = 0;
  let currentTurnDiv = null;
  let currentBodyDiv = null;
  let currentEmpId   = null;

  function _processChunk(chunk) {
    const lines = chunk.split('\n');
    for (const line of lines) {
      const t = line.trim();
      if (!t.startsWith('data: ')) continue;
      const raw = t.slice(6);
      if (!raw || raw === '{}') continue;
      try {
        const ev = JSON.parse(raw);
        if (ev.turn_start) {
          currentEmpId = ev.turn_start;
          const clr = ev.color || EMP_COLORS[ev.turn_start] || '#8aa0c0';
          currentTurnDiv = document.createElement('div');
          currentTurnDiv.className = 'tc-turn';
          currentTurnDiv.style.setProperty('--tc-clr', clr);
          currentTurnDiv.innerHTML = `
            <div class="tc-turn-header">
              <div class="tc-turn-name">${ev.name||EMP_NAMES[ev.turn_start]||ev.turn_start}</div>
              <div class="tc-turn-round">Round ${ev.round||1}</div>
            </div>
          `;
          currentBodyDiv = document.createElement('div');
          currentBodyDiv.className = 'tc-turn-body';
          currentBodyDiv.innerHTML = '<div class="tc-typing"><span></span><span></span><span></span></div>';
          currentTurnDiv.appendChild(currentBodyDiv);
          chatArea.appendChild(currentTurnDiv);
          chatArea.scrollTop = chatArea.scrollHeight;
        } else if (ev.speaker && ev.t) {
          if (currentBodyDiv) {
            // Remove typing indicator on first text
            const typing = currentBodyDiv.querySelector('.tc-typing');
            if (typing) typing.remove();
            currentBodyDiv.textContent += ev.t;
            chatArea.scrollTop = chatArea.scrollHeight;
          }
        } else if (ev.speaker && ev.error) {
          if (currentBodyDiv) {
            const typing = currentBodyDiv.querySelector('.tc-typing');
            if (typing) typing.remove();
            currentBodyDiv.textContent = '[ERROR] ' + ev.error;
            currentBodyDiv.style.color = '#ef4444';
          }
        }
      } catch {}
    }
  }

  _tcXhr.onprogress = function() {
    const chunk = _tcXhr.responseText.slice(xhrPos);
    xhrPos = _tcXhr.responseText.length;
    _processChunk(chunk);
  };

  _tcXhr.onload = function() {
    _processChunk(_tcXhr.responseText.slice(xhrPos));
    btn.disabled = false; btn.textContent = '▶ Start Session';
    // Refresh history
    loadTeamSessionHistory();
    _addFeedItem('system', `Team chat: "${topic.substring(0,40)}" completed`, '#a855f7');
  };

  _tcXhr.onerror = function() {
    btn.disabled = false; btn.textContent = '▶ Start Session';
    if (currentBodyDiv) currentBodyDiv.textContent = '[Network error — check connection]';
  };

  _tcXhr.ontimeout = function() {
    btn.disabled = false; btn.textContent = '▶ Start Session';
  };

  _tcXhr.timeout = 300000; // 5 min
  _tcXhr.send(JSON.stringify({
    topic, participants, rounds,
    network_context: netCtx, provider, model_id: modelId,
  }));
}

async function loadTeamSessionHistory() {
  const list = document.getElementById('tc-history-list');
  if (!list) return;
  const sessions = await api('/api/office/team-sessions') || [];
  if (!sessions.length) {
    list.innerHTML = '<div style="color:var(--muted);font-size:11px;padding:8px 0">No sessions yet.</div>';
    return;
  }
  list.innerHTML = sessions.map(s => `
    <div class="tc-hist-item" onclick="viewTeamSession(${s.id})">
      <div class="tc-hist-topic">${s.topic||'Untitled'}</div>
      <div class="tc-hist-meta">${(s.participants||[]).map(p=>(EMP_NAMES[p]||p)).join(' · ')} · ${s.created_at ? new Date(s.created_at).toLocaleDateString() : ''}</div>
    </div>
  `).join('');
}

async function viewTeamSession(sessionId) {
  const data = await api(`/api/office/team-sessions/${sessionId}`);
  if (!data || !data.transcript) return;
  const chatArea = document.getElementById('tc-chat-area');
  const emptyState = document.getElementById('tc-empty-state');
  if (emptyState) emptyState.style.display = 'none';
  chatArea.innerHTML = `<div style="font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:8px">Session #${sessionId} — ${data.created_at||''}</div>`;
  data.transcript.forEach(turn => {
    const clr = EMP_COLORS[turn.speaker] || '#8aa0c0';
    const div = document.createElement('div');
    div.className = 'tc-turn';
    div.style.setProperty('--tc-clr', clr);
    div.innerHTML = `
      <div class="tc-turn-header"><div class="tc-turn-name">${turn.name||turn.speaker}</div></div>
      <div class="tc-turn-body">${turn.text||''}</div>
    `;
    chatArea.appendChild(div);
  });
  chatArea.scrollTop = 0;
}

// Auto-init if already logged in (PHP session)

document.addEventListener('DOMContentLoaded', init);

document.getElementById('l-user').focus();
dismissSplash('AUTHENTICATION REQUIRED');


// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));

// ── INLINE SPARKLINE GRAPHS ────────────────────────────────
function formatMetricValue(value, units){
  const v = parseFloat(value);
  if(isNaN(v)) return '—';
  if(units==='%') return v.toFixed(1)+'%';
  if(units==='bps'||units==='Bps') return formatBps(v*8);
  if(units==='B'){
    if(v>=1e9) return (v/1e9).toFixed(1)+'GB';
    if(v>=1e6) return (v/1e6).toFixed(1)+'MB';
    if(v>=1e3) return (v/1e3).toFixed(1)+'KB';
    return v+'B';
  }
  if(Math.abs(v)>=1e6) return (v/1e6).toFixed(1)+'M';
  if(Math.abs(v)>=1e3) return (v/1e3).toFixed(1)+'K';
  return v%1===0 ? v.toString() : v.toFixed(2);
}

function drawSparkline(canvas, points, accentColor){
  accentColor = accentColor||'#00d4ff';
  const ctx=canvas.getContext('2d');
  const W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H);
  if(points.length<2) return;
  const vals=points.map(p=>p.v);
  const min=Math.min(...vals), max=Math.max(...vals);
  const range=max-min||1;
  const px=3;
  const xOf=i=>px+(i/(points.length-1))*(W-2*px);
  const yOf=v=>H-px-((v-min)/range)*(H-2*px);
  // gradient fill
  const grd=ctx.createLinearGradient(0,0,0,H);
  grd.addColorStop(0,accentColor+'55');
  grd.addColorStop(1,accentColor+'08');
  ctx.beginPath();
  ctx.moveTo(xOf(0),H);
  ctx.lineTo(xOf(0),yOf(points[0].v));
  points.forEach((p,i)=>ctx.lineTo(xOf(i),yOf(p.v)));
  ctx.lineTo(xOf(points.length-1),H);
  ctx.closePath();
  ctx.fillStyle=grd;
  ctx.fill();
  // line
  ctx.beginPath();
  ctx.strokeStyle=accentColor;
  ctx.lineWidth=1.5;
  ctx.lineJoin='round';
  points.forEach((p,i)=>i===0?ctx.moveTo(xOf(i),yOf(p.v)):ctx.lineTo(xOf(i),yOf(p.v)));
  ctx.stroke();
  // last-point dot
  ctx.beginPath();
  ctx.arc(xOf(points.length-1),yOf(points[points.length-1].v),2.5,0,Math.PI*2);
  ctx.fillStyle=accentColor;
  ctx.fill();
}

const SLOT_COLOR={cpu:'#f97316',mem:'#a78bfa',net:'#00d4ff'};

function renderMiniChart(container, metric){
  const color=SLOT_COLOR[metric.slot]||'#00d4ff';
  const wrap=document.createElement('div');
  wrap.style.cssText='background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:7px 10px';
  const val=formatMetricValue(metric.lastvalue, metric.units);
  wrap.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
      <span style="font-size:10px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:170px">${metric.name}</span>
      <span style="font-size:11px;font-weight:700;color:${color};margin-left:6px;flex-shrink:0">${val}</span>
    </div>
    <canvas width="260" height="44" style="width:100%;height:44px;display:block"></canvas>
  `;
  container.appendChild(wrap);
  if(metric.history.length>=2) drawSparkline(wrap.querySelector('canvas'),metric.history,color);
}

async function loadPanelGraphs(hostId){
  const el=document.getElementById('dp-graphs');
  if(!el) return;
  try{
    const r=await fetch('/api/zabbix/history?hostid='+encodeURIComponent(hostId));
    const data=await r.json();
    if(!Array.isArray(data)||!data.length){
      el.innerHTML='<div style="color:var(--muted);font-size:11px;text-align:center;padding:8px 0">No metrics found</div>';
      return;
    }
    el.innerHTML='';
    data.forEach(m=>renderMiniChart(el,m));
  }catch(_){
    el.innerHTML='<div style="color:var(--muted);font-size:11px;text-align:center;padding:8px 0">Could not load metrics</div>';
  }
}

// ── TOPOLOGY AUTO-DISCOVERY ────────────────────────────────
let _discData = null;

function openDiscoverModal(){
  _discData = null;
  document.getElementById('disc-step1').style.display='flex';
  document.getElementById('disc-step2').style.display='none';
  document.getElementById('disc-subnet-list').style.display='none';
  document.getElementById('disc-subnet-list').innerHTML='';
  document.getElementById('disc-scan-summary').textContent='';
  document.getElementById('disc-create-btn').style.display='none';
  document.getElementById('disc-scan-state').style.display='block';
  document.getElementById('disc-scan-state').textContent='Click Scan to discover hosts from Zabbix';
  document.getElementById('disc-scan-btn').disabled=false;
  document.getElementById('disc-scan-btn').innerHTML='<i data-lucide="search" style="width:12px;height:12px;vertical-align:-1px"></i> Scan Zabbix';
  document.getElementById('discover-modal').style.display='flex';
  lucide.createIcons();
}

function closeDiscoverModal(){
  document.getElementById('discover-modal').style.display='none';
}

async function doDiscoverScan(){
  const btn = document.getElementById('disc-scan-btn');
  btn.disabled = true;
  btn.innerHTML = '<i data-lucide="loader" style="width:12px;height:12px"></i> Scanning…';
  lucide.createIcons();
  document.getElementById('disc-scan-state').style.display='block';
  document.getElementById('disc-scan-state').textContent = 'Scanning Zabbix hosts…';
  document.getElementById('disc-subnet-list').style.display='none';
  document.getElementById('disc-create-btn').style.display='none';
  try {
    const r = await fetch('/api/discover/scan', {credentials:'include'});
    _discData = await r.json();
    if(_discData.error){ document.getElementById('disc-scan-state').textContent='Error: '+_discData.error; }
    else { renderDiscoverSubnets(_discData); }
  } catch(e) {
    document.getElementById('disc-scan-state').textContent = 'Scan failed: ' + e.message;
  }
  btn.disabled = false;
  btn.innerHTML = '<i data-lucide="search" style="width:12px;height:12px;vertical-align:-1px"></i> Re-Scan';
  lucide.createIcons();
}

function renderDiscoverSubnets(data){
  const list = document.getElementById('disc-subnet-list');
  const subnets = data.subnets || [];
  const singletons = data.singletons || [];

  list.innerHTML = subnets.map((s,i) => `
    <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid var(--border);border-radius:6px;margin-bottom:6px;background:var(--surface2)">
      <input type="checkbox" id="disc-chk-${i}" checked style="flex-shrink:0;accent-color:var(--cyan)">
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:11px;font-weight:600;color:#fff;font-family:'JetBrains Mono',monospace">${s.subnet}</span>
          <span style="font-size:10px;color:var(--muted)">${s.hosts.length} hosts</span>
        </div>
        <input class="edit-inp" id="disc-label-${i}" value="${guessSubnetLabel(s.subnet)}"
          style="margin-top:4px;padding:3px 8px;font-size:10px;height:24px;width:200px">
      </div>
      <div style="font-size:10px;color:var(--muted);text-align:right;flex-shrink:0">
        ${s.hosts.slice(0,3).map(h=>`<div>${h.host}</div>`).join('')}
        ${s.hosts.length>3?`<div style="color:var(--cyan)">+${s.hosts.length-3} more</div>`:''}
      </div>
    </div>
  `).join('') + (singletons.length ? `
    <div style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;background:var(--surface2)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
        <input type="checkbox" id="disc-chk-single" style="accent-color:var(--cyan)">
        <span style="font-size:11px;font-weight:600;color:#fff">Single-host subnets</span>
        <span style="font-size:10px;color:var(--muted)">${singletons.length} hosts</span>
      </div>
    </div>
  ` : '');

  document.getElementById('disc-scan-state').style.display='none';
  list.style.display='block';
  document.getElementById('disc-scan-summary').textContent =
    subnets.length + ' subnets, ' +
    subnets.reduce((a,s)=>a+s.hosts.length,0) + ' hosts found';
  document.getElementById('disc-create-btn').style.display='block';
}

function guessSubnetLabel(subnet){
  const m = subnet.match(/^(\d+)\.(\d+)\.(\d+)/);
  if(!m) return subnet;
  const [,a,b,c] = m;
  if(a==='10'&&b==='1'&&c==='0')    return 'Core Network';
  if(a==='100'&&b==='66')           return 'Application Zone';
  if(a==='100'&&b==='65')           return 'Virtualization Zone';
  if(a==='100'&&b==='64'&&c==='2')  return 'Infrastructure Zone';
  if(a==='100'&&b==='64'&&c==='0')  return 'Management Zone';
  if(a==='100'&&b==='67')           return 'Office Network';
  if(a==='100'&&b==='127')          return 'DR Zone';
  if(a==='100'&&b==='69')           return 'Remote Sites';
  if(a==='127')                     return 'Loopback (skip)';
  return subnet;
}

async function doDiscoverCreate(){
  if(!_discData) return;
  const subnets = _discData.subnets || [];
  const singletons = _discData.singletons || [];
  const selected = [];

  subnets.forEach((s,i) => {
    if(document.getElementById('disc-chk-'+i)?.checked){
      selected.push({
        subnet: s.subnet,
        label:  document.getElementById('disc-label-'+i)?.value || s.subnet,
        hosts:  s.hosts,
      });
    }
  });
  if(document.getElementById('disc-chk-single')?.checked && singletons.length){
    selected.push({subnet:'other', label:'Other Hosts', hosts: singletons});
  }
  if(!selected.length){ alert('Select at least one subnet'); return; }

  const btn = document.getElementById('disc-create-btn');
  btn.disabled = true;
  btn.textContent = 'Creating…';

  const name = document.getElementById('disc-name').value.trim() || 'Auto-Discovered Map';
  try {
    const r = await api('/api/discover/create', {
      method: 'POST',
      body: JSON.stringify({name, subnets: selected}),
    });
    if(r?.ok){
      document.getElementById('disc-step1').style.display='none';
      document.getElementById('disc-step2').style.display='block';
      document.getElementById('disc-done-msg').textContent =
        '✓ "' + name + '" created with ' + r.nodes_created + ' nodes';
      loadMaps();
      switchMap(r.layout_id, name);
    } else {
      alert('Error: ' + (r?.error||'Unknown'));
    }
  } catch(e){ alert('Create failed: '+e.message); }
  btn.disabled = false;
  btn.textContent = 'Create Map →';
}

// ═══════════════════════════════════════════════════════════
//  AI EMPLOYEES OFFICE
// ═══════════════════════════════════════════════════════════
const OFFICE_EMP = [
  {id:'aria',   name:'ARIA',   role:'NOC Analyst',              color:'#00d4ff', cmd:'aria@noc-sentinel'},
  {id:'nexus',  name:'NEXUS',  role:'Infrastructure Engineer',  color:'#a78bfa', cmd:'nexus@infra'},
  {id:'cipher', name:'CIPHER', role:'Security Analyst',         color:'#f97316', cmd:'cipher@security'},
  {id:'vega',   name:'VEGA',   role:'Site Reliability Engineer',color:'#4ade80', cmd:'vega@sre'},
];

const OFFICE_STATE = {
  taskCount:0, alarmsReviewed:0, activeEmp:new Set(), autoCollabEnabled:false,
  history: {aria:[], nexus:[], cipher:[], vega:[]},  // conversation history per employee
  _pendingMsg: {},  // user message text pending before task completes
};

const OFFICE_IDLE = {
  aria:  ['Monitoring alarm queue...','Correlating incidents...','Checking SLA metrics...','Reviewing MTTR trends...','Scanning severity thresholds...','Watching for cascading faults...'],
  nexus: ['Analyzing BGP routes...','Checking interface utilization...','Reviewing HA failover logs...','Scanning for bottlenecks...','Validating device configs...','Monitoring uplink health...'],
  cipher:['Scanning threat intel feeds...','Reviewing IPS rule efficacy...','Checking PCI compliance...','Auditing firewall logs...','Monitoring anomaly scores...','Validating ACL policies...'],
  vega:  ['Calculating error budgets...','Reviewing runbook coverage...','Checking SLO burn rates...','Mapping monitoring gaps...','Validating alert thresholds...','Analyzing failure modes...'],
};

let _officeRendered = false;
let _idleTimers = {};

function renderOfficePage() {
  if (_officeRendered) return;
  _officeRendered = true;
  const grid = document.getElementById('office-grid');
  if (!grid) return;
  grid.innerHTML = OFFICE_EMP.map(e => _buildEmpCard(e)).join('');
  lucide.createIcons();
  OFFICE_EMP.forEach(e => _startIdleRotation(e.id));
  _addFeedItem('system','Office initialized. 4 AI agents standing by.','#3d5470');
}

function _buildEmpCard(e) {
  const avatarSvgs = {
    aria:   `<svg viewBox="0 0 60 60" fill="none"><circle cx="30" cy="30" r="28" stroke="${e.color}" stroke-width="1.5" stroke-dasharray="5 3" opacity="0.6"/><circle cx="30" cy="30" r="20" stroke="${e.color}" stroke-width="0.75" opacity="0.2"/><circle cx="30" cy="22" r="9" fill="${e.color}" fill-opacity="0.12" stroke="${e.color}" stroke-width="1.5"/><path d="M13 51c0-9.4 7.6-17 17-17s17 7.6 17 17" stroke="${e.color}" stroke-width="1.5" stroke-linecap="round"/><circle cx="30" cy="22" r="4.5" fill="${e.color}" fill-opacity="0.7"/><line x1="30" y1="1" x2="30" y2="8" stroke="${e.color}" stroke-width="1.5"/><line x1="52" y1="17" x2="46" y2="20" stroke="${e.color}" stroke-width="1.5"/></svg>`,
    nexus:  `<svg viewBox="0 0 60 60" fill="none"><rect x="2" y="2" width="56" height="56" rx="8" stroke="${e.color}" stroke-width="1.5" stroke-dasharray="5 3" opacity="0.6"/><rect x="10" y="10" width="40" height="40" rx="4" stroke="${e.color}" stroke-width="0.75" opacity="0.2"/><circle cx="30" cy="22" r="9" fill="${e.color}" fill-opacity="0.12" stroke="${e.color}" stroke-width="1.5"/><path d="M13 51c0-9.4 7.6-17 17-17s17 7.6 17 17" stroke="${e.color}" stroke-width="1.5" stroke-linecap="round"/><circle cx="30" cy="22" r="4.5" fill="${e.color}" fill-opacity="0.7"/><circle cx="10" cy="10" r="3" fill="${e.color}" fill-opacity="0.6"/><circle cx="50" cy="10" r="3" fill="${e.color}" fill-opacity="0.6"/><circle cx="10" cy="50" r="3" fill="${e.color}" fill-opacity="0.6"/><circle cx="50" cy="50" r="3" fill="${e.color}" fill-opacity="0.6"/></svg>`,
    cipher: `<svg viewBox="0 0 60 60" fill="none"><polygon points="30,2 57,17 57,43 30,58 3,43 3,17" stroke="${e.color}" stroke-width="1.5" stroke-dasharray="5 3" opacity="0.6"/><polygon points="30,12 47,22 47,38 30,48 13,38 13,22" stroke="${e.color}" stroke-width="0.75" opacity="0.2"/><circle cx="30" cy="22" r="9" fill="${e.color}" fill-opacity="0.12" stroke="${e.color}" stroke-width="1.5"/><path d="M13 51c0-9.4 7.6-17 17-17s17 7.6 17 17" stroke="${e.color}" stroke-width="1.5" stroke-linecap="round"/><circle cx="30" cy="22" r="4.5" fill="${e.color}" fill-opacity="0.7"/></svg>`,
    vega:   `<svg viewBox="0 0 60 60" fill="none"><circle cx="30" cy="30" r="28" stroke="${e.color}" stroke-width="1.5" opacity="0.4"/><path d="M30 2 L58 30 L30 58 L2 30 Z" stroke="${e.color}" stroke-width="1.5" stroke-dasharray="5 3" opacity="0.6"/><circle cx="30" cy="22" r="9" fill="${e.color}" fill-opacity="0.12" stroke="${e.color}" stroke-width="1.5"/><path d="M13 51c0-9.4 7.6-17 17-17s17 7.6 17 17" stroke="${e.color}" stroke-width="1.5" stroke-linecap="round"/><circle cx="30" cy="22" r="4.5" fill="${e.color}" fill-opacity="0.7"/><line x1="30" y1="2" x2="30" y2="8" stroke="${e.color}" stroke-width="1.5"/><line x1="58" y1="30" x2="52" y2="30" stroke="${e.color}" stroke-width="1.5"/><line x1="30" y1="58" x2="30" y2="52" stroke="${e.color}" stroke-width="1.5"/><line x1="2" y1="30" x2="8" y2="30" stroke="${e.color}" stroke-width="1.5"/></svg>`,
  };
  return `<div class="emp-card" id="emp-${e.id}" data-emp="${e.id}" style="--emp-color:${e.color}">
  <div class="emp-card-glow"></div>
  <div class="emp-header">
    <div class="emp-avatar-wrap">
      <div class="emp-avatar">${avatarSvgs[e.id]||avatarSvgs.aria}</div>
      <div class="emp-status-dot idle" id="emp-${e.id}-dot"></div>
    </div>
    <div class="emp-info">
      <div class="emp-name" style="color:${e.color}">${e.name}</div>
      <div class="emp-role">${e.role}</div>
    </div>
    <div class="emp-tag idle" id="emp-${e.id}-tag">IDLE</div>
  </div>
  <div class="emp-task-bar">
    <span class="emp-idle-text" id="emp-${e.id}-idle">Initializing...</span>
  </div>
  <div class="emp-files-bar" id="emp-${e.id}-files"></div>
  <div class="emp-terminal" id="emp-${e.id}-terminal">
    <div class="term-line term-prompt"><span style="color:${e.color}">${e.cmd}:~$</span> <span class="term-cursor" style="color:${e.color}">▋</span></div>
  </div>
  <input type="file" id="emp-${e.id}-file-input" multiple
    accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.md,.csv,.png,.jpg,.jpeg,.gif,.webp"
    style="display:none" onchange="officeHandleFiles('${e.id}',this.files)">
  <div class="emp-chat-row">
    <input class="emp-chat-in" id="emp-${e.id}-chat-in"
      placeholder="Ask ${e.name} anything..."
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();officeChatEmployee('${e.id}')}">
    <button class="emp-chat-send" style="--emp-color:${e.color}" onclick="officeChatEmployee('${e.id}')" title="Send (Enter)">↵</button>
    <button class="emp-chat-clr" id="emp-${e.id}-chat-clr" onclick="clearEmpHistory('${e.id}')" title="Clear conversation history">⊘</button>
  </div>
  <div class="emp-actions">
    <button onclick="officeRunTask('${e.id}','daily')" class="emp-btn" style="--btn-color:${e.color}">Daily</button>
    <button onclick="officeRunTask('${e.id}','research')" class="emp-btn" style="--btn-color:${e.color}">Research</button>
    <button onclick="officeRunTask('${e.id}','improvement')" class="emp-btn" style="--btn-color:${e.color}">Improve</button>
    <button onclick="showEmpMemory('${e.id}')" class="emp-btn" style="--btn-color:${e.color}" title="View memory & learnings">🧠</button>
    <button onclick="document.getElementById('emp-${e.id}-file-input').click()" class="emp-btn" style="--btn-color:${e.color}" title="Attach files (images, PDF, DOCX, PPTX)">📎</button>
    <button onclick="officeStopTask('${e.id}')" class="emp-btn emp-btn-stop" id="emp-${e.id}-stop" style="display:none">■ Stop</button>
  </div>
</div>`;
}

function _startIdleRotation(empId) {
  const texts = OFFICE_IDLE[empId] || [];
  let i = 0;
  _idleTimers[empId] = setInterval(() => {
    if (OFFICE_STATE.activeEmp.has(empId)) return;
    const el = document.getElementById(`emp-${empId}-idle`);
    if (!el) return;
    el.style.opacity = '0';
    setTimeout(() => { el.textContent = texts[i % texts.length]; el.style.opacity = '1'; i++; }, 300);
  }, 3800);
}

async function officeRunTask(empId, taskType, customTask='') {
  const emp = OFFICE_EMP.find(e => e.id === empId);
  if (!emp) return;

  // Stop existing if any
  officeStopTask(empId, true);

  // Build network context
  const _zbxArr = Object.values(S.zabbixHosts||{});
  const netCtx = {
    stats:  {
      total:         _zbxArr.length,
      ok:            _zbxArr.filter(h=>!(h.problem_count>0)).length,
      with_problems: _zbxArr.filter(h=> (h.problem_count>0)).length,
      alarms:        (S.zabbixProblems||[]).length,
    },
    alarms: (S.zabbixProblems||[]).slice(0,20).map(p=>({name:p.name,severity:parseInt(p.severity)||0})),
    hosts:  _zbxArr.filter(h=>h.problem_count>0).slice(0,15).map(h=>({host:h.host||h.name,problems:h.problem_count})),
  };

  // Set working state
  OFFICE_STATE.activeEmp.add(empId);
  OFFICE_STATE.taskCount++;
  document.getElementById('ofc-active').textContent = OFFICE_STATE.activeEmp.size;
  document.getElementById('ofc-tasks').textContent  = OFFICE_STATE.taskCount;

  const tag   = document.getElementById(`emp-${empId}-tag`);
  const dot   = document.getElementById(`emp-${empId}-dot`);
  const term  = document.getElementById(`emp-${empId}-terminal`);
  const stop  = document.getElementById(`emp-${empId}-stop`);
  const idle  = document.getElementById(`emp-${empId}-idle`);
  const card  = document.getElementById(`emp-${empId}`);

  if (tag)  { tag.textContent = 'WORKING'; tag.className = 'emp-tag working'; }
  if (dot)  dot.className = 'emp-status-dot working';
  if (stop) stop.style.display = '';
  if (idle) idle.textContent = `Running ${taskType} task...`;
  if (card) card.classList.add('emp-card-active');

  const provider = document.getElementById('ofc-provider-sel')?.value || 'claude';
  const modelId  = document.getElementById('ofc-model-sel')?.value  || '';

  // Store the human-readable user message for history tracking
  const _taskMsgLabels = {
    daily:       'Please run your daily status check.',
    research:    'Please do a research deep-dive on our environment.',
    improvement: 'Please analyze and propose concrete improvements.',
  };
  OFFICE_STATE._pendingMsg[empId] = taskType === 'custom'
    ? (customTask || 'Custom task')
    : (_taskMsgLabels[taskType] || taskType);

  const taskLabels = {daily:'daily-check',research:'research-mode',improvement:'improve-scan',custom:'custom-task'};
  const ts = new Date().toLocaleTimeString('en',{hour12:false});
  term.innerHTML = `<div class="term-line"><span class="term-dim">[${ts}]</span> <span style="color:var(--emp-color)">▸ Task: ${taskType} | Provider: ${provider}</span></div>
<div class="term-line term-prompt"><span style="color:var(--emp-color)">${emp.cmd}:~$</span> <span class="term-cmd">${taskLabels[taskType]||'run'} --live-context --stream</span></div>
<div class="term-line term-dim" id="emp-${empId}-status">Sending request...</div>
<div id="emp-${empId}-output" class="term-output"></div>`;

  _addFeedItem(empId, `Started ${taskType} (${provider})`, emp.color);

  let accumulated = '';
  let xhrPos = 0;
  let gotFirstChunk = false;

  OFFICE_STATE._xhr = OFFICE_STATE._xhr || {};
  const xhr = new XMLHttpRequest();
  OFFICE_STATE._xhr[empId] = xhr;

  xhr.open('POST', '/api/office/run', true);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.withCredentials = true;

  function _processChunk(chunk) {
    if (!chunk) return;
    const lines = chunk.split('\n');
    for (const line of lines) {
      const t = line.trim();
      // Show SSE error events in terminal
      if (t === 'event: error') continue;
      if (!t.startsWith('data: ')) continue;
      const raw = t.slice(6);
      if (!raw || raw === '{}') continue;
      try {
        const ev = JSON.parse(raw);
        if (ev.error) {
          const od = document.getElementById(`emp-${empId}-output`);
          if (od) od.textContent = '[ERROR] ' + ev.error;
          return;
        }
        if (ev.t) {
          if (!gotFirstChunk) {
            gotFirstChunk = true;
            const st = document.getElementById(`emp-${empId}-status`);
            if (st) st.textContent = 'Streaming response...';
          }
          accumulated += ev.t;
          const od = document.getElementById(`emp-${empId}-output`);
          if (od) {
            od.textContent = accumulated;
            const termEl = document.getElementById(`emp-${empId}-terminal`);
            if (termEl) termEl.scrollTop = termEl.scrollHeight;
          }
        }
      } catch {}
    }
  }

  xhr.onprogress = function() {
    if (!OFFICE_STATE.activeEmp.has(empId)) { xhr.abort(); return; }
    const chunk = xhr.responseText.slice(xhrPos);
    xhrPos = xhr.responseText.length;
    _processChunk(chunk);
  };

  xhr.onload = function() {
    _processChunk(xhr.responseText.slice(xhrPos));
    if (!OFFICE_STATE.activeEmp.has(empId)) return;
    if (xhr.status !== 200) {
      const od = document.getElementById(`emp-${empId}-output`);
      if (od) od.textContent = `[HTTP ${xhr.status}] Server error:\n${xhr.responseText.slice(0,400)}`;
      _errorEmpTask(empId, emp);
    } else {
      _finishEmpTask(empId, emp, accumulated, taskType);
    }
  };

  xhr.onerror = function() {
    if (!OFFICE_STATE.activeEmp.has(empId)) return;
    const od = document.getElementById(`emp-${empId}-output`);
    if (od) od.textContent = '[NETWORK ERROR] Could not reach /api/office/run';
    _errorEmpTask(empId, emp);
  };

  xhr.ontimeout = function() {
    if (!OFFICE_STATE.activeEmp.has(empId)) return;
    const od = document.getElementById(`emp-${empId}-output`);
    if (od) od.textContent = '[TIMEOUT] No response after 120s — check AI provider key';
    _errorEmpTask(empId, emp);
  };

  xhr.timeout = 180000;
  const attachments = (OFFICE_STATE.files[empId] || []).map(f=>({name:f.name,type:f.type,data:f.data}));
  // Include last 20 messages from history (10 exchanges) to keep context without blowing token budget
  const history = (OFFICE_STATE.history[empId] || []).slice(-20);
  xhr.send(JSON.stringify({
    employee: empId, task_type: taskType, custom_task: customTask,
    network_context: netCtx, provider, model_id: modelId, attachments, history,
  }));
}

async function _finishEmpTask(empId, emp, output, taskType='custom') {
  OFFICE_STATE.activeEmp.delete(empId);
  OFFICE_STATE.alarmsReviewed += Math.max(1, Math.floor((output.length/500)));
  document.getElementById('ofc-active').textContent      = OFFICE_STATE.activeEmp.size;
  document.getElementById('ofc-alarms-rev').textContent  = OFFICE_STATE.alarmsReviewed;

  const tag  = document.getElementById(`emp-${empId}-tag`);
  const dot  = document.getElementById(`emp-${empId}-dot`);
  const stop = document.getElementById(`emp-${empId}-stop`);
  const card = document.getElementById(`emp-${empId}`);
  const idle = document.getElementById(`emp-${empId}-idle`);

  if (tag)  { tag.textContent='DONE'; tag.className='emp-tag done'; setTimeout(()=>{ if(tag){tag.textContent='IDLE';tag.className='emp-tag idle';} },4000); }
  if (dot)  { dot.className='emp-status-dot done'; setTimeout(()=>{ if(dot) dot.className='emp-status-dot idle'; },4000); }
  if (stop) stop.style.display = 'none';
  if (card) card.classList.remove('emp-card-active');
  if (idle) { idle.textContent='Task complete.'; setTimeout(()=>{ if(idle && !OFFICE_STATE.activeEmp.has(empId)) idle.textContent='Idle — waiting for next task...'; },4000); }

  // Save exchange to conversation history
  if (output && output.length > 10) {
    if (!OFFICE_STATE.history[empId]) OFFICE_STATE.history[empId] = [];
    const userMsg = OFFICE_STATE._pendingMsg[empId] || taskType;
    OFFICE_STATE.history[empId].push({role:'user', content: userMsg});
    OFFICE_STATE.history[empId].push({role:'assistant', content: output});
    // Keep only last 30 messages (15 exchanges)
    if (OFFICE_STATE.history[empId].length > 30) OFFICE_STATE.history[empId] = OFFICE_STATE.history[empId].slice(-30);
    delete OFFICE_STATE._pendingMsg[empId];
    // Update clear button tooltip
    const n = Math.floor(OFFICE_STATE.history[empId].length / 2);
    const clrBtn = document.getElementById(`emp-${empId}-chat-clr`);
    if (clrBtn) clrBtn.title = `Clear ${n} exchange${n!==1?'s':''} from memory`;
  }

  _addFeedItem(empId, `Task completed`, emp.color);

  // Auto-collab: if toggle is ON, ask AI if cross-team discussion is needed
  if (OFFICE_STATE.autoCollabEnabled && output.length > 100) {
    const provider = document.getElementById('ofc-provider-sel')?.value || 'claude';
    const modelId  = document.getElementById('ofc-model-sel')?.value  || '';
    const colleagues = OFFICE_EMP.map(e=>e.id).filter(id=>id!==empId);
    try {
      const result = await fetch('/api/office/auto-collab', {
        method: 'POST', credentials: 'include',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          employee_id: empId,
          task_type: taskType,
          response: output.substring(0, 1500),
          available_colleagues: colleagues,
          provider, model_id: modelId,
        })
      }).then(r=>r.json());

      if (result?.should_collab && result.invite?.length) {
        const topic = result.topic || `Follow-up discussion after ${emp.name}'s ${taskType} task`;
        _addFeedItem(empId, `🤝 Auto-initiating team discussion: "${topic.substring(0,60)}"`, '#a88eee');

        // Switch to Team Chat tab
        switchOfficeTab('teamchat');

        // Pre-fill the form
        const topicEl = document.getElementById('tc-topic');
        if (topicEl) topicEl.value = topic;

        // Uncheck all, then check the invitees
        document.querySelectorAll('.tc-chk').forEach(c => {
          c.checked = result.invite.includes(c.value);
        });

        // Set rounds to 3 for auto-collab
        const roundsEl = document.getElementById('tc-rounds');
        if (roundsEl) roundsEl.value = '3';

        // Brief delay then auto-start
        setTimeout(() => startTeamChat(), 800);
      }
    } catch(e) {
      console.warn('Auto-collab check failed:', e);
    }
  }
}

function _errorEmpTask(empId, emp) {
  OFFICE_STATE.activeEmp.delete(empId);
  document.getElementById('ofc-active').textContent = OFFICE_STATE.activeEmp.size;
  const tag  = document.getElementById(`emp-${empId}-tag`);
  const dot  = document.getElementById(`emp-${empId}-dot`);
  const stop = document.getElementById(`emp-${empId}-stop`);
  const card = document.getElementById(`emp-${empId}`);
  const idle = document.getElementById(`emp-${empId}-idle`);
  if (tag)  { tag.textContent='ERROR'; tag.className='emp-tag'; tag.style.cssText='color:#ff4444;border-color:rgba(255,68,68,0.4);background:rgba(255,68,68,0.08)'; setTimeout(()=>{ if(tag){tag.textContent='IDLE';tag.className='emp-tag idle';tag.style.cssText='';} },5000); }
  if (dot)  { dot.className='emp-status-dot'; dot.style.background='#ff4444'; setTimeout(()=>{ if(dot){dot.className='emp-status-dot idle';dot.style.background='';} },5000); }
  if (stop) stop.style.display = 'none';
  if (card) card.classList.remove('emp-card-active');
  if (idle) idle.textContent = 'Error — check AI provider key in Settings';
  _addFeedItem(empId, 'Task failed — check AI provider settings', '#ff4444');
}

function officeStopTask(empId, silent=false) {
  if (!OFFICE_STATE.activeEmp.has(empId) && !silent) return;
  OFFICE_STATE.activeEmp.delete(empId);
  if (OFFICE_STATE._xhr?.[empId]) { try { OFFICE_STATE._xhr[empId].abort(); } catch {} delete OFFICE_STATE._xhr[empId]; }
  const tag  = document.getElementById(`emp-${empId}-tag`);
  const dot  = document.getElementById(`emp-${empId}-dot`);
  const stop = document.getElementById(`emp-${empId}-stop`);
  const card = document.getElementById(`emp-${empId}`);
  if (tag)  { tag.textContent='IDLE'; tag.className='emp-tag idle'; }
  if (dot)  dot.className = 'emp-status-dot idle';
  if (stop) stop.style.display = 'none';
  if (card) card.classList.remove('emp-card-active');
  document.getElementById('ofc-active').textContent = OFFICE_STATE.activeEmp.size;
  if (!silent) _addFeedItem(empId, 'Task stopped by operator', '#3d5470');
}

async function officeMorningBriefing() {
  _addFeedItem('system','⚡ Morning Briefing initiated — all stations activating','#ffb300');
  const delays = [0, 700, 1400, 2100];
  OFFICE_EMP.forEach((emp, i) => setTimeout(() => officeRunTask(emp.id, 'daily'), delays[i]));
}

let _assignTarget = null;
// ── Employee inline chat ─────────────────────────────────────────────────────
function officeChatEmployee(empId) {
  const input = document.getElementById(`emp-${empId}-chat-in`);
  if (!input) return;
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  officeRunTask(empId, 'custom', msg);
}

function clearEmpHistory(empId) {
  OFFICE_STATE.history[empId] = [];
  delete OFFICE_STATE._pendingMsg[empId];
  const clrBtn = document.getElementById(`emp-${empId}-chat-clr`);
  if (clrBtn) clrBtn.title = 'Clear conversation history';
  _addFeedItem(empId, 'Conversation history cleared', '#8aa0c0');
  // Visual feedback on the button
  if (clrBtn) { clrBtn.textContent='✓'; setTimeout(()=>{ clrBtn.textContent='⊘'; },1200); }
}

function officeShowAssign(empId) {
  _assignTarget = empId;
  if (empId) document.getElementById('assign-emp-sel').value = empId;
  document.getElementById('assign-modal').style.display = 'flex';
  setTimeout(() => document.getElementById('assign-input').focus(), 50);
}
function officeSubmitAssign() {
  const task   = document.getElementById('assign-input').value.trim();
  const empSel = document.getElementById('assign-emp-sel').value;
  if (!task) return;
  const target = _assignTarget || empSel;
  // Merge modal files into target employee's file list
  if (OFFICE_STATE.afiles.length) {
    OFFICE_STATE.files[target] = OFFICE_STATE.files[target] || [];
    OFFICE_STATE.files[target].push(...OFFICE_STATE.afiles);
    _renderEmpAttachments(target);
    assignClearFiles();
  }
  document.getElementById('assign-modal').style.display = 'none';
  document.getElementById('assign-input').value = '';
  officeRunTask(target, 'custom', task);
  _assignTarget = null;
}
document.addEventListener('keydown', e => {
  if (e.key==='Escape') document.getElementById('assign-modal').style.display='none';
});

const _FEED_ICONS = {aria:'🔵',nexus:'🟣',cipher:'🟠',vega:'🟢',system:'⚙️'};
function _addFeedItem(empId, text, color) {
  const feed = document.getElementById('office-feed-list');
  if (!feed) return;
  const ts = new Date().toLocaleTimeString('en',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const div = document.createElement('div');
  div.className = 'feed-item';
  div.innerHTML = `<span class="feed-icon">${_FEED_ICONS[empId]||'⚙️'}</span><div class="feed-content"><span class="feed-text" style="color:${color||'#8aa0c0'}">${text}</span><span class="feed-time">${ts}</span></div>`;
  feed.insertBefore(div, feed.firstChild);
  while (feed.children.length > 60) feed.removeChild(feed.lastChild);
}

function updateOfficeHealthPct() {
  const _arr  = Object.values(S.zabbixHosts||{});
  const total = _arr.length;
  const ok    = _arr.filter(h=>!(h.problem_count>0)).length;
  const pct   = total>0 ? Math.round((ok/total)*100) : 100;
  const el    = document.getElementById('ofc-health-pct');
  if (!el) return;
  el.textContent = pct+'%';
  el.style.color = pct>=95?'#4ade80':pct>=80?'#ffb300':'#ff4444';
}

// ── EMPLOYEE FILE ATTACHMENTS ────────────────────────────────────────────────
OFFICE_STATE.files  = {aria:[],nexus:[],cipher:[],vega:[]};
OFFICE_STATE.afiles = []; // assign modal files

const _FILE_ICONS = {
  'image/':    '🖼️',
  'pdf':       '📄',
  'docx':'📝','doc':'📝',
  'pptx':'📊','ppt':'📊',
  'csv':'📋','txt':'📋','md':'📋',
};
function _fileIcon(name, type) {
  if (type.startsWith('image/')) return '🖼️';
  const ext = name.split('.').pop().toLowerCase();
  return _FILE_ICONS[ext] || _FILE_ICONS[type.split('/')[1]] || '📎';
}

function _readFileAsBase64(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload  = e => res(e.target.result.split(',')[1]);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

async function officeHandleFiles(empId, fileList) {
  const MAX = 5 * 1024 * 1024;
  for (const file of Array.from(fileList)) {
    if (file.size > MAX) { alert(`"${file.name}" exceeds 5 MB limit`); continue; }
    const data = await _readFileAsBase64(file);
    OFFICE_STATE.files[empId] = OFFICE_STATE.files[empId] || [];
    OFFICE_STATE.files[empId].push({name:file.name, type:file.type, size:file.size, data});
    _renderEmpAttachments(empId);
  }
  // reset input so same file can be re-added
  const inp = document.getElementById(`emp-${empId}-file-input`);
  if (inp) inp.value = '';
}

function officeRemoveAttachment(empId, idx) {
  if (OFFICE_STATE.files[empId]) OFFICE_STATE.files[empId].splice(idx, 1);
  _renderEmpAttachments(empId);
}

function _renderEmpAttachments(empId) {
  const bar   = document.getElementById(`emp-${empId}-files`);
  if (!bar) return;
  const files = OFFICE_STATE.files[empId] || [];
  bar.innerHTML = files.map((f,i) => {
    const kb = (f.size/1024).toFixed(0);
    return `<div class="emp-file-chip">
      <span>${_fileIcon(f.name,f.type)}</span>
      <span class="emp-file-chip-name" title="${f.name}">${f.name}</span>
      <span class="emp-file-chip-size">${kb}KB</span>
      <span class="emp-file-chip-rm" onclick="officeRemoveAttachment('${empId}',${i})" title="Remove">✕</span>
    </div>`;
  }).join('');
  bar.classList.toggle('has-files', files.length > 0);
}

// Assign modal files
async function assignHandleFiles(fileList) {
  const MAX = 5 * 1024 * 1024;
  for (const file of Array.from(fileList)) {
    if (file.size > MAX) { alert(`"${file.name}" exceeds 5 MB limit`); continue; }
    const data = await _readFileAsBase64(file);
    OFFICE_STATE.afiles.push({name:file.name, type:file.type, size:file.size, data});
    _renderAssignFiles();
  }
  const inp = document.getElementById('assign-file-input');
  if (inp) inp.value = '';
}
function assignRemoveFile(idx) {
  OFFICE_STATE.afiles.splice(idx, 1);
  _renderAssignFiles();
}
function assignClearFiles() { OFFICE_STATE.afiles = []; _renderAssignFiles(); }
function _renderAssignFiles() {
  const list = document.getElementById('assign-files-list');
  if (!list) return;
  list.innerHTML = (OFFICE_STATE.afiles||[]).map((f,i) => {
    const kb = (f.size/1024).toFixed(0);
    return `<div class="emp-file-chip">
      <span>${_fileIcon(f.name,f.type)}</span>
      <span class="emp-file-chip-name" title="${f.name}">${f.name}</span>
      <span class="emp-file-chip-size">${kb}KB</span>
      <span class="emp-file-chip-rm" onclick="assignRemoveFile(${i})">✕</span>
    </div>`;
  }).join('');
}

// ── OFFICE MODEL SELECTOR ────────────────────────────────────────────────────
const _MODEL_OPTS = {
  claude: ['claude-sonnet-4-6','claude-opus-4-6','claude-haiku-4-5-20251001'],
  openai: ['gpt-4o','gpt-4o-mini','o1','o1-mini'],
  gemini: ['gemini-2.0-flash','gemini-1.5-pro','gemini-1.5-flash'],
  grok:   ['grok-2-latest','grok-3','grok-3-mini'],
};
function officeUpdateModelSel() {
  const prov = document.getElementById('ofc-provider-sel')?.value || 'claude';
  const sel  = document.getElementById('ofc-model-sel');
  if (!sel) return;
  const opts = _MODEL_OPTS[prov] || _MODEL_OPTS.claude;
  sel.innerHTML = opts.map(m=>`<option value="${m}">${m}</option>`).join('');
}

// ── AI PROVIDER SETTINGS ─────────────────────────────────────────────────────
const _AIP_MODELS = {
  claude: ['claude-sonnet-4-6','claude-opus-4-6','claude-haiku-4-5-20251001'],
  openai: ['gpt-4o','gpt-4o-mini','o1'],
  gemini: ['gemini-2.0-flash','gemini-1.5-pro'],
  grok:   ['grok-2-latest','grok-3'],
};
function updateAipModelOptions() {
  const prov = document.getElementById('aip-default-provider')?.value || 'claude';
  const sel  = document.getElementById('aip-default-model');
  if (!sel) return;
  const opts = _AIP_MODELS[prov] || _AIP_MODELS.claude;
  sel.innerHTML = opts.map(m=>`<option value="${m}">${m}</option>`).join('');
}

async function loadAiKeys() {
  const r = await api('/api/import/aikeys');
  if (!r) return;
  const badge = (id, has) => {
    const el = document.getElementById(`aip-${id}-badge`);
    const card = document.getElementById(`aip-${id}`);
    if (el) { el.textContent = has ? 'SET ✓' : 'NOT SET'; el.className = 'aip-badge ' + (has?'set':'unset'); }
    if (card) card.classList.toggle('has-key', has);
  };
  badge('claude', r.claude?.has);
  badge('openai', r.openai?.has);
  badge('gemini', r.gemini?.has);
  badge('grok',   r.grok?.has);
  if (r.default_provider) {
    const dp = document.getElementById('aip-default-provider');
    if (dp) { dp.value = r.default_provider; updateAipModelOptions(); }
  }
  if (r.default_model) {
    const dm = document.getElementById('aip-default-model');
    if (dm) dm.value = r.default_model;
  }
}

async function saveAiKeys() {
  const getVal = id => document.getElementById(id)?.value?.trim() || undefined;
  const body = {};
  const ck = getVal('aip-claude-key'); if (ck) body.claude_key = ck;
  const ok = getVal('aip-openai-key'); if (ok) body.openai_key = ok;
  const gk = getVal('aip-gemini-key'); if (gk) body.gemini_key = gk;
  const xk = getVal('aip-grok-key');   if (xk) body.grok_key   = xk;
  body.default_ai_provider = getVal('aip-default-provider') || 'claude';
  body.default_ai_model    = getVal('aip-default-model')    || '';
  const res = document.getElementById('aip-result');
  if (res) res.textContent = 'Saving...';
  const r = await api('/api/import/aikeys', {method:'POST', body:JSON.stringify(body)});
  if (r?.ok) {
    if (res) { res.style.color='#00e676'; res.textContent='✓ Keys saved'; setTimeout(()=>res.textContent='',3000); }
    // Update office model selector to match default
    const dp = document.getElementById('aip-default-provider');
    const ps = document.getElementById('ofc-provider-sel');
    if (dp && ps) { ps.value = dp.value; officeUpdateModelSel(); }
    await loadAiKeys();
  } else {
    if (res) { res.style.color='#ff4444'; res.textContent='Error saving keys'; }
  }
}

// loadAiKeys() is now called directly from loadSettingsData() above
</script>
</body>
</html>
